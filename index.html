<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sleep Universe v2.0</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --accent: #0088cc; --bg: #f0f2f5; --card: #ffffff; --text: #000000;
            --sub: #8e8e93; --border: #e5e5ea; --msg-in: #ffffff; --msg-out: #effdde;
            --ghost: #9c27b0; --danger: #ff3b30; --tg-green: #34c759;
            --panel: rgba(255, 255, 255, 0.9);
            --chat-bg: #e5ddd5 url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        }
        body.dark {
            --bg: #0e1621; --card: #17212b; --text: #ffffff; --sub: #8b949e;
            --accent: #2b5278; --border: #0b1118; --msg-in: #182533; --msg-out: #2b5278;
            --panel: rgba(23, 33, 43, 0.9); --chat-bg: #0e1621;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, blinkmacsystemfont, "Segoe UI", roboto, oxygen, ubuntu, cantarell, "Open Sans", "Helvetica Neue", sans-serif; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); overflow: hidden; }

        /* --- UI COMPONENTS --- */
        .screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; transform: translateX(100%); display: flex; flex-direction: column; transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); visibility: hidden; }
        .screen.active { transform: translateX(0); visibility: visible; }
        .screen.bottom { transform: translateY(100%); }
        .screen.bottom.active { transform: translateY(0); }

        header { height: 60px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px; flex-shrink: 0; }
        .h-title { flex: 1; font-size: 20px; font-weight: 800; color: var(--accent); }
        .h-ico { font-size: 22px; color: var(--sub); cursor: pointer; margin-left: 15px; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; }
        .h-ico:active { background: rgba(0,0,0,0.05); }

        /* --- STORIES --- */
        .st-container { display: flex; overflow-x: auto; padding: 15px; gap: 12px; background: var(--card); border-bottom: 1px solid var(--border); scrollbar-width: none; }
        .st-container::-webkit-scrollbar { display: none; }
        .st-item { flex-shrink: 0; width: 66px; text-align: center; font-size: 11px; font-weight: 500; }
        .st-ring { width: 62px; height: 62px; border-radius: 20px; border: 2.5px solid var(--accent); padding: 2px; margin-bottom: 4px; position: relative; }
        .st-ring img { width: 100%; height: 100%; border-radius: 16px; object-fit: cover; }
        .st-add { position: absolute; bottom: -2px; right: -2px; width: 20px; height: 20px; background: var(--accent); color: white; border: 2px solid var(--card); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 900; }

        /* --- CHAT LIST --- */
        #chat-scroller { flex: 1; overflow-y: auto; background: var(--card); }
        .chat-row { display: flex; padding: 10px 16px; gap: 12px; border-bottom: 0.5px solid var(--border); cursor: pointer; position: relative; overflow: hidden; }
        .chat-row:active { background: var(--bg); }
        .ava { width: 54px; height: 54px; border-radius: 18px; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; flex-shrink: 0; }
        .c-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .c-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
        .c-name { font-weight: 700; font-size: 16px; color: var(--text); }
        .c-time { font-size: 12px; color: var(--sub); }
        .c-last { font-size: 14px; color: var(--sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- SEARCH --- */
        #search-box { padding: 10px 15px; background: var(--card); border-bottom: 1px solid var(--border); }
        .search-input { width: 100%; padding: 10px 15px; border-radius: 12px; border: none; background: var(--bg); color: var(--text); font-size: 15px; }

        /* --- CHAT VIEW --- */
        #msg-box { flex: 1; overflow-y: auto; padding: 15px; background: var(--chat-bg); display: flex; flex-direction: column; gap: 8px; }
        .bubble { padding: 8px 12px; border-radius: 16px; max-width: 75%; font-size: 15px; line-height: 1.4; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .bubble.in { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 4px; }
        .bubble.out { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 4px; }
        .b-time { font-size: 10px; color: var(--sub); margin-top: 4px; text-align: right; }

        /* --- INPUT --- */
        .input-bar { background: var(--card); padding: 8px 12px 30px; border-top: 1px solid var(--border); display: flex; align-items: flex-end; gap: 8px; }
        .field-wrap { flex: 1; background: var(--bg); border-radius: 20px; padding: 5px 12px; border: 1px solid var(--border); }
        .field { width: 100%; border: none; background: transparent; color: var(--text); font-size: 15px; padding: 8px 0; resize: none; max-height: 120px; }
        .btn-circle { width: 40px; height: 40px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; flex-shrink: 0; }
        .rec-active { background: var(--danger); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- CALL SYSTEM --- */
        #call-layer { background: #000; z-index: 5000; display: flex; flex-direction: column; justify-content: space-between; padding: 40px 20px; }
        #remote-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; top: 20px; right: 20px; width: 100px; height: 140px; border-radius: 12px; border: 2px solid #fff; object-fit: cover; z-index: 10; }
        .call-info { position: relative; z-index: 5; text-align: center; color: white; }
        .call-actions { position: relative; z-index: 5; display: flex; justify-content: center; gap: 30px; }
        .hangup { width: 65px; height: 65px; background: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; color: white; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        /* --- AUTH --- */
        #auth-layer { position: fixed; inset: 0; background: var(--card); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; }
        .auth-logo { width: 80px; height: 80px; background: var(--accent); border-radius: 24px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white; }

        footer { height: 70px; background: var(--card); border-top: 1px solid var(--border); display: flex; padding-bottom: 10px; }
        .tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: var(--sub); cursor: pointer; }
        .tab.active { color: var(--accent); }
        .tab b { font-size: 22px; margin-bottom: 2px; }
    </style>
</head>
<body>

    <div id="auth-layer">
        <div class="auth-logo">üí§</div>
        <h2 style="margin:0 0 10px 0;">Sleep Universe</h2>
        <p style="color:var(--sub); margin-bottom:25px;">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</p>
        <input type="text" id="reg-n" class="search-input" style="max-width:300px; margin-bottom:10px;" placeholder="–ò–º—è">
        <input type="text" id="reg-u" class="search-input" style="max-width:300px; margin-bottom:20px;" placeholder="@username">
        <button class="btn-circle" style="width:100%; max-width:300px; border-radius:12px; font-weight:bold;" onclick="app.register()">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
    </div>

    <header>
        <div class="h-title">Sleep</div>
        <div class="h-ico" onclick="app.open('scr-search')">üîç</div>
        <div class="h-ico" id="gh-trigger" onclick="app.toggleGhost()">üëª</div>
    </header>

    <div id="st-feed" class="st-container">
        <div class="st-item" onclick="document.getElementById('st-up').click()">
            <div class="st-ring" style="border-color:var(--border);"><div class="st-add">+</div><img src="https://via.placeholder.com/150" id="my-st"></div>
            –ú–æ—è –∏—Å—Ç–æ—Ä–∏—è
            <input type="file" id="st-up" hidden onchange="app.uploadStory(this)">
        </div>
        <div id="other-stories" style="display:flex; gap:12px;"></div>
    </div>

    <div id="chat-scroller"></div>

    <footer>
        <div class="tab active" onclick="app.closeAll()"><b>üí¨</b>–ß–∞—Ç—ã</div>
        <div class="tab" onclick="app.open('scr-chan')"><b>üõ∞Ô∏è</b>–ö–∞–Ω–∞–ª—ã</div>
        <div class="tab" onclick="app.open('scr-bot')"><b>ü§ñ</b>–ë–æ—Ç—ã</div>
        <div class="tab" onclick="app.open('scr-set')"><b>‚öôÔ∏è</b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    </footer>

    <div id="scr-search" class="screen">
        <header>
            <div class="h-ico" style="margin:0 15px 0 0;" onclick="app.closeAll()">‚Üê</div>
            <input type="text" id="sq" class="search-input" placeholder="–ü–æ–∏—Å–∫ @username..." oninput="app.searchUser()">
        </header>
        <div id="search-res" style="flex:1; overflow-y:auto;"></div>
    </div>

    <div id="scr-chat" class="screen">
        <header>
            <div class="h-ico" style="margin:0 10px 0 0;" onclick="app.closeChat()">‚Üê</div>
            <div class="ava" id="v-ava" style="width:38px; height:38px; font-size:16px;">?</div>
            <div style="flex:1; margin-left:12px;">
                <div id="v-name" style="font-weight:700;">Name</div>
                <div id="v-stat" style="font-size:11px; color:var(--tg-green);">–æ–Ω–ª–∞–π–Ω</div>
            </div>
            <div class="h-ico" onclick="app.startCall(true)">üìû</div>
        </header>
        <div id="msg-box"></div>
        <div class="input-bar">
            <div class="h-ico" style="margin:0 5px 4px 0;">üìé<input type="file" hidden onchange="app.sendImg(this)"></div>
            <div class="field-wrap">
                <textarea id="f-area" class="field" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="app.autoHeight(this)"></textarea>
            </div>
            <div class="h-ico" id="mic-btn" onclick="app.toggleGS()">üé§</div>
            <div class="btn-circle" onclick="app.send()">‚û§</div>
        </div>
    </div>

    <div id="scr-call" class="screen bottom">
        <div id="call-layer">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div class="call-info">
                <h2 id="call-name">–í—ã–∑–æ–≤...</h2>
                <div id="call-dur">00:00</div>
            </div>
            <div class="call-actions">
                <div class="hangup" onclick="app.endCall()">üìû</div>
            </div>
        </div>
    </div>

    <div id="scr-chan" class="screen bottom"><header><div class="h-ico" onclick="app.closeAll()">‚úï</div><b>–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</b></header><div style="padding:20px;"><input id="cn-n" class="search-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><br><br><button class="btn-circle" style="width:100%; border-radius:10px;" onclick="app.createChan()">–°–æ–∑–¥–∞—Ç—å</button></div></div>
    <div id="scr-bot" class="screen bottom"><header><div class="h-ico" onclick="app.closeAll()">‚úï</div><b>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–æ—Ç–æ–≤</b></header><div style="padding:20px;"><input id="bt-n" class="search-input" placeholder="–ò–º—è –±–æ—Ç–∞"><br><br><textarea id="bt-r" class="search-input" style="height:100px;" placeholder="–û—Ç–≤–µ—Ç –±–æ—Ç–∞"></textarea><br><br><button class="btn-circle" style="width:100%; border-radius:10px;" onclick="app.createBot()">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button></div></div>
    <div id="scr-set" class="screen"><header><div class="h-ico" onclick="app.closeAll()">‚Üê</div><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b></header><div style="padding:20px;"><button class="search-input" onclick="app.toggleDark()">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button><br><br><button class="search-input" style="color:var(--danger)" onclick="app.logout()">–í—ã–π—Ç–∏</button></div></div>

    <script>
        const config = {
            apiKey: "AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
            authDomain: "sleep-menager.firebaseapp.com",
            projectId: "sleep-menager",
            databaseURL: "https://sleep-menager-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(config);
        const db = firebase.database();

        const app = {
            me: JSON.parse(localStorage.getItem('slp_sess')),
            chat: null, gh: localStorage.getItem('slp_gh') === '1',
            pc: null, stream: null, rec: null, chunks: [],

            init() {
                if(this.me) {
                    document.getElementById('auth-layer').remove();
                    this.loadChats();
                    this.syncStories();
                    this.listenCalls();
                    this.updateOnline(true);
                    if(localStorage.getItem('slp_dark')==='1') document.body.classList.add('dark');
                    if(this.gh) document.getElementById('gh-trigger').style.color = 'var(--ghost)';
                }
            },

            async register() {
                const n = document.getElementById('reg-n').value, u = document.getElementById('reg-u').value.replace('@','').toLowerCase();
                if(!n || !u) return;
                this.me = { n, u: '@'+u };
                await db.ref('u/'+u).set(this.me);
                localStorage.setItem('slp_sess', JSON.stringify(this.me));
                location.reload();
            },

            open(id) { this.closeAll(); document.getElementById(id).classList.add('active'); },
            closeAll() { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); },

            // SEARCH
            searchUser() {
                const q = document.getElementById('sq').value.replace('@','').toLowerCase();
                if(q.length < 2) return;
                db.ref('u/'+q).once('value', s => {
                    const box = document.getElementById('search-res'); box.innerHTML = "";
                    if(s.exists()) {
                        const d = s.val();
                        box.innerHTML = `<div class="chat-row" onclick="app.addChat('${d.u}','${d.n}')">
                            <div class="ava">${d.n[0]}</div>
                            <div class="c-info"><div class="c-name">${d.n}</div><div class="c-last">${d.u}</div></div>
                        </div>`;
                    }
                });
            },

            addChat(u, n) {
                db.ref(`rec/${this.me.u.replace('@','')}/${u.replace('@','')}`).set({ u, n });
                this.openChat(u, n);
            },

            loadChats() {
                db.ref('rec/'+this.me.u.replace('@','')).on('value', s => {
                    const box = document.getElementById('chat-scroller'); box.innerHTML = "";
                    s.forEach(c => {
                        const d = c.val();
                        box.innerHTML += `<div class="chat-row" onclick="app.openChat('${d.u}','${d.n}', ${!!d.isB})">
                            <div class="ava">${d.n[0]}</div>
                            <div class="c-info">
                                <div class="c-top"><div class="c-name">${d.n}</div><div class="c-time">12:00</div></div>
                                <div class="c-last">${d.u}</div>
                            </div>
                        </div>`;
                    });
                });
            },

            openChat(u, n, isBot = false) {
                const id = [this.me.u, u].sort().join('_').replace(/@/g,'');
                this.chat = { id, u, n, isBot };
                document.getElementById('v-name').innerText = n;
                document.getElementById('v-ava').innerText = n[0];
                this.open('scr-chat');
                this.syncMsgs();
                if(!isBot) db.ref('u/'+u.replace('@','')+'/on').on('value', s => {
                    document.getElementById('v-stat').innerText = s.val() ? '–≤ —Å–µ—Ç–∏' : '–±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ';
                });
            },

            syncMsgs() {
                db.ref('m/'+this.chat.id).on('value', s => {
                    const box = document.getElementById('msg-box'); box.innerHTML = "";
                    s.forEach(m => {
                        const d = m.val(), isMe = d.f === this.me.u;
                        let html = d.t;
                        if(d.v) html = `<div onclick="new Audio('${d.v}').play()" style="cursor:pointer">üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>`;
                        if(d.i) html = `<img src="${d.i}" style="width:100%; border-radius:10px;">`;
                        box.innerHTML += `<div class="bubble ${isMe?'out':'in'}">${html}<div class="b-time">12:00</div></div>`;
                    });
                    box.scrollTop = box.scrollHeight;
                });
            },

            send() {
                const f = document.getElementById('f-area'); if(!f.value.trim()) return;
                db.ref('m/'+this.chat.id).push({ t: f.value, f: this.me.u });
                if(this.chat.isBot) this.botReply(f.value);
                f.value = ""; f.style.height = 'auto';
            },

            // VOICE MESSAGES
            async toggleGS() {
                const btn = document.getElementById('mic-btn');
                if(!this.rec) {
                    const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.rec = new MediaRecorder(s);
                    this.rec.ondataavailable = e => this.chunks.push(e.data);
                    this.rec.onstop = () => {
                        const b = new Blob(this.chunks, {type:'audio/webm'});
                        const r = new FileReader();
                        r.onload = () => db.ref('m/'+this.chat.id).push({ v: r.result, f: this.me.u });
                        r.readAsDataURL(b); this.chunks = [];
                    };
                    this.rec.start(); btn.classList.add('rec-active');
                } else {
                    this.rec.stop(); this.rec = null; btn.classList.remove('rec-active');
                }
            },

            // VIDEO CALLS (WebRTC)
            async startCall(isOff) {
                this.open('scr-call');
                this.stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-video').srcObject = this.stream;
                this.pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                this.stream.getTracks().forEach(t => this.pc.addTrack(t, this.stream));
                this.pc.ontrack = e => document.getElementById('remote-video').srcObject = e.streams[0];
                
                const ref = db.ref('calls/'+this.chat.id);
                if(isOff) {
                    const offer = await this.pc.createOffer();
                    await this.pc.setLocalDescription(offer);
                    ref.set({ offer, from: this.me.u, n: this.me.n });
                }
                
                this.pc.onicecandidate = e => e.candidate && ref.child('ice').push(e.candidate.toJSON());
                ref.on('value', async s => {
                    const d = s.val(); if(!d) return;
                    if(!isOff && d.offer && !this.pc.remoteDescription) {
                        await this.pc.setRemoteDescription(new RTCSessionDescription(d.offer));
                        const ans = await this.pc.createAnswer();
                        await this.pc.setLocalDescription(ans);
                        ref.update({ answer: ans });
                    }
                    if(isOff && d.answer && !this.pc.remoteDescription) await this.pc.setRemoteDescription(new RTCSessionDescription(d.answer));
                });
                ref.child('ice').on('child_added', s => this.pc.addIceCandidate(new RTCIceCandidate(s.val())));
            },

            listenCalls() {
                db.ref('calls').on('child_added', s => {
                    const d = s.val(); if(d.from !== this.me.u && confirm("–ó–≤–æ–Ω–æ–∫ –æ—Ç " + d.n)) {
                        this.openChat(d.from, d.n); this.startCall(false);
                    }
                });
            },

            endCall() { location.reload(); },

            // OTHER
            autoHeight(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; },
            toggleGhost() { this.gh = !this.gh; localStorage.setItem('slp_gh', this.gh?'1':'0'); location.reload(); },
            updateOnline(st) { if(this.me && !this.gh) db.ref('u/'+this.me.u.replace('@','')+'/on').set(st); },
            toggleDark() { const d = document.body.classList.toggle('dark'); localStorage.setItem('slp_dark', d?'1':'0'); },
            logout() { localStorage.clear(); location.reload(); },
            closeChat() { this.closeAll(); db.ref('m/'+this.chat.id).off(); },

            // REPLICATED SYSTEMS
            syncStories() {
                db.ref('st').on('value', s => {
                    const box = document.getElementById('other-stories'); box.innerHTML = "";
                    s.forEach(st => { if(st.val().f !== this.me.u) box.innerHTML += `<div class="st-item"><div class="st-ring"><img src="${st.val().i}"></div>${st.val().n}</div>`; });
                });
            },
            uploadStory(inp) {
                const r = new FileReader(); r.onload = e => {
                    db.ref('st').push({ i: e.target.result, n: this.me.n, f: this.me.u });
                    document.getElementById('my-st').src = e.target.result;
                }; r.readAsDataURL(inp.files[0]);
            }
        };

        app.init();
        window.onfocus = () => app.updateOnline(true);
        window.onblur = () => app.updateOnline(false);
    </script>
</body>
</html>
