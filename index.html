<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sleep Messenger | Gold Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --p: #0A84FF;
            --bg: #f2f2f7;
            --glass: rgba(255, 255, 255, 0.8);
            --border: rgba(0, 0, 0, 0.1);
            --text: #000;
            --text-m: #8e8e93;
            --blur: blur(30px) saturate(200%);
            --radius: 20px;
        }

        [data-theme="dark"] {
            --bg: #000;
            --glass: rgba(28, 28, 30, 0.8);
            --border: rgba(255, 255, 255, 0.1);
            --text: #fff;
            --text-m: #98989d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* Анимации */
        .view { position: fixed; inset: 0; display: none; flex-direction: column; background: var(--bg); z-index: 10; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .view.active { display: flex; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Шапка iOS */
        header {
            padding-top: env(safe-area-inset-top);
            background: var(--glass);
            backdrop-filter: var(--blur);
            border-bottom: 0.5px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding-inline: 20px; height: calc(65px + env(safe-area-inset-top));
            position: sticky; top: 0; z-index: 100;
        }
        .h-title { font-weight: 700; font-size: 20px; letter-spacing: -0.5px; }
        .h-btn { color: var(--p); font-size: 17px; cursor: pointer; border: none; background: none; font-weight: 500; }

        /* Скролл и Списки */
        .scroller { flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .list-item {
            display: flex; align-items: center; gap: 15px; padding: 12px 20px;
            border-bottom: 0.5px solid var(--border); cursor: pointer;
        }
        .list-item:active { background: rgba(0,0,0,0.05); }
        .avatar {
            width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(135deg, #0A84FF, #5E5CE6);
            color: #fff; display: flex; align-items: center; justify-content: center;
            font-size: 22px; font-weight: 700; flex-shrink: 0;
        }
        .item-info { flex: 1; }
        .item-name { font-weight: 600; font-size: 17px; margin-bottom: 2px; }
        .item-meta { font-size: 14px; color: var(--text-m); }

        /* Поиск */
        .search-container { padding: 10px 15px; background: var(--bg); }
        .search-input {
            width: 100%; padding: 12px 15px; border-radius: 12px;
            border: none; background: rgba(0,0,0,0.06); font-size: 16px; outline: none;
        }
        [data-theme="dark"] .search-input { background: rgba(255,255,255,0.1); color: #fff; }

        /* Чат */
        .chat-wall { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { max-width: 75%; padding: 10px 16px; border-radius: 20px; font-size: 16px; position: relative; line-height: 1.4; }
        .bubble.sent { align-self: flex-end; background: var(--p); color: #fff; border-bottom-right-radius: 4px; }
        .bubble.received { align-self: flex-start; background: var(--glass); border: 0.5px solid var(--border); border-bottom-left-radius: 4px; }
        
        .chat-bar {
            padding: 10px 15px calc(15px + env(safe-area-inset-bottom));
            background: var(--glass); backdrop-filter: var(--blur);
            display: flex; align-items: flex-end; gap: 12px; border-top: 0.5px solid var(--border);
        }
        .input-area {
            flex: 1; background: rgba(0,0,0,0.05); border-radius: 20px;
            padding: 10px 15px; max-height: 150px; overflow-y: auto; outline: none; font-size: 16px;
        }

        /* Рега норм */
        #v-auth { z-index: 10000; justify-content: center; align-items: center; padding: 40px; }
        .auth-form { width: 100%; max-width: 320px; }
        .a-input {
            width: 100%; padding: 18px; border-radius: 16px; border: 1px solid var(--border);
            margin-bottom: 12px; font-size: 17px; text-align: center; background: var(--glass);
        }
        .a-btn {
            width: 100%; padding: 18px; border-radius: 16px; border: none;
            background: var(--p); color: #fff; font-weight: 700; font-size: 17px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(10, 132, 255, 0.2);
        }
        .a-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Навигация */
        nav {
            position: fixed; bottom: 0; width: 100%; height: calc(65px + env(safe-area-inset-bottom));
            background: var(--glass); backdrop-filter: var(--blur);
            display: flex; border-top: 0.5px solid var(--border); z-index: 90;
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-m); gap: 4px; }
        .nav-item.active { color: var(--p); }
        .nav-item i { font-size: 22px; }
        .nav-item span { font-size: 10px; font-weight: 600; }

        /* Профиль */
        .profile-header { padding: 40px 20px; text-align: center; }
        .p-avatar { width: 100px; height: 100px; border-radius: 50%; background: var(--p); color: #fff; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: 800; }
    </style>
</head>
<body>

    <div id="v-auth" class="view">
        <div class="auth-form">
            <div style="font-size: 80px; margin-bottom: 20px;">☁️</div>
            <h1 style="margin-bottom: 8px;">Sleep OS 27</h1>
            <p style="color: var(--text-m); margin-bottom: 30px;">Введите данные для входа</p>
            <input type="text" id="reg-name" class="a-input" placeholder="Ваше имя">
            <input type="text" id="reg-user" class="a-input" placeholder="@username (ник)">
            <button id="reg-btn" class="a-btn" onclick="Core.register()">Создать аккаунт</button>
            <p id="auth-error" style="color: #ff3b30; font-size: 14px; margin-top: 15px; display: none;"></p>
        </div>
    </div>

    <div id="v-home" class="view">
        <header>
            <button class="h-btn" onclick="Core.toggleTheme()"><i class="fa-solid fa-moon"></i></button>
            <div class="h-title">Чаты</div>
            <button class="h-btn" onclick="Core.go('search')"><i class="fa-solid fa-user-plus"></i></button>
        </header>
        <div class="scroller" id="home-chats">
            </div>
    </div>

    <div id="v-search" class="view">
        <header>
            <button class="h-btn" onclick="Core.go('home')">Отмена</button>
            <div class="h-title">Люди</div>
            <div style="width: 50px;"></div>
        </header>
        <div class="search-container">
            <input type="text" id="search-input" class="search-input" placeholder="Поиск по нику или имени..." oninput="Core.search()">
        </div>
        <div class="scroller" id="search-results">
            </div>
    </div>

    <div id="v-chat" class="view">
        <header>
            <button class="h-btn" onclick="Core.go('home')"><i class="fa-solid fa-chevron-left"></i> Назад</button>
            <div class="h-title" id="chat-title">Чат</div>
            <div style="width: 50px;"></div>
        </header>
        <div class="chat-wall" id="chat-messages"></div>
        <div class="chat-bar">
            <div id="chat-input" class="input-area" contenteditable="true"></div>
            <button class="h-btn" onclick="Core.sendMessage()" style="font-size: 28px;"><i class="fa-solid fa-circle-arrow-up"></i></button>
        </div>
    </div>

    <div id="v-profile" class="view">
        <header><div class="h-title">Профиль</div></header>
        <div class="scroller">
            <div class="profile-header">
                <div class="p-avatar" id="p-av">?</div>
                <h2 id="p-name">Имя</h2>
                <p id="p-user" style="color: var(--text-m);">@user</p>
            </div>
            <div class="list-item" onclick="Core.logout()" style="color: #ff3b30; justify-content: center; font-weight: 600;">
                Выйти из аккаунта
            </div>
        </div>
    </div>

    <nav id="main-nav">
        <div class="nav-item active" onclick="Core.go('home', this)"><i class="fa-solid fa-message"></i><span>Чаты</span></div>
        <div class="nav-item" onclick="Core.go('profile', this)"><i class="fa-solid fa-user"></i><span>Профиль</span></div>
    </nav>

    <script>
        // === КОНФИГУРАЦИЯ FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
            authDomain: "sleep-menager.firebaseapp.com",
            databaseURL: "https://sleep-menager-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const Core = {
            me: JSON.parse(localStorage.getItem('sleep_v4_user')),
            activeChat: null,

            init() {
                if (this.me) {
                    this.go('home');
                    this.loadMyDialogs();
                    this.updateProfileInfo();
                } else {
                    document.getElementById('v-auth').classList.add('active');
                    document.getElementById('main-nav').style.display = 'none';
                }
            },

            // РЕГИСТРАЦИЯ С ПРОВЕРКОЙ
            async register() {
                const n = document.getElementById('reg-name').value.trim();
                const u = document.getElementById('reg-user').value.trim().toLowerCase().replace('@','');
                const btn = document.getElementById('reg-btn');
                const err = document.getElementById('auth-error');

                if (n.length < 2 || u.length < 3) {
                    err.innerText = "Имя от 2 симв., ник от 3 симв.";
                    err.style.display = 'block';
                    return;
                }

                btn.disabled = true;
                err.style.display = 'none';

                // Проверяем, не занят ли ник
                const snapshot = await db.ref('users/' + u).once('value');
                if (snapshot.exists()) {
                    err.innerText = "Этот @username уже занят!";
                    err.style.display = 'block';
                    btn.disabled = false;
                    return;
                }

                const userData = { name: n, user: '@' + u, joined: Date.now() };
                db.ref('users/' + u).set(userData).then(() => {
                    localStorage.setItem('sleep_v4_user', JSON.stringify(userData));
                    location.reload();
                });
            },

            go(id, el) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('v-' + id).classList.add('active');
                
                if (el) {
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    el.classList.add('active');
                }

                if (id === 'search') this.search(); // Сразу грузим всех при открытии
                
                const nav = document.getElementById('main-nav');
                nav.style.display = (id === 'home' || id === 'profile') ? 'flex' : 'none';
            },

            // ГАРАНТИРОВАННЫЙ ПОИСК
            search() {
                const q = document.getElementById('search-input').value.toLowerCase();
                const res = document.getElementById('search-results');
                
                // Мы берем всех юзеров из ветки 'users'
                db.ref('users').once('value', snap => {
                    res.innerHTML = '';
                    if (!snap.exists()) {
                        res.innerHTML = '<p style="text-align:center; padding:20px; color:gray;">Никого нет</p>';
                        return;
                    }

                    let count = 0;
                    snap.forEach(child => {
                        const u = child.val();
                        // Не показываем самих себя
                        if (u.user !== this.me.user) {
                            if (!q || u.user.includes(q) || u.name.toLowerCase().includes(q)) {
                                count++;
                                res.innerHTML += `
                                    <div class="list-item" onclick="Core.startChat('${u.user}', '${u.name}')">
                                        <div class="avatar">${u.name[0]}</div>
                                        <div class="item-info">
                                            <div class="item-name">${u.name}</div>
                                            <div class="item-meta">${u.user}</div>
                                        </div>
                                    </div>`;
                            }
                        }
                    });
                    if (count === 0) res.innerHTML = '<p style="text-align:center; padding:20px; color:gray;">Никто не найден</p>';
                });
            },

            startChat(userId, userName) {
                const chatID = [this.me.user, userId].sort().join('_').replace(/@/g,'');
                this.activeChat = { id: chatID, name: userName, user: userId };
                
                document.getElementById('chat-title').innerText = userName;
                this.go('chat');
                
                // Создаем запись в диалогах у обоих
                const myKey = this.me.user.replace('@','');
                const hisKey = userId.replace('@','');
                
                db.ref(`dialogs/${myKey}/${hisKey}`).update({ name: userName, user: userId, id: chatID, lastMsg: Date.now() });
                db.ref(`dialogs/${hisKey}/${myKey}`).update({ name: this.me.name, user: this.me.user, id: chatID, lastMsg: Date.now() });

                this.listenMessages();
            },

            loadMyDialogs() {
                const myKey = this.me.user.replace('@','');
                db.ref(`dialogs/${myKey}`).orderByChild('lastMsg').on('value', snap => {
                    const box = document.getElementById('home-chats');
                    box.innerHTML = '';
                    if (!snap.exists()) {
                        box.innerHTML = '<div style="text-align:center; padding:50px; color:gray;">Нет переписок.<br>Нажми "+" сверху справа.</div>';
                        return;
                    }
                    
                    let arr = [];
                    snap.forEach(d => arr.push(d.val()));
                    arr.reverse().forEach(d => {
                        box.innerHTML += `
                            <div class="list-item" onclick="Core.startChat('${d.user}', '${d.name}')">
                                <div class="avatar">${d.name[0]}</div>
                                <div class="item-info">
                                    <div class="item-name">${d.name}</div>
                                    <div class="item-meta">Нажмите, чтобы открыть чат</div>
                                </div>
                            </div>`;
                    });
                });
            },

            sendMessage() {
                const inp = document.getElementById('chat-input');
                const txt = inp.innerText.trim();
                if (!txt || !this.activeChat) return;

                const msg = { sender: this.me.user, text: txt, time: Date.now() };
                db.ref(`messages/${this.activeChat.id}`).push(msg);
                
                // Обновляем время диалога
                const myKey = this.me.user.replace('@','');
                const hisKey = this.activeChat.user.replace('@','');
                db.ref(`dialogs/${myKey}/${hisKey}`).update({ lastMsg: Date.now() });
                db.ref(`dialogs/${hisKey}/${myKey}`).update({ lastMsg: Date.now() });

                inp.innerText = '';
            },

            listenMessages() {
                const wall = document.getElementById('chat-messages');
                db.ref(`messages/${this.activeChat.id}`).on('value', snap => {
                    wall.innerHTML = '';
                    snap.forEach(m => {
                        const d = m.val();
                        const isMe = d.sender === this.me.user;
                        wall.innerHTML += `<div class="bubble ${isMe ? 'sent' : 'received'}">${d.text}</div>`;
                    });
                    wall.scrollTop = wall.scrollHeight;
                });
            },

            updateProfileInfo() {
                document.getElementById('p-name').innerText = this.me.name;
                document.getElementById('p-user').innerText = this.me.user;
                document.getElementById('p-av').innerText = this.me.name[0];
            },

            toggleTheme() {
                const th = document.body.getAttribute('data-theme');
                document.body.setAttribute('data-theme', th === 'dark' ? 'light' : 'dark');
            },

            logout() { localStorage.clear(); location.reload(); }
        };

        Core.init();
    </script>
</body>
</html>
