<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sleep Messenger | Ultimate Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –¢–ï–ú–´ --- */
        :root {
            --p: #007AFF;
            --p-dark: #0056b3;
            --bg: #ffffff;
            --s-bg: #f2f2f7;
            --text: #000000;
            --text-m: #8e8e93;
            --border: rgba(0,0,0,0.08);
            --glass: rgba(255,255,255,0.8);
            --bubble-in: #ffffff;
            --bubble-out: #007AFF;
            --radius: 28px;
            --safe-t: env(safe-area-inset-top);
            --safe-b: env(safe-area-inset-bottom);
        }

        [data-theme="dark"] {
            --bg: #000000;
            --s-bg: #1c1c1e;
            --text: #ffffff;
            --text-m: #8e8e93;
            --border: rgba(255,255,255,0.1);
            --glass: rgba(28,28,30,0.8);
            --bubble-in: #262629;
            --bubble-out: #007AFF;
        }

        /* --- –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò --- */
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { height: 100%; width: 100%; background: var(--bg); color: var(--text); overflow: hidden; margin: 0; position: fixed; transition: background 0.3s; }

        /* --- –õ–û–ì–ò–ö–ê –≠–ö–†–ê–ù–û–í --- */
        .view { position: fixed; inset: 0; background: var(--bg); display: none; flex-direction: column; z-index: 10; animation: viewEnter 0.4s cubic-bezier(0.1, 0.7, 0.1, 1); }
        .view.active { display: flex; }
        @keyframes viewEnter { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- –®–ê–ü–ö–ò –ò –ù–ê–í–ò–ì–ê–¶–ò–Ø --- */
        header { padding-top: var(--safe-t); background: var(--glass); backdrop-filter: blur(20px); border-bottom: 0.5px solid var(--border); height: calc(65px + var(--safe-t)); display: flex; align-items: center; justify-content: space-between; padding-inline: 20px; z-index: 1000; }
        .h-left, .h-right { display: flex; align-items: center; gap: 15px; width: 30%; }
        .h-right { justify-content: flex-end; }
        .h-center { width: 40%; text-align: center; }
        .h-title { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }

        /* --- –°–ü–ò–°–û–ö –ß–ê–¢–û–í –ò –°–¢–û–†–ò–ó --- */
        .scroller { flex: 1; overflow-y: auto; padding-bottom: 100px; scroll-behavior: smooth; }
        .stories { display: flex; gap: 12px; padding: 15px 20px; overflow-x: auto; scrollbar-width: none; }
        .stories::-webkit-scrollbar { display: none; }
        .story-item { flex-shrink: 0; width: 68px; text-align: center; }
        .story-ring { width: 68px; height: 68px; border-radius: 26px; border: 2.5px solid var(--p); padding: 3px; display: flex; align-items: center; justify-content: center; }
        .story-ring img { width: 100%; height: 100%; border-radius: 22px; object-fit: cover; }
        .story-name { font-size: 11px; margin-top: 5px; color: var(--text-m); font-weight: 500; }

        .chat-item { display: flex; padding: 14px 20px; gap: 15px; align-items: center; border-bottom: 0.5px solid var(--border); transition: 0.2s; }
        .chat-item:active { background: var(--s-bg); transform: scale(0.98); }
        .avatar { width: 58px; height: 58px; border-radius: 22px; background: linear-gradient(135deg, var(--p), #5856D6); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; position: relative; flex-shrink: 0; }
        .online-dot { position: absolute; bottom: -2px; right: -2px; width: 16px; height: 16px; background: #34c759; border: 3px solid var(--bg); border-radius: 50%; }
        .chat-info { flex: 1; min-width: 0; }
        .chat-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .chat-name { font-size: 17px; font-weight: 700; }
        .chat-msg { font-size: 15px; color: var(--text-m); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-meta { text-align: right; }
        .chat-time { font-size: 12px; color: var(--text-m); }
        .badge { background: var(--p); color: #fff; font-size: 11px; padding: 2px 7px; border-radius: 10px; font-weight: 800; margin-top: 5px; display: inline-block; }

        /* --- –û–ö–ù–û –ß–ê–¢–ê --- */
        .chat-view-content { flex: 1; background: var(--s-bg); display: flex; flex-direction: column; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 12px 16px; border-radius: 20px; font-size: 16px; line-height: 1.4; position: relative; }
        .msg.sent { align-self: flex-end; background: var(--bubble-out); color: #fff; border-bottom-right-radius: 4px; }
        .msg.received { align-self: flex-start; background: var(--bubble-in); color: var(--text); border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg-time { font-size: 10px; opacity: 0.6; margin-top: 4px; display: block; text-align: right; }

        .input-area { padding: 10px 15px calc(15px + var(--safe-b)); background: var(--glass); backdrop-filter: blur(20px); border-top: 0.5px solid var(--border); display: flex; align-items: flex-end; gap: 12px; }
        .input-box { flex: 1; background: var(--s-bg); border-radius: 22px; padding: 10px 18px; max-height: 150px; overflow-y: auto; font-size: 16px; border: none; }
        .btn-round { width: 42px; height: 42px; border-radius: 50%; background: var(--p); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; transition: 0.2s; }
        .btn-round:active { transform: scale(0.9); }

        /* --- –ó–í–û–ù–ö–ò --- */
        .call-ui { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; flex-direction: column; color: #fff; }
        #remote-v { width: 100%; height: 100%; object-fit: cover; }
        #local-v { position: absolute; top: 70px; right: 20px; width: 110px; height: 160px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.3); object-fit: cover; }
        .call-info { position: absolute; top: 100px; left: 0; width: 100%; text-align: center; }
        .call-btns { position: absolute; bottom: 60px; width: 100%; display: flex; justify-content: center; gap: 30px; }
        .call-btn { width: 75px; height: 75px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); cursor: pointer; }
        .call-btn.hang { background: #ff3b30; }

        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø --- */
        nav { position: fixed; bottom: 0; width: 100%; height: calc(70px + var(--safe-b)); background: var(--glass); backdrop-filter: blur(25px); border-top: 0.5px solid var(--border); display: flex; padding-bottom: var(--safe-b); z-index: 900; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-m); gap: 4px; transition: 0.3s; }
        .nav-item.active { color: var(--p); }
        .nav-item i { font-size: 24px; }
        .nav-item span { font-size: 11px; font-weight: 700; letter-spacing: 0.3px; }

        /* --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø --- */
        #auth-gate { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; }
        .auth-logo { width: 120px; height: 120px; background: var(--p); border-radius: 40px; display: flex; align-items: center; justify-content: center; font-size: 60px; color: #fff; box-shadow: 0 20px 40px rgba(0,122,255,0.3); margin-bottom: 30px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .auth-card { width: 100%; max-width: 340px; display: flex; flex-direction: column; gap: 15px; }
        .input-u { padding: 18px; border-radius: 18px; border: 2px solid var(--s-bg); background: var(--s-bg); font-size: 17px; transition: 0.3s; text-align: center; }
        .input-u:focus { border-color: var(--p); background: var(--bg); }
        .btn-auth { padding: 18px; border-radius: 18px; background: var(--p); color: #fff; border: none; font-size: 18px; font-weight: 800; cursor: pointer; box-shadow: 0 10px 25px rgba(0,122,255,0.2); }

        /* --- –ü–û–ò–°–ö --- */
        #search-view { z-index: 2000; }
        .search-bar { padding: 10px 20px; background: var(--s-bg); border-radius: 15px; margin: 15px 20px; display: flex; align-items: center; gap: 10px; }
        .search-bar input { border: none; background: none; flex: 1; padding: 10px; font-size: 17px; }
    </style>
</head>
<body data-theme="light">

    <div id="auth-gate">
        <div class="auth-logo">üí§</div>
        <h1 style="margin-bottom: 8px;">Sleep Messenger</h1>
        <p style="color: var(--text-m); margin-bottom: 40px;">–í–∞—à–∏ —Å–Ω—ã –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</p>
        <div class="auth-card">
            <input type="text" id="reg-name" class="input-u" placeholder="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?">
            <input type="text" id="reg-user" class="input-u" placeholder="@username">
            <button class="btn-auth" onclick="Engine.register()">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>

    <div id="v-chats" class="view active">
        <header>
            <div class="h-left"><span class="h-title" style="color:var(--p)">Sleep</span></div>
            <div class="h-center"><span class="h-title">–ß–∞—Ç—ã</span></div>
            <div class="h-right"><i class="fa-solid fa-magnifying-glass" onclick="Engine.toggleView('search')"></i></div>
        </header>
        
        <div class="stories">
            <div class="story-item">
                <div class="story-ring" style="border-color: #ccc;"><i class="fa-solid fa-plus" style="font-size: 24px; color: #ccc;"></i></div>
                <div class="story-name">–ú–æ–π —Å—Ç–∞—Ç—É—Å</div>
            </div>
            <div id="stories-list" style="display:flex; gap:12px"></div>
        </div>

        <div class="scroller" id="chat-list">
            <div style="padding: 100px 40px; text-align: center; opacity: 0.5;">
                <i class="fa-solid fa-message" style="font-size: 60px; margin-bottom: 20px;"></i>
                <h2>–¢–∏—à–∏–Ω–∞...</h2>
                <p>–ù–∞–π–¥–∏—Ç–µ –¥—Ä—É–∑–µ–π, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
            </div>
        </div>
    </div>

    <div id="v-settings" class="view">
        <header><div class="h-center"><span class="h-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div></header>
        <div class="scroller">
            <div style="padding: 40px 20px; text-align: center;">
                <div class="avatar" id="my-av-big" style="width:110px; height:110px; margin:0 auto 20px; font-size:45px; border-radius:40px">?</div>
                <h2 id="my-name-set">User</h2>
                <p id="my-user-set" style="color:var(--text-m)">@username</p>
            </div>
            
            <div style="margin: 20px; background: var(--s-bg); border-radius: 20px; overflow: hidden;">
                <div class="chat-item" onclick="Engine.toggleTheme()">
                    <i class="fa-solid fa-moon"></i>
                    <div class="chat-info"><b>–¢–µ–º–Ω–∞—è —Ç–µ–º–∞</b></div>
                    <div id="theme-status">–í—ã–∫–ª</div>
                </div>
                <div class="chat-item">
                    <i class="fa-solid fa-lock"></i>
                    <div class="chat-info"><b>–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</b></div>
                </div>
                <div class="chat-item" onclick="Engine.logout()" style="color: #ff3b30;">
                    <i class="fa-solid fa-door-open"></i>
                    <div class="chat-info"><b>–í—ã–π—Ç–∏</b></div>
                </div>
            </div>
        </div>
    </div>

    <div id="v-search" class="view">
        <header>
            <i class="fa-solid fa-chevron-left" onclick="Engine.toggleView('chats')"></i>
            <div class="h-center"><span class="h-title">–ü–æ–∏—Å–∫</span></div>
            <div class="h-right"></div>
        </header>
        <div class="search-bar">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input type="text" id="search-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ @user" oninput="Engine.search()">
        </div>
        <div class="scroller" id="search-results"></div>
    </div>

    <div id="v-chat-room" class="view" style="z-index: 3000;">
        <header>
            <div class="h-left" onclick="Engine.toggleView('chats')"><i class="fa-solid fa-chevron-left"></i></div>
            <div class="h-center">
                <b id="chat-title">Name</b><br>
                <small id="chat-status" style="color: var(--p); font-size: 11px;">online</small>
            </div>
            <div class="h-right">
                <i class="fa-solid fa-phone" onclick="Engine.call('audio')"></i>
                <i class="fa-solid fa-video" onclick="Engine.call('video')" style="margin-left:20px"></i>
            </div>
        </header>
        <div class="chat-view-content">
            <div class="messages" id="messages-wall"></div>
            <div class="input-area">
                <button class="btn-round" style="background: none; color: var(--text-m); font-size: 20px;"><i class="fa-solid fa-paperclip"></i></button>
                <div class="input-box" id="msg-input" contenteditable="true" data-placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></div>
                <button class="btn-round" onclick="Engine.sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="call-ui" class="call-ui">
        <div class="call-info">
            <h1 id="call-name">User</h1>
            <p id="call-status">–ó–≤–æ–Ω–æ–∫...</p>
        </div>
        <video id="remote-v" autoplay playsinline></video>
        <video id="local-v" autoplay playsinline muted></video>
        <div class="call-btns">
            <div class="call-btn"><i class="fa-solid fa-microphone-slash"></i></div>
            <div class="call-btn hang" onclick="Engine.hangup()"><i class="fa-solid fa-phone-slash"></i></div>
            <div class="call-btn" onclick="Engine.toggleCam()"><i class="fa-solid fa-camera-rotate"></i></div>
        </div>
    </div>

    <nav id="main-nav">
        <div class="nav-item active" onclick="Engine.nav('chats', this)">
            <i class="fa-solid fa-comment-dots"></i><span>–ß–∞—Ç—ã</span>
        </div>
        <div class="nav-item" onclick="Engine.nav('settings', this)">
            <i class="fa-solid fa-user-gear"></i><span>–û–ø—Ü–∏–∏</span>
        </div>
    </nav>

    <script>
        // FIREBASE –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ)
        const firebaseConfig = {
            apiKey: "AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
            authDomain: "sleep-menager.firebaseapp.com",
            databaseURL: "https://sleep-menager-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ENGINE - –Ø–î–†–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        const Engine = {
            me: JSON.parse(localStorage.getItem('slp_ult')),
            chat: null,
            pc: null,
            stream: null,

            init() {
                if(this.me) {
                    document.getElementById('auth-gate').style.display = 'none';
                    this.syncProfile();
                    this.loadChatList();
                    this.listenIncomingCalls();
                }
            },

            register() {
                const n = document.getElementById('reg-name').value.trim();
                let u = document.getElementById('reg-user').value.trim().toLowerCase().replace('@','');
                if(!n || !u) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å—ë!");
                
                this.me = { name: n, user: '@' + u, bio: "–ü–æ–ª—å–∑—É—é—Å—å Sleep Messenger", theme: 'light' };
                db.ref('users/' + u).set(this.me);
                localStorage.setItem('slp_ult', JSON.stringify(this.me));
                location.reload();
            },

            syncProfile() {
                document.getElementById('my-name-set').innerText = this.me.name;
                document.getElementById('my-user-set').innerText = this.me.user;
                document.getElementById('my-av-big').innerText = this.me.name[0];
                document.body.setAttribute('data-theme', this.me.theme || 'light');
            },

            nav(id, el) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('v-' + id).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            },

            toggleView(id) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('v-' + id).classList.add('active');
            },

            // --- –ü–û–ò–°–ö –ò –°–ü–ò–°–û–ö –ß–ê–¢–û–í ---
            search() {
                const q = document.getElementById('search-input').value.toLowerCase().replace('@','');
                const res = document.getElementById('search-results');
                if(q.length < 2) return res.innerHTML = '';

                db.ref('users').once('value', snap => {
                    res.innerHTML = '';
                    snap.forEach(child => {
                        const u = child.val();
                        if(u.user !== this.me.user && u.user.includes(q)) {
                            res.innerHTML += `
                                <div class="chat-item" onclick="Engine.openChat('${u.user}', '${u.name}')">
                                    <div class="avatar">${u.name[0]}</div>
                                    <div class="chat-info"><b>${u.name}</b><br><small>${u.user}</small></div>
                                    <i class="fa-solid fa-paper-plane" style="color:var(--p)"></i>
                                </div>`;
                        }
                    });
                });
            },

            openChat(user, name) {
                const chatId = [this.me.user, user].sort().join('_').replace(/@/g,'');
                this.chat = { user, name, id: chatId };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –¥–∏–∞–ª–æ–≥–æ–≤
                db.ref(`lists/${this.me.user.replace('@','')}/${user.replace('@','')}`).set(this.chat);
                db.ref(`lists/${user.replace('@','')}/${this.me.user.replace('@','')}`).set({
                    user: this.me.user, name: this.me.name, id: chatId
                });

                document.getElementById('chat-title').innerText = name;
                this.toggleView('chat-room');
                this.loadMessages();
            },

            loadChatList() {
                const container = document.getElementById('chat-list');
                const myId = this.me.user.replace('@','');
                db.ref(`lists/${myId}`).on('value', snap => {
                    if(!snap.exists()) return;
                    container.innerHTML = '';
                    snap.forEach(child => {
                        const c = child.val();
                        container.innerHTML += `
                            <div class="chat-item" onclick="Engine.openChat('${c.user}', '${c.name}')">
                                <div class="avatar">${c.name[0]}<div class="online-dot"></div></div>
                                <div class="chat-info">
                                    <div class="chat-top"><span class="chat-name">${c.name}</span><span class="chat-time">12:45</span></div>
                                    <div class="chat-msg">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</div>
                                </div>
                            </div>`;
                    });
                });
            },

            // --- –°–û–û–ë–©–ï–ù–ò–Ø ---
            sendMessage() {
                const box = document.getElementById('msg-input');
                const txt = box.innerText.trim();
                if(!txt || !this.chat) return;

                db.ref(`messages/${this.chat.id}`).push({
                    from: this.me.user,
                    text: txt,
                    time: Date.now()
                });
                box.innerText = '';
            },

            loadMessages() {
                const wall = document.getElementById('messages-wall');
                db.ref(`messages/${this.chat.id}`).on('value', snap => {
                    wall.innerHTML = '';
                    snap.forEach(child => {
                        const m = child.val();
                        const isMe = m.from === this.me.user;
                        const time = new Date(m.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                        wall.innerHTML += `
                            <div class="msg ${isMe ? 'sent' : 'received'}">
                                ${m.text}
                                <span class="msg-time">${time}</span>
                            </div>`;
                    });
                    wall.scrollTop = wall.scrollHeight;
                });
            },

            // --- WebRTC –ó–í–û–ù–ö–ò ---
            async call(type) {
                document.getElementById('call-ui').style.display = 'flex';
                document.getElementById('call-name').innerText = this.chat.name;
                
                this.stream = await navigator.mediaDevices.getUserMedia({video: type==='video', audio: true});
                document.getElementById('local-v').srcObject = this.stream;

                this.pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                this.stream.getTracks().forEach(t => this.pc.addTrack(t, this.stream));
                this.pc.ontrack = e => document.getElementById('remote-v').srcObject = e.streams[0];

                const callRef = db.ref(`calls/${this.chat.id}`);
                this.pc.onicecandidate = e => e.candidate && callRef.child('ice').push(e.candidate.toJSON());

                const offer = await this.pc.createOffer();
                await this.pc.setLocalDescription(offer);
                callRef.set({ offer, from: this.me.user, fromName: this.me.name });

                callRef.on('value', async s => {
                    const d = s.val();
                    if(d?.answer && !this.pc.currentRemoteDescription) await this.pc.setRemoteDescription(d.answer);
                    if(!d && this.pc) this.hangup(false);
                });
                callRef.child('ice').on('child_added', s => this.pc.addIceCandidate(new RTCIceCandidate(s.val())));
            },

            listenIncomingCalls() {
                const myId = this.me.user.replace('@','');
                db.ref('calls').on('child_added', async snap => {
                    const d = snap.val();
                    if(d.from !== this.me.user && snap.key.includes(myId)) {
                        if(confirm("–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç " + d.fromName)) this.accept(snap.key, d);
                        else db.ref(`calls/${snap.key}`).remove();
                    }
                });
            },

            async accept(id, d) {
                document.getElementById('call-ui').style.display = 'flex';
                this.stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                document.getElementById('local-v').srcObject = this.stream;
                this.pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                this.stream.getTracks().forEach(t => this.pc.addTrack(t, this.stream));
                this.pc.ontrack = e => document.getElementById('remote-v').srcObject = e.streams[0];

                const callRef = db.ref(`calls/${id}`);
                this.pc.onicecandidate = e => e.candidate && callRef.child('ice').push(e.candidate.toJSON());
                await this.pc.setRemoteDescription(new RTCSessionDescription(d.offer));
                const answer = await this.pc.createAnswer();
                await this.pc.setLocalDescription(answer);
                callRef.update({ answer });

                callRef.child('ice').on('child_added', s => this.pc.addIceCandidate(new RTCIceCandidate(s.val())));
                callRef.on('value', s => { if(!s.val()) this.hangup(false); });
            },

            hangup(notif = true) {
                if(this.stream) this.stream.getTracks().forEach(t => t.stop());
                if(this.pc) this.pc.close();
                document.getElementById('call-ui').style.display = 'none';
                if(notif && this.chat) db.ref(`calls/${this.chat.id}`).remove();
            },

            // --- –û–ü–¶–ò–ò ---
            toggleTheme() {
                this.me.theme = this.me.theme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', this.me.theme);
                localStorage.setItem('slp_ult', JSON.stringify(this.me));
                document.getElementById('theme-status').innerText = this.me.theme === 'light' ? '–í—ã–∫–ª' : '–í–∫–ª';
            },

            logout() { localStorage.clear(); location.reload(); }
        };

        // –ó–∞–ø—É—Å–∫
        Engine.init();
    </script>
</body>
</html>
