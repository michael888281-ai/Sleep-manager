<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sleep OS 27 | God Mode</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --p: #0A84FF; --bg: #000; --glass: rgba(28, 28, 30, 0.7);
            --border: rgba(255, 255, 255, 0.1); --text: #fff; --text-m: #8e8e93;
            --blur: blur(50px) saturate(210%);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; user-select: none; }

        /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–ª–æ–∏ */
        .view { position: fixed; inset: 0; display: none; flex-direction: column; background: var(--bg); z-index: 10; }
        .view.active { display: flex; animation: viewIn 0.3s cubic-bezier(0.1, 0.8, 0.2, 1); }
        @keyframes viewIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Header iOS 27 */
        header {
            padding-top: env(safe-area-inset-top);
            background: var(--glass); backdrop-filter: var(--blur);
            display: flex; align-items: center; justify-content: space-between;
            padding-inline: 20px; height: calc(75px + env(safe-area-inset-top));
            border-bottom: 0.5px solid var(--border); z-index: 100;
        }
        .h-title { font-weight: 800; font-size: 24px; letter-spacing: -1px; }
        .h-sub { font-size: 12px; color: var(--p); font-weight: 500; }

        /* –°—Ç–æ—Ä–∏–∑ */
        .stories-bar { display: flex; gap: 15px; padding: 15px 20px; overflow-x: auto; border-bottom: 0.5px solid var(--border); scrollbar-width: none; }
        .stories-bar::-webkit-scrollbar { display: none; }
        .story-node { flex-shrink: 0; text-align: center; width: 65px; }
        .story-ring { width: 65px; height: 65px; border-radius: 50%; padding: 3px; border: 2px solid var(--p); margin-bottom: 5px; }
        .story-av { width: 100%; height: 100%; border-radius: 50%; background: #1c1c1e; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* –°–ø–∏—Å–∫–∏ */
        .scroller { flex: 1; overflow-y: auto; padding-bottom: 120px; }
        .item { display: flex; align-items: center; gap: 15px; padding: 16px 20px; border-bottom: 0.5px solid var(--border); transition: 0.2s; }
        .item:active { background: #1c1c1e; }
        .av { width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #222, #000); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; position: relative; }
        .online-mark { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: #34C759; border-radius: 50%; border: 2px solid #000; }

        /* Chat */
        .wall { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background-attachment: fixed; }
        .b-wrap { display: flex; flex-direction: column; max-width: 80%; }
        .b-wrap.s { align-self: flex-end; }
        .b-wrap.r { align-self: flex-start; }
        
        .bubble { padding: 12px 16px; border-radius: 20px; font-size: 16px; line-height: 1.4; position: relative; transition: 0.2s; }
        .s .bubble { background: var(--p); color: #fff; border-bottom-right-radius: 4px; }
        .r .bubble { background: #262629; border-bottom-left-radius: 4px; }
        .b-meta { font-size: 10px; margin-top: 4px; color: var(--text-m); display: flex; align-items: center; gap: 4px; justify-content: flex-end; }
        
        .bubble img { width: 100%; border-radius: 12px; margin-bottom: 5px; display: block; }
        .deleted { font-style: italic; opacity: 0.6; }

        /* Controls */
        .bar { padding: 12px 16px calc(20px + env(safe-area-inset-bottom)); background: var(--glass); backdrop-filter: var(--blur); display: flex; align-items: flex-end; gap: 12px; border-top: 0.5px solid var(--border); }
        .in-box { flex: 1; background: #1c1c1e; border-radius: 22px; padding: 12px 18px; max-height: 150px; overflow-y: auto; outline: none; font-size: 16px; }
        .btn-act { font-size: 26px; color: var(--p); background: none; border: none; cursor: pointer; transition: 0.2s; }
        .btn-act:active { transform: scale(0.9); }

        /* UI Overlays */
        #call-ui { z-index: 5000; background: radial-gradient(circle at top, #1c1c1e, #000); align-items: center; justify-content: space-around; padding: 100px 20px; }
        .call-info { text-align: center; }
        .call-av-big { width: 140px; height: 140px; border-radius: 50%; background: var(--p); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 50px; box-shadow: 0 0 50px rgba(10,132,255,0.3); }

        /* Context Menu (Edit/Delete) */
        #ctx-menu { position: fixed; background: var(--glass); backdrop-filter: var(--blur); border: 1px solid var(--border); border-radius: 15px; padding: 8px; z-index: 2000; display: none; min-width: 150px; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .ctx-item { padding: 12px 15px; border-radius: 10px; display: flex; align-items: center; gap: 10px; font-weight: 500; }
        .ctx-item:active { background: rgba(255,255,255,0.1); }

        /* Nav */
        nav { position: fixed; bottom: 0; width: 100%; height: calc(75px + env(safe-area-inset-bottom)); background: var(--glass); backdrop-filter: var(--blur); display: flex; border-top: 0.5px solid var(--border); z-index: 90; }
        .tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-m); gap: 4px; }
        .tab.active { color: var(--p); }
        .tab i { font-size: 22px; } .tab span { font-size: 10px; font-weight: 600; }

        [contenteditable]:empty:before { content: attr(data-placeholder); color: #555; }
    </style>
</head>
<body>

    <div id="v-auth" class="view active">
        <div style="margin: auto; width: 100%; max-width: 300px; text-align: center;">
            <div style="font-size: 80px; margin-bottom: 20px; filter: drop-shadow(0 0 20px var(--p));">üí†</div>
            <h1 style="font-size: 32px; letter-spacing: -1.5px;">Sleep 27</h1>
            <p style="color:var(--text-m); margin-bottom: 40px;">Elite Messaging Protocol</p>
            <input type="text" id="reg-n" style="width:100%; padding:20px; border-radius:18px; border:none; background:#1c1c1e; color:#fff; margin-bottom:12px;" placeholder="–ò–º—è –§–∞–º–∏–ª–∏—è">
            <input type="text" id="reg-u" style="width:100%; padding:20px; border-radius:18px; border:none; background:#1c1c1e; color:#fff; margin-bottom:30px;" placeholder="@username">
            <button onclick="App.auth()" style="width:100%; padding:20px; border-radius:18px; background:var(--p); color:#fff; border:none; font-weight:800; font-size:18px; box-shadow: 0 10px 30px rgba(10,132,255,0.4);">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        </div>
    </div>

    <div id="v-home" class="view">
        <header>
            <div class="h-title">–ß–∞—Ç—ã</div>
            <div onclick="App.go('search')" style="color:var(--p); font-size:24px;"><i class="fa-solid fa-circle-plus"></i></div>
        </header>
        <div class="stories-bar" id="stories-list">
            <div class="story-node" onclick="Media.postStory()">
                <div class="story-ring" style="border-color: #333;">
                    <div class="story-av"><i class="fa-solid fa-plus"></i></div>
                </div>
                <div style="font-size:11px;">–ú–æ–π —Å—Ç–∞—Ç—É—Å</div>
            </div>
        </div>
        <div class="scroller" id="chats-list"></div>
    </div>

    <div id="v-search" class="view">
        <header>
            <button onclick="App.go('home')" style="background:none; border:none; color:var(--p); font-size:17px;">–û—Ç–º–µ–Ω–∞</button>
            <div class="h-title">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫</div>
            <div style="width:50px;"></div>
        </header>
        <div style="padding:15px 20px;">
            <input type="text" id="search-q" oninput="App.search()" style="width:100%; padding:14px; border-radius:14px; border:none; background:#1c1c1e; color:#fff;" placeholder="–ü–æ–∏—Å–∫ –ø–æ @username –∏–ª–∏ –∏–º–µ–Ω–∏...">
        </div>
        <div class="scroller" id="search-res"></div>
    </div>

    <div id="v-chat" class="view">
        <header>
            <button onclick="App.go('home')" style="background:none; border:none; color:var(--p); font-size:22px;"><i class="fa-solid fa-chevron-left"></i></button>
            <div style="text-align: center;">
                <div class="h-title" id="chat-title" style="font-size:18px;">–ò–º—è</div>
                <div class="h-sub" id="chat-status">–≤ —Å–µ—Ç–∏</div>
            </div>
            <div onclick="Media.call()" style="color:var(--p); font-size:22px;"><i class="fa-solid fa-video"></i></div>
        </header>
        <div class="wall" id="chat-wall"></div>
        <div class="bar">
            <label for="f-up" class="btn-act"><i class="fa-solid fa-grid-2-plus"></i></label>
            <input type="file" id="f-up" hidden onchange="Media.file(this)">
            <div id="chat-in" class="in-box" contenteditable="true" data-placeholder="C–æ–æ–±—â–µ–Ω–∏–µ..." oninput="App.typing()"></div>
            <button id="rec-voice" class="btn-act" onmousedown="Media.recStart()" onmouseup="Media.recStop()"><i class="fa-solid fa-microphone"></i></button>
            <button id="send-msg" class="btn-act" onclick="App.send()" style="display:none;"><i class="fa-solid fa-circle-arrow-up"></i></button>
        </div>
    </div>

    <div id="call-ui" class="view">
        <div class="call-info">
            <div class="call-av-big" id="call-av">?</div>
            <h1 id="call-name">–ö–æ–Ω—Ç–∞–∫—Ç</h1>
            <p id="call-state" style="color:var(--p); font-weight:bold; margin-top:10px;">–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤...</p>
        </div>
        <div style="display:flex; gap:40px;">
            <button onclick="Media.endCall()" style="width:75px; height:75px; border-radius:50%; background:#FF3B30; border:none; color:#fff; font-size:28px;"><i class="fa-solid fa-phone-slash"></i></button>
            <button id="call-ans" onclick="Media.ansCall()" style="width:75px; height:75px; border-radius:50%; background:#34C759; border:none; color:#fff; font-size:28px;"><i class="fa-solid fa-phone"></i></button>
        </div>
    </div>

    <div id="ctx-menu">
        <div class="ctx-item" onclick="App.msgEdit()"><i class="fa-solid fa-pen"></i> –ò–∑–º–µ–Ω–∏—Ç—å</div>
        <div class="ctx-item" style="color:#FF3B30;" onclick="App.msgDel()"><i class="fa-solid fa-trash"></i> –£–¥–∞–ª–∏—Ç—å</div>
    </div>

    <nav id="navbar" style="display:none;">
        <div class="tab active" onclick="App.go('home')"><i class="fa-solid fa-comments"></i><span>–ß–∞—Ç—ã</span></div>
        <div class="tab" onclick="App.go('profile')"><i class="fa-solid fa-circle-user"></i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
    </nav>

    <script>
        // FIREBASE (–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –±–∞–∑—É)
        const fbConfig = {
            apiKey: "AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
            authDomain: "sleep-menager.firebaseapp.com",
            databaseURL: "https://sleep-menager-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(fbConfig);
        const db = firebase.database();

        const App = {
            me: JSON.parse(localStorage.getItem('sleep_god_v1')),
            active: null,
            ctxMsg: null,
            typingTimer: null,

            init() {
                if(this.me) {
                    this.go('home');
                    this.listenChats();
                    this.listenStories();
                    this.updateStatus(true);
                    Media.listenCalls();
                }
            },

            auth() {
                const n = document.getElementById('reg-n').value;
                const u = document.getElementById('reg-u').value.toLowerCase().replace('@','');
                if(!n || !u) return;
                this.me = { name: n, user: '@'+u, bio: 'Sleep User' };
                db.ref('users/'+u).set(this.me).then(() => {
                    localStorage.setItem('sleep_god_v1', JSON.stringify(this.me));
                    location.reload();
                });
            },

            go(id) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('v-'+id).classList.add('active');
                document.getElementById('navbar').style.display = (id=='home'||id=='profile') ? 'flex' : 'none';
                if(id=='search') this.search();
            },

            // –£–õ–£–ß–®–ï–ù–ù–´–ô –ü–û–ò–°–ö
            search() {
                const q = document.getElementById('search-q').value.toLowerCase().replace('@','');
                const box = document.getElementById('search-res');
                db.ref('users').once('value', snap => {
                    box.innerHTML = '';
                    snap.forEach(u => {
                        const v = u.val();
                        if(v.user !== this.me.user && (!q || v.user.includes(q) || v.name.toLowerCase().includes(q))) {
                            box.innerHTML += `<div class="item" onclick="App.openChat('${v.user}', '${v.name}')">
                                <div class="av">${v.name[0]}</div>
                                <div><div style="font-weight:bold;">${v.name}</div><div style="color:gray; font-size:13px;">${v.user}</div></div>
                            </div>`;
                        }
                    });
                });
            },

            openChat(user, name) {
                const id = [this.me.user, user].sort().join('_').replace(/@/g,'');
                this.active = { id, user, name };
                document.getElementById('chat-title').innerText = name;
                this.go('chat');
                this.listenMessages();
                this.listenPresence(user);
            },

            // –ü–ï–ß–ê–¢–ê–ï–¢...
            typing() {
                const inp = document.getElementById('chat-in');
                const hasText = inp.innerText.length > 0;
                document.getElementById('send-msg').style.display = hasText ? 'block' : 'none';
                document.getElementById('rec-voice').style.display = hasText ? 'none' : 'block';

                db.ref(`typing/${this.active.id}/${this.me.user.replace('@','')}`).set(hasText);
                clearTimeout(this.typingTimer);
                this.typingTimer = setTimeout(() => {
                    db.ref(`typing/${this.active.id}/${this.me.user.replace('@','')}`).set(false);
                }, 2000);
            },

            listenPresence(otherUser) {
                const key = otherUser.replace('@','');
                db.ref(`users/${key}/online`).on('value', snap => {
                    document.getElementById('chat-status').innerText = snap.val() ? '–≤ —Å–µ—Ç–∏' : '–±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ';
                    document.getElementById('chat-status').style.color = snap.val() ? 'var(--p)' : 'gray';
                });
                db.ref(`typing/${this.active.id}/${key}`).on('value', snap => {
                    if(snap.val()) document.getElementById('chat-status').innerText = '–ø–µ—á–∞—Ç–∞–µ—Ç...';
                });
            },

            send(media = null) {
                const inp = document.getElementById('chat-in');
                const txt = inp.innerText.trim();
                if(!txt && !media) return;

                const msgRef = db.ref(`messages/${this.active.id}`).push();
                const msgData = {
                    id: msgRef.key,
                    from: this.me.user,
                    text: txt,
                    media: media,
                    time: Date.now(),
                    read: false
                };
                msgRef.set(msgData);

                // Update Dialogs
                const myKey = this.me.user.replace('@','');
                const hisKey = this.active.user.replace('@','');
                const meta = { name: this.active.name, user: this.active.user, last: txt || '–í–ª–æ–∂–µ–Ω–∏–µ', time: Date.now() };
                db.ref(`dialogs/${myKey}/${hisKey}`).update(meta);
                db.ref(`dialogs/${hisKey}/${myKey}`).update({ name: this.me.name, user: this.me.user, last: txt || '–í–ª–æ–∂–µ–Ω–∏–µ', time: Date.now() });

                inp.innerText = '';
                this.typing();
            },

            listenMessages() {
                const wall = document.getElementById('chat-wall');
                db.ref(`messages/${this.active.id}`).on('value', snap => {
                    wall.innerHTML = '';
                    snap.forEach(m => {
                        const d = m.val();
                        const isMe = d.from === this.me.user;
                        let content = d.deleted ? '<span class="deleted">–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ</span>' : d.text;
                        if(d.media && !d.deleted) {
                            if(d.media.type == 'img') content = `<img src="${d.media.data}">` + content;
                            if(d.media.type == 'voice') content = `<audio controls src="${d.media.data}" style="width:180px;"></audio>`;
                        }
                        
                        const ticks = d.read ? '<i class="fa-solid fa-check-double" style="color:var(--p);"></i>' : '<i class="fa-solid fa-check"></i>';
                        
                        wall.innerHTML += `
                            <div class="b-wrap ${isMe?'s':'r'}" oncontextmenu="App.showCtx(event, '${d.id}', ${isMe})">
                                <div class="bubble">${content}</div>
                                <div class="b-meta">${new Date(d.time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} ${isMe?ticks:''}</div>
                            </div>`;
                        
                        if(!isMe && !d.read) db.ref(`messages/${this.active.id}/${d.id}`).update({read:true});
                    });
                    wall.scrollTop = wall.scrollHeight;
                });
            },

            showCtx(e, id, isMe) {
                e.preventDefault();
                if(!isMe) return;
                this.ctxMsg = id;
                const menu = document.getElementById('ctx-menu');
                menu.style.display = 'block';
                menu.style.top = e.pageY + 'px';
                menu.style.left = (e.pageX - 100) + 'px';
                window.onclick = () => menu.style.display = 'none';
            },

            msgDel() {
                db.ref(`messages/${this.active.id}/${this.ctxMsg}`).update({deleted: true, text: '', media: null});
            },

            msgEdit() {
                const newText = prompt("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å:");
                if(newText) db.ref(`messages/${this.active.id}/${this.ctxMsg}`).update({text: newText + ' (—Ä–µ–¥.)'});
            },

            listenChats() {
                const box = document.getElementById('chats-list');
                db.ref(`dialogs/${this.me.user.replace('@','')}`).orderByChild('time').on('value', snap => {
                    box.innerHTML = '';
                    let arr = [];
                    snap.forEach(d => arr.push(d.val()));
                    arr.reverse().forEach(v => {
                        box.innerHTML += `<div class="item" onclick="App.openChat('${v.user}', '${v.name}')">
                            <div class="av">${v.name[0]}<div class="online-mark"></div></div>
                            <div style="flex:1;"><div style="font-weight:bold;">${v.name}</div><div style="color:gray; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:200px;">${v.last}</div></div>
                        </div>`;
                    });
                });
            },

            listenStories() {
                const box = document.getElementById('stories-list');
                db.ref('stories').on('value', snap => {
                    // –û—á–∏—â–∞–µ–º –≤—Å—ë –∫—Ä–æ–º–µ –∫–Ω–æ–ø–∫–∏ "–ü–ª—é—Å"
                    const plus = box.firstElementChild;
                    box.innerHTML = '';
                    box.appendChild(plus);
                    snap.forEach(s => {
                        const v = s.val();
                        box.innerHTML += `<div class="story-node" onclick="alert('–ü—Ä–æ—Å–º–æ—Ç—Ä –∏—Å—Ç–æ—Ä–∏–∏...')">
                            <div class="story-ring"><div class="story-av" style="background:url(${v.data}); background-size:cover;"></div></div>
                            <div style="font-size:11px;">${v.name}</div>
                        </div>`;
                    });
                });
            },

            updateStatus(s) {
                db.ref(`users/${this.me.user.replace('@','')}/online`).set(s);
                db.ref(`users/${this.me.user.replace('@','')}/online`).onDisconnect().set(false);
            }
        };

        const Media = {
            rec: null,
            chunks: [],

            file(el) {
                const f = el.files[0];
                const reader = new FileReader();
                reader.onload = e => App.send({type: 'img', data: e.target.result});
                reader.readAsDataURL(f);
            },

            recStart() {
                navigator.mediaDevices.getUserMedia({audio:true}).then(s => {
                    this.rec = new MediaRecorder(s);
                    this.chunks = [];
                    this.rec.ondataavailable = e => this.chunks.push(e.data);
                    this.rec.start();
                    document.getElementById('rec-voice').style.color = 'red';
                });
            },

            recStop() {
                if(!this.rec) return;
                this.rec.onstop = () => {
                    const blob = new Blob(this.chunks, {type:'audio/ogg'});
                    const r = new FileReader();
                    r.onload = e => App.send({type:'voice', data: e.target.result});
                    r.readAsDataURL(blob);
                };
                this.rec.stop();
                document.getElementById('rec-voice').style.color = 'var(--p)';
            },

            postStory() {
                const input = document.createElement('input');
                input.type = 'file';
                input.onchange = (e) => {
                    const r = new FileReader();
                    r.onload = ev => db.ref('stories').push({name: App.me.name, data: ev.target.result, time: Date.now()});
                    r.readAsAsDataURL(e.target.files[0]);
                };
                input.click();
            },

            call() {
                const hisKey = App.active.user.replace('@','');
                db.ref(`calls/${hisKey}`).set({from: App.me.user, name: App.me.name, type: 'video'});
                document.getElementById('call-ui').classList.add('active');
                document.getElementById('call-name').innerText = App.active.name;
                document.getElementById('call-ans').style.display = 'none';
                document.getElementById('call-state').innerText = '–í—ã–∑–æ–≤...';
            },

            listenCalls() {
                const myKey = App.me.user.replace('@','');
                db.ref(`calls/${myKey}`).on('value', snap => {
                    if(snap.exists()) {
                        const v = snap.val();
                        document.getElementById('call-ui').classList.add('active');
                        document.getElementById('call-name').innerText = v.name;
                        document.getElementById('call-av').innerText = v.name[0];
                        document.getElementById('call-ans').style.display = 'block';
                    }
                });
            },

            ansCall() {
                document.getElementById('call-state').innerText = '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...';
            },

            endCall() {
                db.ref(`calls/${App.me.user.replace('@','')}`).remove();
                if(App.active) db.ref(`calls/${App.active.user.replace('@','')}`).remove();
                document.getElementById('call-ui').classList.remove('active');
            }
        };

        App.init();
    </script>
</body>
    </html>
