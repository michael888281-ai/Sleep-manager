<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sleep Manager Ultra</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --blue: #0088cc; --dark-blue: #0077b5; --bg: #e7ebf0;
            --white: #ffffff; --text: #222; --gray: #8e8e93; 
            --out: #effdde; --premium: linear-gradient(45deg, #0088cc, #9c27b0);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--text); overflow: hidden; }

        /* AUTH (–ë–ï–ó –ü–û–ß–¢–´) */
        #auth-screen { position: fixed; inset: 0; background: var(--blue); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: #fff; width: 100%; max-width: 350px; padding: 30px; border-radius: 25px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .auth-card input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 15px; margin-bottom: 15px; font-size: 16px; outline: none; }
        .auth-card input:focus { border-color: var(--blue); }

        /* HEADER */
        header { background: var(--blue); color: #fff; padding: 12px 16px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-box { flex: 1; background: rgba(255,255,255,0.2); border-radius: 12px; padding: 8px 12px; display: flex; align-items: center; }
        .search-box input { background: none; border: none; color: #fff; width: 100%; outline: none; }
        .search-box input::placeholder { color: rgba(255,255,255,0.7); }

        /* CHAT LIST */
        .main-container { height: calc(100vh - 60px); overflow-y: auto; background: #fff; border-radius: 25px 25px 0 0; margin-top: 10px; }
        .chat-item { display: flex; padding: 15px; gap: 15px; align-items: center; border-bottom: 1px solid #f0f0f0; cursor: pointer; position: relative; }
        .ava-wrap { position: relative; width: 55px; height: 55px; }
        .ava { width: 100%; height: 100%; border-radius: 50%; background: var(--blue); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 22px; }
        .online-dot { position: absolute; bottom: 2px; right: 2px; width: 14px; height: 14px; background: #4caf50; border: 2px solid #fff; border-radius: 50%; display: none; }
        .online-dot.active { display: block; }
        .chat-info { flex: 1; }
        .chat-info b { font-size: 17px; }
        .chat-info p { margin: 3px 0 0; font-size: 14px; color: var(--gray); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* CHAT WINDOW */
        #chat-win { position: fixed; inset: 0; background: var(--bg); z-index: 5000; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        #chat-win.active { transform: translateX(0); }
        .win-header { background: #fff; padding: 10px 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #ddd; }
        #msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        /* BUBBLES */
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 80%; font-size: 15px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.out { align-self: flex-end; background: var(--out); border-bottom-right-radius: 4px; }
        .msg.in { align-self: flex-start; background: #fff; border-bottom-left-radius: 4px; }
        .circle-vid { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 3px solid var(--blue); }

        /* INPUT PANEL */
        .input-panel { background: #fff; padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; }
        .input-panel input { flex: 1; padding: 12px 18px; border: none; background: #f1f1f2; border-radius: 25px; outline: none; font-size: 16px; }
        .btn-icon { font-size: 26px; color: var(--blue); cursor: pointer; transition: 0.2s; }
        .btn-icon:active { transform: scale(0.8); }

        /* BUTTONS & NAV */
        .fab { position: fixed; bottom: 80px; right: 20px; width: 60px; height: 60px; background: var(--blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 30px; box-shadow: 0 5px 15px rgba(0,136,204,0.4); z-index: 100; }
        nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; justify-content: space-around; padding: 10px; border-top: 1px solid #eee; }
        .nav-item { text-align: center; color: var(--gray); font-size: 12px; }
        .nav-item.active { color: var(--blue); font-weight: bold; }

        @keyframes recording { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .rec { color: #f44336; animation: recording 1s infinite; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h1 style="color:var(--blue); margin-top:0;">Sleep Manager</h1>
            <p>–ü—Ä–∏–¥—É–º–∞–π –Ω–∏–∫ –∏ @—é–∑–µ—Ä –¥–ª—è –≤—Ö–æ–¥–∞</p>
            <input type="text" id="reg-name" placeholder="–ò–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ë–∞–±—É–ª—è)">
            <input type="text" id="reg-user" placeholder="@username">
            <button onclick="auth()" style="width:100%; padding:15px; background:var(--blue); color:#fff; border:none; border-radius:15px; font-weight:bold; font-size:16px;">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <header>
        <div style="font-size:24px;">‚ò∞</div>
        <div class="search-box">
            <span>üîç</span>
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π –ø–æ @—é–∑–µ—Ä—É..." oninput="search()">
        </div>
    </header>

    <div class="main-container" id="chat-list">
        <div class="chat-item" onclick="openChat('global', '–û–±—â–∏–π —á–∞—Ç')">
            <div class="ava-wrap"><div class="ava">üåç</div></div>
            <div class="chat-info"><b>–û–±—â–∏–π —á–∞—Ç</b><p>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–¥–µ—Å—å</p></div>
        </div>
        <div id="recent-chats"></div>
    </div>

    <div class="fab" onclick="showCreateMenu()">+</div>

    <nav>
        <div class="nav-item active">üí¨<br>–ß–∞—Ç—ã</div>
        <div class="nav-item" onclick="alert('–°–∫–æ—Ä–æ!')">üë•<br>–ö–∞–Ω–∞–ª—ã</div>
        <div class="nav-item" onclick="location.reload()">üë§<br>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </nav>

    <div id="chat-win">
        <div class="win-header">
            <div class="btn-icon" onclick="closeChat()">‚Üê</div>
            <div class="ava-wrap" style="width:40px; height:40px;"><div class="ava" id="win-ava" style="font-size:16px;">?</div><div class="online-dot" id="win-online"></div></div>
            <div style="flex:1"><b id="win-name">–ß–∞—Ç</b><br><small id="win-status" style="color:var(--gray); font-size:12px;">–æ—Ñ—Ñ–ª–∞–π–Ω</small></div>
            <div class="btn-icon">üìû</div>
        </div>
        <div id="msgs"></div>
        <div class="input-panel">
            <div class="btn-icon" onclick="sendImg()">üñºÔ∏è</div>
            <input type="text" id="m-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <div class="btn-icon" id="mic-btn" onmousedown="startRec('audio')" onmouseup="stopRec()" ontouchstart="startRec('audio')" ontouchend="stopRec()">üéôÔ∏è</div>
            <div class="btn-icon" id="cam-btn" onclick="startRec('video')">‚≠ï</div>
            <div class="btn-icon" onclick="sendMsg()">‚û§</div>
        </div>
    </div>

    <script>
        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø (–¢–í–û–ò –î–ê–ù–ù–´–ï FIREBASE)
        const config = {
            apiKey: "AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
            authDomain: "sleep-menager.firebaseapp.com",
            projectId: "sleep-menager",
            storageBucket: "sleep-menager.firebasestorage.app",
            messagingSenderId: "3927631074",
            appId: "1:3927631074:web:a3a604c7147e31a900eabb",
            databaseURL: "https://sleep-menager-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(config);
        const db = firebase.database();

        let user = JSON.parse(localStorage.getItem('sm_u'));
        let activeChat = "";
        let recorder, stream;

        if(user) {
            document.getElementById('auth-screen').style.display = 'none';
            setOnline(true);
            loadRecent();
        }

        async function auth() {
            const name = document.getElementById('reg-name').value.trim();
            const nick = document.getElementById('reg-user').value.trim().toLowerCase().replace('@','');
            if(!name || !nick) return alert("–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ!");
            
            const check = await db.ref('users/' + nick).once('value');
            if(check.exists()) return alert("–≠—Ç–æ—Ç @—é–∑–µ—Ä —É–∂–µ –∑–∞–Ω—è—Ç!");

            user = { name, nick: '@'+nick };
            await db.ref('users/' + nick).set(user);
            localStorage.setItem('sm_u', JSON.stringify(user));
            location.reload();
        }

        function setOnline(st) {
            if(!user) return;
            const nick = user.nick.replace('@','');
            db.ref('online/' + nick).set(st);
            if(st) db.ref('online/' + nick).onDisconnect().set(false);
        }

        // –ü–û–ò–°–ö –ò –°–û–ó–î–ê–ù–ò–ï –õ–ò–ß–ù–´–• –ß–ê–¢–û–í
        function search() {
            const q = document.getElementById('search-input').value.toLowerCase().replace('@','');
            if(q.length < 2) return;
            db.ref('users').orderByKey().startAt(q).endAt(q+"\uf8ff").once('value', s => {
                const res = document.getElementById('recent-chats');
                res.innerHTML = "<p style='padding:15px; font-size:12px; color:var(--blue)'>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</p>";
                s.forEach(c => {
                    const u = c.val();
                    if(u.nick !== user.nick) {
                        res.innerHTML += `
                            <div class="chat-item" onclick="startPrivate('${u.nick}')">
                                <div class="ava-wrap"><div class="ava">${u.name[0]}</div></div>
                                <div class="chat-info"><b>${u.name}</b><p>${u.nick}</p></div>
                            </div>`;
                    }
                });
            });
        }

        function startPrivate(target) {
            const pair = [user.nick.replace('@',''), target.replace('@','')].sort();
            const id = `private_${pair[0]}_${pair[1]}`;
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤ –Ω–∞ –≥–ª–∞–≤–Ω—É—é
            db.ref('recent/' + user.nick.replace('@','') + '/' + target.replace('@','')).set({name: target, id: id});
            db.ref('recent/' + target.replace('@','') + '/' + user.nick.replace('@','')).set({name: user.name, id: id});
            openChat(id, target);
        }

        function openChat(id, name) {
            activeChat = id;
            document.getElementById('win-name').innerText = name;
            document.getElementById('win-ava').innerText = name[0].toUpperCase();
            document.getElementById('chat-win').classList.add('active');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–Ω–ª–∞–π–Ω–∞
            const targetNick = name.replace('@','');
            db.ref('online/' + targetNick).on('value', s => {
                const isOnline = s.val();
                document.getElementById('win-status').innerText = isOnline ? '–≤ —Å–µ—Ç–∏' : '–æ—Ñ—Ñ–ª–∞–π–Ω';
                document.getElementById('win-online').className = 'online-dot ' + (isOnline ? 'active' : '');
            });

            syncMsgs();
        }

        function closeChat() { document.getElementById('chat-win').classList.remove('active'); db.ref('msgs/'+activeChat).off(); }

        function sendMsg(audio=null, video=null, img=null) {
            const inp = document.getElementById('m-input');
            if(!inp.value && !audio && !video && !img) return;
            db.ref('msgs/' + activeChat).push({
                u: user.name, nick: user.nick,
                text: inp.value, audio, video, img,
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            });
            inp.value = "";
        }

        function syncMsgs() {
            db.ref('msgs/' + activeChat).on('value', s => {
                const box = document.getElementById('msgs'); box.innerHTML = "";
                s.forEach(c => {
                    const d = c.val();
                    const mine = d.nick === user.nick;
                    let content = `<div>${d.text}</div>`;
                    if(d.audio) content = `<button onclick="new Audio('${d.audio}').play()">‚ñ∂ –ì–æ–ª–æ—Å–æ–≤–æ–µ</button>`;
                    if(d.video) content = `<video class="circle-vid" src="${d.video}" autoplay loop muted onclick="this.muted=!this.muted"></video>`;
                    if(d.img) content = `<img src="${d.img}" style="width:100%; border-radius:10px">`;
                    
                    box.innerHTML += `<div class="msg ${mine?'out':'in'}">${!mine?'<small><b>'+d.u+'</b></small>':''}${content}<div style="font-size:9px; opacity:0.5; text-align:right">${d.time}</div></div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // –†–ê–ë–û–¢–ê –° –ú–ï–î–ò–ê (–ì–° –ò –ö–†–£–ñ–ö–ò)
        async function startRec(type) {
            stream = await navigator.mediaDevices.getUserMedia({audio: true, video: type === 'video'});
            recorder = new MediaRecorder(stream);
            let chunks = [];
            document.getElementById(type === 'audio' ? 'mic-btn' : 'cam-btn').classList.add('rec');
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, {type: type === 'audio' ? 'audio/webm' : 'video/mp4'});
                const r = new FileReader();
                r.readAsDataURL(blob);
                r.onloadend = () => type === 'audio' ? sendMsg(r.result) : sendMsg(null, r.result);
                stream.getTracks().forEach(t => t.stop());
            };
            recorder.start();
            if(type === 'video') setTimeout(() => stopRec(), 10000); // –ö—Ä—É–∂–æ–∫ –º–∞–∫—Å 10 —Å–µ–∫
        }

        function stopRec() {
            if(recorder && recorder.state !== 'inactive') {
                recorder.stop();
                document.querySelectorAll('.btn-icon').forEach(b => b.classList.remove('rec'));
            }
        }

        function sendImg() {
            const url = prompt("–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ:");
            if(url) sendMsg(null, null, url);
        }

        function loadRecent() {
            db.ref('recent/' + user.nick.replace('@','')).on('value', s => {
                const box = document.getElementById('recent-chats'); box.innerHTML = "";
                s.forEach(c => {
                    const d = c.val();
                    box.innerHTML += `
                        <div class="chat-item" onclick="openChat('${d.id}', '${d.name}')">
                            <div class="ava-wrap"><div class="ava">${d.name[0].toUpperCase()}</div><div class="online-dot" id="dot-${d.name.replace('@','')}"></div></div>
                            <div class="chat-info"><b>${d.name}</b><p>–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</p></div>
                        </div>`;
                });
            });
        }

        function showCreateMenu() {
            const act = prompt("–ß—Ç–æ —Å–æ–∑–¥–∞—Ç—å?\n1 - –ì—Ä—É–ø–ø–∞\n2 - –ö–∞–Ω–∞–ª");
            if(act == "1") {
                const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:");
                if(n) openChat('group_'+Date.now(), n);
            }
        }
    </script>
</body>
</html>
