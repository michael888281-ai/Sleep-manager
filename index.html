<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sleep Manager Official</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --tg-blue: #507da0;
            --tg-light-blue: #64a1d1;
            --tg-bg: #c7d1d9;
            --white: #ffffff;
            --text-main: #222222;
            --text-gray: #8e8e93;
            --msg-in: #ffffff;
            --msg-out: #effdde;
            --online: #4caf50;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            font-family: -apple-system, system-ui, "Helvetica Neue", Roboto, sans-serif; 
            background: var(--white); color: var(--text-main); overflow: hidden; 
        }

        /* --- –ü–†–ò–í–ï–¢–°–¢–í–ò–ï / –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø --- */
        #auth-gate { 
            position: fixed; inset: 0; background: var(--white); z-index: 10000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; 
        }
        .auth-logo { width: 100px; height: 100px; background: var(--tg-blue); border-radius: 25px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; color: white; font-size: 50px; font-weight: bold; }
        .auth-form { width: 100%; max-width: 320px; text-align: center; }
        .auth-form h1 { font-size: 24px; margin-bottom: 10px; color: var(--tg-blue); }
        .auth-form input { width: 100%; padding: 16px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 15px; font-size: 16px; transition: 0.3s; }
        .auth-form input:focus { border-color: var(--tg-blue); box-shadow: 0 0 0 2px rgba(80,125,160,0.2); }
        .auth-btn { width: 100%; padding: 16px; background: var(--tg-blue); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; }

        /* --- –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù --- */
        .app-shell { display: none; flex-direction: column; height: 100vh; }
        
        header { 
            background: var(--tg-blue); color: white; height: 56px; 
            display: flex; align-items: center; padding: 0 16px; gap: 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 100;
        }
        .app-title { flex: 1; font-size: 20px; font-weight: 500; }
        
        .search-wrap { 
            background: #fff; padding: 10px 15px; border-bottom: 1px solid #eee; 
            display: flex; align-items: center; gap: 10px;
        }
        .search-wrap input { flex: 1; border: none; background: #f1f1f2; padding: 10px 15px; border-radius: 10px; font-size: 14px; }

        /* --- –°–ü–ò–°–û–ö –ß–ê–¢–û–í --- */
        .chat-list { flex: 1; overflow-y: auto; background: white; }
        .chat-item { 
            display: flex; padding: 12px 16px; gap: 14px; align-items: center; 
            border-bottom: 0.5px solid #f0f0f0; cursor: pointer; position: relative;
        }
        .chat-item:active { background: #f2f2f2; }
        .avatar { 
            width: 54px; height: 54px; border-radius: 50%; background: var(--tg-light-blue); 
            color: white; display: flex; align-items: center; justify-content: center; 
            font-size: 20px; font-weight: bold; flex-shrink: 0; position: relative;
        }
        .online-status { 
            position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; 
            background: var(--online); border: 2px solid white; border-radius: 50%; display: none;
        }
        .item-info { flex: 1; overflow: hidden; }
        .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .item-name { font-weight: 600; font-size: 16px; color: var(--text-main); }
        .item-time { font-size: 12px; color: var(--text-gray); }
        .item-msg { font-size: 14px; color: var(--text-gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .unread-badge { background: var(--tg-light-blue); color: white; border-radius: 12px; padding: 2px 8px; font-size: 11px; font-weight: bold; }

        /* --- –û–ö–ù–û –ß–ê–¢–ê --- */
        #chat-view { 
            position: fixed; inset: 0; background: var(--tg-bg); z-index: 5000; 
            display: none; flex-direction: column; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #chat-view.active { display: flex; transform: translateX(0); }
        
        .chat-header { 
            background: white; height: 56px; display: flex; align-items: center; 
            padding: 0 10px; gap: 15px; border-bottom: 1px solid #ddd; 
        }
        .back-btn { font-size: 24px; padding: 10px; cursor: pointer; color: var(--tg-blue); }
        
        #messages-container { 
            flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; 
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-attachment: fixed;
        }
        
        .bubble { 
            padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 15px; 
            position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; 
        }
        .bubble.in { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 2px; }
        .bubble.out { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 2px; }
        .bubble img { max-width: 100%; border-radius: 8px; margin: 4px 0; display: block; }
        .bubble-time { font-size: 10px; color: #a0a0a0; text-align: right; margin-top: 4px; }

        /* --- –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê --- */
        .input-panel { background: white; padding: 8px 12px; display: flex; align-items: center; gap: 10px; }
        .input-panel input { flex: 1; border: none; background: #f1f1f2; padding: 12px 16px; border-radius: 20px; font-size: 16px; }
        .action-btn { color: var(--tg-blue); font-size: 24px; cursor: pointer; transition: 0.2s; }
        .action-btn:active { transform: scale(0.8); }
        .recording-ui { color: #f44336; animation: blink 1s infinite; }

        /* --- –ü–†–û–§–ò–õ–¨ --- */
        #profile-screen { 
            position: fixed; inset: 0; background: #f1f1f2; z-index: 6000; 
            display: none; flex-direction: column; 
        }
        .profile-header { background: var(--tg-blue); color: white; padding: 20px; text-align: center; position: relative; }
        .profile-ava { width: 100px; height: 100px; border-radius: 50%; background: var(--tg-light-blue); margin: 0 auto 15px; font-size: 40px; display: flex; align-items: center; justify-content: center; border: 3px solid white; }
        .profile-info-box { background: white; margin-top: 10px; padding: 15px; }
        .info-label { color: var(--tg-blue); font-size: 13px; font-weight: 600; margin-bottom: 4px; }
        .info-value { font-size: 16px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 8px; }

        /* --- FOOTER NAV --- */
        footer { 
            height: 56px; background: white; border-top: 1px solid #eee; 
            display: flex; justify-content: space-around; align-items: center; 
        }
        .nav-btn { text-align: center; color: var(--text-gray); font-size: 11px; flex: 1; padding: 8px 0; }
        .nav-btn.active { color: var(--tg-blue); }
        .nav-btn i { font-size: 22px; display: block; margin-bottom: 2px; }

        @keyframes blink { 50% { opacity: 0.4; } }

        /* –ì—Ä—É–ø–ø—ã –∏ –ö–∞–Ω–∞–ª—ã */
        .fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; background: var(--tg-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 400; }
    </style>
</head>
<body>

    <div id="auth-gate">
        <div class="auth-logo">S</div>
        <div class="auth-form">
            <h1>Sleep Manager</h1>
            <p style="color:var(--text-gray); margin-bottom:20px;">–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</p>
            <input type="text" id="reg-name" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="text" id="reg-user" placeholder="@username (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π)">
            <input type="text" id="reg-bio" placeholder="–û —Å–µ–±–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            <button class="auth-btn" onclick="app.doAuth()">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
        </div>
    </div>

    <div class="app-shell" id="main-app">
        <header>
            <div class="app-title">Sleep Manager</div>
            <div style="font-size:22px;" onclick="app.showProfile()">üë§</div>
        </header>

        <div class="search-wrap">
            <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π –ø–æ @username..." oninput="app.search()">
        </div>

        <div class="chat-list" id="chat-items-container">
            </div>

        <div class="fab" onclick="app.createChannel()">+</div>

        <footer>
            <div class="nav-btn active"><i>üí¨</i>–ß–∞—Ç—ã</div>
            <div class="nav-btn" onclick="app.showChannels()"><i>üì¢</i>–ö–∞–Ω–∞–ª—ã</div>
            <div class="nav-btn" onclick="app.showProfile()"><i>‚öôÔ∏è</i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        </footer>
    </div>

    <div id="chat-view">
        <div class="chat-header">
            <div class="back-btn" onclick="app.closeChat()">‚Üê</div>
            <div class="avatar" id="chat-header-ava" style="width:40px; height:40px; font-size:16px;">?</div>
            <div style="flex:1">
                <div id="chat-header-name" style="font-weight:600; font-size:16px;">–ò–º—è</div>
                <div id="chat-header-status" style="font-size:12px; color:var(--text-gray);">–æ—Ñ—Ñ–ª–∞–π–Ω</div>
            </div>
            <div class="action-btn" onclick="app.toggleBlock()">üö´</div>
        </div>
        <div id="messages-container"></div>
        <div class="input-panel">
            <label class="action-btn">
                üìé<input type="file" id="file-input" hidden accept="image/*" onchange="app.sendImage(this)">
            </label>
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <div class="action-btn" id="mic-btn" onmousedown="app.recStart()" onmouseup="app.recStop()" ontouchstart="app.recStart()" ontouchend="app.recStop()">üéôÔ∏è</div>
            <div class="action-btn" onclick="app.sendText()">‚û§</div>
        </div>
    </div>

    <div id="profile-screen">
        <div class="profile-header">
            <div class="back-btn" onclick="app.closeProfile()" style="position:absolute; left:10px; top:10px; color:white;">‚Üê</div>
            <div class="profile-ava" id="p-ava-main">?</div>
            <h2 id="p-name-main" style="margin:0;">–ò–º—è</h2>
            <p id="p-user-main" style="opacity:0.8; margin:5px 0 0;">@username</p>
        </div>
        <div class="profile-info-box">
            <div class="info-label">–û —Å–µ–±–µ</div>
            <div class="info-value" id="p-bio-main">–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è</div>
            
            <div class="info-label">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div class="info-value" style="color: #f44336; font-weight: 600;" onclick="app.logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
            authDomain: "sleep-menager.firebaseapp.com",
            projectId: "sleep-menager",
            storageBucket: "sleep-menager.firebasestorage.app",
            messagingSenderId: "3927631074",
            appId: "1:3927631074:web:a3a604c7147e31a900eabb",
            databaseURL: "https://sleep-menager-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const app = {
            me: JSON.parse(localStorage.getItem('sm_session')),
            activeChat: null,
            recorder: null,
            chunks: [],
            blacklist: JSON.parse(localStorage.getItem('sm_block')) || [],

            init() {
                if (this.me) {
                    document.getElementById('auth-gate').style.display = 'none';
                    document.getElementById('main-app').style.display = 'flex';
                    this.updateOnline(true);
                    this.loadRecent();
                    this.updateProfileUI();
                }
            },

            async doAuth() {
                const name = document.getElementById('reg-name').value.trim();
                const user = document.getElementById('reg-user').value.trim().toLowerCase().replace('@','');
                const bio = document.getElementById('reg-bio').value.trim();
                
                if (!name || !user) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –∏ —é–∑–µ—Ä–Ω–µ–π–º!");
                
                const snap = await db.ref('users/' + user).once('value');
                if (snap.exists()) return alert("–≠—Ç–æ—Ç —é–∑–µ—Ä–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç!");

                this.me = { name, user: '@' + user, bio: bio || "–ü—Ä–∏–≤–µ—Ç, —è –≤ Sleep Manager!" };
                await db.ref('users/' + user).set(this.me);
                localStorage.setItem('sm_session', JSON.stringify(this.me));
                location.reload();
            },

            updateOnline(status) {
                if (!this.me) return;
                const u = this.me.user.replace('@','');
                db.ref('status/' + u).set(status);
                if (status) db.ref('status/' + u).onDisconnect().set(false);
            },

            search() {
                const q = document.getElementById('user-search').value.toLowerCase().replace('@','');
                if (q.length < 2) return;
                db.ref('users').orderByKey().startAt(q).endAt(q + "\uf8ff").once('value', s => {
                    const cont = document.getElementById('chat-items-container');
                    cont.innerHTML = "<div style='padding:10px; font-size:12px; color:var(--tg-blue)'>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</div>";
                    s.forEach(c => {
                        const u = c.val();
                        if (u.user !== this.me.user) {
                            cont.innerHTML += `
                                <div class="chat-item" onclick="app.openPrivate('${u.user}', '${u.name}')">
                                    <div class="avatar">${u.name[0]}</div>
                                    <div class="item-info">
                                        <div class="item-name">${u.name}</div>
                                        <div class="item-msg">${u.user}</div>
                                    </div>
                                </div>`;
                        }
                    });
                });
            },

            openPrivate(targetUser, targetName) {
                const myId = this.me.user.replace('@','');
                const hisId = targetUser.replace('@','');
                const chatId = [myId, hisId].sort().join('_');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –Ω–µ–¥–∞–≤–Ω–∏–µ, —á—Ç–æ–±—ã —á–∞—Ç –ø–æ—è–≤–∏–ª—Å—è —É –æ–±–æ–∏—Ö
                db.ref(`recent/${myId}/${hisId}`).set({ name: targetName, user: targetUser });
                db.ref(`recent/${hisId}/${myId}`).set({ name: this.me.name, user: this.me.user });
                
                this.activeChat = { id: chatId, name: targetName, user: targetUser };
                this.showChat();
            },

            showChat() {
                const win = document.getElementById('chat-view');
                document.getElementById('chat-header-name').innerText = this.activeChat.name;
                document.getElementById('chat-header-ava').innerText = this.activeChat.name[0];
                win.classList.add('active');
                this.syncMessages();
                
                // –°–ª–µ–¥–∏–º –∑–∞ –æ–Ω–ª–∞–π–Ω–æ–º
                const u = this.activeChat.user.replace('@','');
                db.ref('status/' + u).on('value', s => {
                    document.getElementById('chat-header-status').innerText = s.val() ? '–≤ —Å–µ—Ç–∏' : '–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ';
                });
            },

            closeChat() {
                document.getElementById('chat-view').classList.remove('active');
                if (this.activeChat) db.ref('messages/' + this.activeChat.id).off();
                this.activeChat = null;
            },

            syncMessages() {
                const cont = document.getElementById('messages-container');
                db.ref('messages/' + this.activeChat.id).on('value', s => {
                    cont.innerHTML = "";
                    s.forEach(m => {
                        const d = m.val();
                        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
                        if (this.blacklist.includes(d.sender)) return;

                        const isMe = d.sender === this.me.user;
                        let content = `<div>${d.text || ''}</div>`;
                        if (d.img) content = `<img src="${d.img}" onclick="window.open('${d.img}')">`;
                        if (d.voice) content = `<div onclick="new Audio('${d.voice}').play()" style="cursor:pointer">üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>`;

                        cont.innerHTML += `
                            <div class="bubble ${isMe ? 'out' : 'in'}">
                                ${content}
                                <div class="bubble-time">${d.time}</div>
                            </div>`;
                    });
                    cont.scrollTop = cont.scrollHeight;
                });
            },

            sendText() {
                const inp = document.getElementById('msg-input');
                if (!inp.value.trim()) return;
                this.pushMsg({ text: inp.value });
                inp.value = "";
            },

            async sendImage(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = e => this.pushMsg({ img: e.target.result });
                    reader.readAsDataURL(input.files[0]);
                }
            },

            async recStart() {
                try {
                    const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.recorder = new MediaRecorder(s);
                    this.chunks = [];
                    document.getElementById('mic-btn').classList.add('recording-ui');
                    this.recorder.ondataavailable = e => this.chunks.push(e.data);
                    this.recorder.onstop = () => {
                        const blob = new Blob(this.chunks, { type: 'audio/webm' });
                        const r = new FileReader();
                        r.readAsDataURL(blob);
                        r.onloadend = () => this.pushMsg({ voice: r.result });
                    };
                    this.recorder.start();
                } catch(e) { alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"); }
            },

            recStop() {
                if (this.recorder && this.recorder.state !== 'inactive') {
                    this.recorder.stop();
                    document.getElementById('mic-btn').classList.remove('recording-ui');
                }
            },

            pushMsg(data) {
                db.ref('messages/' + this.activeChat.id).push({
                    ...data,
                    sender: this.me.user,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                });
            },

            loadRecent() {
                const u = this.me.user.replace('@','');
                db.ref('recent/' + u).on('value', s => {
                    const cont = document.getElementById('chat-items-container');
                    cont.innerHTML = "";
                    s.forEach(c => {
                        const d = c.val();
                        cont.innerHTML += `
                            <div class="chat-item" onclick="app.openPrivate('${d.user}', '${d.name}')">
                                <div class="avatar">${d.name[0]}</div>
                                <div class="item-info">
                                    <div class="item-row">
                                        <div class="item-name">${d.name}</div>
                                        <div class="item-time">—Å–µ–π—á–∞—Å</div>
                                    </div>
                                    <div class="item-msg">${d.user}</div>
                                </div>
                            </div>`;
                    });
                });
            },

            showProfile() {
                document.getElementById('profile-screen').style.display = 'flex';
                this.updateProfileUI();
            },

            closeProfile() { document.getElementById('profile-screen').style.display = 'none'; },

            updateProfileUI() {
                document.getElementById('p-ava-main').innerText = this.me.name[0];
                document.getElementById('p-name-main').innerText = this.me.name;
                document.getElementById('p-user-main').innerText = this.me.user;
                document.getElementById('p-bio-main').innerText = this.me.bio;
            },

            toggleBlock() {
                const target = this.activeChat.user;
                if (this.blacklist.includes(target)) {
                    this.blacklist = this.blacklist.filter(i => i !== target);
                    alert("–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
                } else {
                    this.blacklist.push(target);
                    alert("–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω");
                }
                localStorage.setItem('sm_block', JSON.stringify(this.blacklist));
            },

            logout() {
                localStorage.clear();
                location.reload();
            },

            createChannel() {
                const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞:");
                if (name) alert("–ö–∞–Ω–∞–ª '" + name + "' —Å–æ–∑–¥–∞–Ω! (–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)");
            }
        };

        app.init();
    </script>
</body>
</html>
