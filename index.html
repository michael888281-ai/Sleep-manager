<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sleep Universe | Singularity</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary: #007aff;
            --glass: rgba(255, 255, 255, 0.7);
            --glass-dark: rgba(28, 28, 30, 0.8);
            --bg: #f2f2f7;
            --text: #000000;
            --sub: #8e8e93;
            --accent: #5856d6;
            --danger: #ff3b30;
            --blur: blur(20px);
        }

        [data-theme="dark"] {
            --bg: #000000;
            --glass: rgba(28, 28, 30, 0.7);
            --text: #ffffff;
            --sub: #98989d;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica;
            background: var(--bg); color: var(--text); overflow: hidden;
        }

        /* --- –ê–ù–ò–ú–ò–†–û–í–ê–ù–ù–´–ô –§–û–ù --- */
        .bg-blobs {
            position: fixed; inset: 0; z-index: -1; overflow: hidden; filter: blur(80px); opacity: 0.6;
        }
        .blob {
            position: absolute; width: 300px; height: 300px; border-radius: 50%;
            animation: move 20s infinite alternate;
        }
        @keyframes move { from { transform: translate(-10%, -10%); } to { transform: translate(100%, 100%); } }

        /* --- –≠–ö–†–ê–ù–´ --- */
        .screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 100;
            display: flex; flex-direction: column; transform: translateX(100%);
            visibility: hidden;
        }
        .screen.active { transform: translateX(0); visibility: visible; }
        .screen.full-bottom { transform: translateY(100%); }
        .screen.full-bottom.active { transform: translateY(0); }

        /* --- HEADER --- */
        header {
            height: 64px; background: var(--glass); backdrop-filter: var(--blur);
            display: flex; align-items: center; padding: 0 20px; z-index: 200;
            border-bottom: 0.5px solid rgba(0,0,0,0.1); sticky; top: 0;
        }
        .h-title { flex: 1; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
        .h-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
        .h-btn:hover { background: rgba(0,0,0,0.05); }

        /* --- STORIES --- */
        .stories-rail {
            display: flex; overflow-x: auto; padding: 15px; gap: 15px; background: var(--bg);
            scrollbar-width: none; border-bottom: 0.5px solid rgba(0,0,0,0.05);
        }
        .story-item { flex-shrink: 0; width: 70px; text-align: center; }
        .story-circle {
            width: 66px; height: 66px; border-radius: 24px; border: 2px solid var(--primary);
            padding: 3px; margin-bottom: 6px; position: relative;
        }
        .story-circle img { width: 100%; height: 100%; border-radius: 20px; object-fit: cover; }
        .story-plus {
            position: absolute; bottom: -2px; right: -2px; width: 22px; height: 22px;
            background: var(--primary); color: white; border-radius: 50%; border: 2px solid var(--bg);
            font-size: 14px; font-weight: bold;
        }

        /* --- CHAT LIST --- */
        .list-container { flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .chat-card {
            display: flex; padding: 14px 20px; gap: 15px; cursor: pointer;
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
        }
        .chat-card:active { background: rgba(0,0,0,0.05); transform: scale(0.98); }
        .avatar {
            width: 60px; height: 60px; border-radius: 22px; background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 700; flex-shrink: 0; box-shadow: 0 8px 15px rgba(0,122,255,0.2);
        }
        .chat-info { flex: 1; min-width: 0; }
        .chat-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .chat-name { font-weight: 700; font-size: 17px; }
        .chat-time { font-size: 12px; color: var(--sub); }
        .chat-last { font-size: 14px; color: var(--sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- MESSENGER ENGINE --- */
        .viewport { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg); display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 16px; border-radius: 22px; max-width: 80%; font-size: 16px; position: relative; line-height: 1.4; }
        .msg.in { align-self: flex-start; background: var(--glass); border-bottom-left-radius: 5px; }
        .msg.out { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 5px; }
        
        .input-area {
            background: var(--glass); backdrop-filter: var(--blur); padding: 10px 20px 35px;
            display: flex; align-items: center; gap: 12px; border-top: 0.5px solid rgba(0,0,0,0.1);
        }
        .input-field {
            flex: 1; background: rgba(0,0,0,0.05); border: none; border-radius: 25px;
            padding: 12px 18px; font-size: 16px; color: var(--text);
        }

        /* --- CALL UI --- */
        #call-ui { background: #000; z-index: 10000; color: white; }
        #remote-v { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
        #local-v { 
            position: absolute; top: 40px; right: 20px; width: 110px; height: 160px; 
            border-radius: 20px; border: 2px solid rgba(255,255,255,0.3); z-index: 10; object-fit: cover;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .call-overlay {
            position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent, rgba(0,0,0,0.8));
            display: flex; flex-direction: column; justify-content: space-between; padding: 60px 20px; align-items: center;
        }
        .call-actions { display: flex; gap: 30px; }
        .c-btn {
            width: 75px; height: 75px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 30px; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* --- FOOTER TABS --- */
        footer {
            height: 84px; background: var(--glass); backdrop-filter: var(--blur);
            position: fixed; bottom: 0; width: 100%; display: flex; padding-bottom: 20px;
            border-top: 0.5px solid rgba(0,0,0,0.1); z-index: 150;
        }
        .tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; color: var(--sub); cursor: pointer; }
        .tab.active { color: var(--primary); }
        .tab i { font-size: 24px; margin-bottom: 4px; font-style: normal; }

        /* --- AUTH --- */
        #auth-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px;
        }
        .auth-card {
            width: 100%; max-width: 340px; background: var(--glass); padding: 30px; 
            border-radius: 35px; backdrop-filter: var(--blur); box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .voice-msg { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .pulse { animation: pulse-red 1.5s infinite; color: var(--danger) !important; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="bg-blobs">
        <div class="blob" style="background: #007aff; top: -10%; left: -10%;"></div>
        <div class="blob" style="background: #5856d6; bottom: -10%; right: -10%; animation-delay: -5s;"></div>
    </div>

    <div id="auth-screen">
        <div class="auth-card">
            <h1 style="margin:0; text-align:center;">Sleep ü™ê</h1>
            <p style="text-align:center; color:var(--sub); margin-bottom:30px;">Singularity Edition</p>
            <input type="text" id="reg-n" class="input-field" style="width:100%; margin-bottom:15px;" placeholder="–í–∞—à–µ –∏–º—è">
            <input type="text" id="reg-u" class="input-field" style="width:100%; margin-bottom:25px;" placeholder="@username">
            <button class="input-field" style="width:100%; background:var(--primary); color:white; font-weight:bold;" onclick="core.register()">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <header>
        <div class="h-title">Sleep</div>
        <div class="h-btn" onclick="core.open('scr-search')">üîç</div>
        <div class="h-btn" id="ghost-btn" onclick="core.toggleGhost()">üëª</div>
    </header>

    <div id="main-scroll" style="flex:1; overflow-y:auto;">
        <div class="stories-rail">
            <div class="story-item" onclick="document.getElementById('st-file').click()">
                <div class="story-circle" style="border-color:var(--sub);"><div class="story-plus">+</div><img src="https://via.placeholder.com/100" id="my-st"></div>
                <span>–í—ã</span>
                <input type="file" id="st-file" hidden onchange="core.uploadStory(this)">
            </div>
            <div id="stories-feed" style="display:flex; gap:15px;"></div>
        </div>
        <div class="list-container" id="chat-list"></div>
    </div>

    <footer>
        <div class="tab active" onclick="core.home()"><i>üí¨</i>–ß–∞—Ç—ã</div>
        <div class="tab" onclick="core.open('scr-bots')"><i>ü§ñ</i>–ë–æ—Ç—ã</div>
        <div class="tab" onclick="core.open('scr-profile')"><i>üë§</i>–ü—Ä–æ—Ñ–∏–ª—å</div>
    </footer>

    <div id="scr-search" class="screen">
        <header><div class="h-btn" onclick="core.home()">‚Üê</div><input type="text" id="sq" class="input-field" placeholder="–ü–æ–∏—Å–∫ –ø–æ @username..." oninput="core.searchUser()"></header>
        <div id="search-res" class="list-container"></div>
    </div>

    <div id="scr-chat" class="screen">
        <header>
            <div class="h-btn" onclick="core.home()">‚Üê</div>
            <div class="avatar" id="v-ava" style="width:40px; height:40px; font-size:16px; margin:0 12px;">?</div>
            <div style="flex:1;"><b id="v-name">...</b><div id="v-stat" style="font-size:10px; color:var(--primary);">–æ–Ω–ª–∞–π–Ω</div></div>
            <div class="h-btn" onclick="core.call(true)">üìû</div>
        </header>
        <div class="viewport" id="msg-box"></div>
        <div class="input-area">
            <div class="h-btn" onclick="document.getElementById('msg-img').click()">üñºÔ∏è<input type="file" id="msg-img" hidden onchange="core.sendImg(this)"></div>
            <textarea id="f-msg" class="input-field" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
            <div class="h-btn" id="mic-btn" onclick="core.toggleGS()">üé§</div>
            <div class="h-btn" style="color:var(--primary)" onclick="core.send()">‚û§</div>
        </div>
    </div>

    <div id="scr-call" class="screen">
        <video id="remote-v" autoplay playsinline></video>
        <video id="local-v" autoplay playsinline muted></video>
        <div class="call-overlay">
            <div style="text-align:center;">
                <h2 id="c-user">–í—ã–∑–æ–≤...</h2>
                <div id="c-time">00:00</div>
            </div>
            <div class="call-actions">
                <div class="c-btn" style="background:var(--danger);" onclick="core.endCall()">üìû</div>
            </div>
        </div>
    </div>

    <div id="scr-profile" class="screen">
        <header><div class="h-btn" onclick="core.home()">‚Üê</div><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b></header>
        <div style="padding:40px; text-align:center;">
            <div class="avatar" id="my-big-ava" style="width:120px; height:120px; font-size:45px; margin:0 auto 20px; cursor:pointer;" onclick="document.getElementById('p-file').click()">?</div>
            <input type="file" id="p-file" hidden onchange="core.updateAva(this)">
            <h2 id="p-name">Name</h2>
            <p id="p-user" style="color:var(--primary);">@user</p>
            <br>
            <button class="input-field" style="width:100%;" onclick="core.toggleDark()">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</button>
            <button class="input-field" style="width:100%; margin-top:10px; color:var(--danger);" onclick="core.logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div id="scr-bots" class="screen full-bottom">
        <header><div class="h-btn" onclick="core.home()">‚úï</div><b>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–æ—Ç–æ–≤</b></header>
        <div style="padding:25px;">
            <input type="text" id="bn" class="input-field" style="width:100%; margin-bottom:15px;" placeholder="–ò–º—è –±–æ—Ç–∞">
            <textarea id="br" class="input-field" style="width:100%; height:100px;" placeholder="–§—Ä–∞–∑–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ..."></textarea>
            <button class="input-field" style="width:100%; background:var(--accent); color:white; margin-top:20px;" onclick="core.createBot()">–°–æ–∑–¥–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
        </div>
    </div>

    <script>
        const config = {
            apiKey: "AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
            authDomain: "sleep-menager.firebaseapp.com",
            projectId: "sleep-menager",
            databaseURL: "https://sleep-menager-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(config);
        const db = firebase.database();

        const core = {
            me: JSON.parse(localStorage.getItem('slp_sing')),
            chat: null, gh: localStorage.getItem('slp_gh')==='1',
            pc: null, stream: null, rec: null, chunks: [],

            init() {
                if(this.me) {
                    document.getElementById('auth-screen').remove();
                    this.syncChats();
                    this.syncStories();
                    this.listenCalls();
                    this.loadProfile();
                    this.updateOnline(true);
                    if(localStorage.getItem('slp_dark')==='1') document.body.setAttribute('data-theme', 'dark');
                    if(this.gh) document.getElementById('ghost-btn').style.color = 'var(--accent)';
                }
            },

            async register() {
                const n = document.getElementById('reg-n').value, u = document.getElementById('reg-u').value.replace('@','').toLowerCase();
                if(!n || !u) return;
                this.me = { n, u: '@'+u, a: '' };
                await db.ref('u/'+u).set(this.me);
                localStorage.setItem('slp_sing', JSON.stringify(this.me));
                location.reload();
            },

            loadProfile() {
                document.getElementById('p-name').innerText = this.me.n;
                document.getElementById('p-user').innerText = this.me.u;
                document.getElementById('my-big-ava').innerText = this.me.n[0];
                if(this.me.a) document.getElementById('my-big-ava').innerHTML = `<img src="${this.me.a}" style="width:100%; height:100%; border-radius:inherit; object-fit:cover;">`;
            },

            open(id) { this.closeAll(); document.getElementById(id).classList.add('active'); },
            home() { this.closeAll(); },
            closeAll() { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); },

            // --- CHATS & MESSAGES ---
            syncChats() {
                db.ref('rec/'+this.me.u.replace('@','')).on('value', s => {
                    const box = document.getElementById('chat-list'); box.innerHTML = "";
                    s.forEach(c => {
                        const d = c.val();
                        box.innerHTML += `<div class="chat-card" onclick="core.openChat('${d.u}','${d.n}', ${!!d.isB})">
                            <div class="avatar">${d.n[0]}</div>
                            <div class="chat-info">
                                <div class="chat-row"><span class="chat-name">${d.n}</span><span class="chat-time">12:00</span></div>
                                <div class="chat-last">${d.isB ? 'ü§ñ –ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω' : d.u}</div>
                            </div>
                        </div>`;
                    });
                });
            },

            async openChat(u, n, isBot = false) {
                this.chat = { id: [this.me.u, u].sort().join('_').replace(/@/g,''), u, n, isBot };
                document.getElementById('v-name').innerText = n;
                document.getElementById('v-ava').innerText = n[0];
                this.open('scr-chat');
                
                db.ref('m/'+this.chat.id).on('value', s => {
                    const box = document.getElementById('msg-box'); box.innerHTML = "";
                    s.forEach(m => {
                        const d = m.val();
                        let content = d.t;
                        if(d.v) content = `<div class="voice-msg" onclick="new Audio('${d.v}').play()">‚è∫ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>`;
                        if(d.i) content = `<img src="${d.i}" style="max-width:100%; border-radius:15px;">`;
                        box.innerHTML += `<div class="msg ${d.f===this.me.u?'out':'in'}">${content}</div>`;
                    });
                    box.scrollTop = box.scrollHeight;
                });
            },

            send() {
                const f = document.getElementById('f-msg'); if(!f.value.trim()) return;
                db.ref('m/'+this.chat.id).push({ t: f.value, f: this.me.u, ts: Date.now() });
                if(this.chat.isBot) this.botReply(f.value);
                f.value = "";
            },

            // --- SEARCH SYSTEM ---
            searchUser() {
                const q = document.getElementById('sq').value.replace('@','').toLowerCase();
                if(q.length < 2) return;
                db.ref('u/'+q).once('value', s => {
                    const box = document.getElementById('search-res'); box.innerHTML = "";
                    if(s.exists()) {
                        const d = s.val();
                        box.innerHTML = `<div class="chat-card" onclick="core.addChat('${d.u}','${d.n}')">
                            <div class="avatar">${d.n[0]}</div>
                            <div class="chat-info"><div class="chat-name">${d.n}</div><div class="chat-last">${d.u}</div></div>
                        </div>`;
                    }
                });
            },

            addChat(u, n) {
                db.ref(`rec/${this.me.u.replace('@','')}/${u.replace('@','')}`).set({ u, n });
                this.openChat(u, n);
            },

            // --- VOICE MESSAGES (G–°) ---
            async toggleGS() {
                const btn = document.getElementById('mic-btn');
                if(!this.rec) {
                    const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.rec = new MediaRecorder(s);
                    this.rec.ondataavailable = e => this.chunks.push(e.data);
                    this.rec.onstop = () => {
                        const b = new Blob(this.chunks, { type: 'audio/webm' });
                        const r = new FileReader();
                        r.onload = () => db.ref('m/'+this.chat.id).push({ v: r.result, f: this.me.u });
                        r.readAsDataURL(b); this.chunks = [];
                    };
                    this.rec.start(); btn.classList.add('pulse');
                } else {
                    this.rec.stop(); this.rec = null; btn.classList.remove('pulse');
                }
            },

            // --- CALL ENGINE (WEBRTC) ---
            async call(isOff) {
                this.open('scr-call');
                document.getElementById('c-user').innerText = this.chat.n;
                this.stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-v').srcObject = this.stream;
                
                this.pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                this.stream.getTracks().forEach(t => this.pc.addTrack(t, this.stream));
                this.pc.ontrack = e => document.getElementById('remote-v').srcObject = e.streams[0];
                
                const ref = db.ref('calls/'+this.chat.id);
                if(isOff) {
                    const offer = await this.pc.createOffer();
                    await this.pc.setLocalDescription(offer);
                    ref.set({ offer, from: this.me.u, fromN: this.me.n });
                }

                this.pc.onicecandidate = e => e.candidate && ref.child('ice').push(e.candidate.toJSON());
                ref.on('value', async s => {
                    const d = s.val(); if(!d) return;
                    if(!isOff && d.offer && !this.pc.remoteDescription) {
                        await this.pc.setRemoteDescription(new RTCSessionDescription(d.offer));
                        const ans = await this.pc.createAnswer();
                        await this.pc.setLocalDescription(ans);
                        ref.update({ answer: ans });
                    }
                    if(isOff && d.answer && !this.pc.remoteDescription) await this.pc.setRemoteDescription(new RTCSessionDescription(d.answer));
                });
                ref.child('ice').on('child_added', s => this.pc.addIceCandidate(new RTCIceCandidate(s.val())));
            },

            listenCalls() {
                db.ref('calls').on('child_added', s => {
                    const d = s.val();
                    if(d.from !== this.me.u && s.key.includes(this.me.u.replace('@',''))) {
                        if(confirm("–ó–≤–æ–Ω–∏—Ç " + d.fromN)) {
                            this.chat = { id: s.key, u: d.from, n: d.fromN };
                            this.call(false);
                        } else { db.ref('calls/'+s.key).remove(); }
                    }
                });
            },

            endCall() { location.reload(); },

            // --- STORIES & PROFILE ---
            uploadStory(inp) {
                const r = new FileReader(); r.onload = e => {
                    db.ref('st').push({ i: e.target.result, n: this.me.n, f: this.me.u });
                    document.getElementById('my-st').src = e.target.result;
                }; r.readAsDataURL(inp.files[0]);
            },

            syncStories() {
                db.ref('st').on('value', s => {
                    const f = document.getElementById('stories-feed'); f.innerHTML = "";
                    s.forEach(st => { if(st.val().f !== this.me.u) f.innerHTML += `<div class="story-item"><div class="story-circle"><img src="${st.val().i}"></div><span>${st.val().n}</span></div>`; });
                });
            },

            updateAva(inp) {
                const r = new FileReader(); r.onload = async e => {
                    this.me.a = e.target.result;
                    await db.ref('u/'+this.me.u.replace('@','')).update({ a: e.target.result });
                    localStorage.setItem('slp_sing', JSON.stringify(this.me));
                    this.loadProfile();
                }; r.readAsDataURL(inp.files[0]);
            },

            createBot() {
                const n = document.getElementById('bn').value, r = document.getElementById('br').value;
                if(!n) return;
                db.ref(`rec/${this.me.u.replace('@','')}/${n}`).set({ n, u: '@'+n, isB: true, reply: r });
                this.home();
            },

            botReply(msg) {
                db.ref(`rec/${this.me.u.replace('@','')}/${this.chat.n}/reply`).once('value', s => {
                    setTimeout(() => { db.ref('m/'+this.chat.id).push({ t: s.val() || "...", f: '@'+this.chat.n }); }, 1000);
                });
            },

            toggleGhost() { this.gh = !this.gh; localStorage.setItem('slp_gh', this.gh?'1':'0'); location.reload(); },
            updateOnline(st) { if(this.me && !this.gh) db.ref('u/'+this.me.u.replace('@','')+'/on').set(st); },
            toggleDark() { 
                const d = document.body.getAttribute('data-theme') === 'dark';
                document.body.setAttribute('data-theme', d ? 'light' : 'dark');
                localStorage.setItem('slp_dark', d ? '0' : '1');
            },
            logout() { localStorage.clear(); location.reload(); }
        };

        core.init();
        window.onfocus = () => core.updateOnline(true);
        window.onblur = () => core.updateOnline(false);
    </script>
</body>
</html>
