<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sleep Messenger | Core</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --tg-blue: #24A1DE;
            --tg-bg: #ffffff;
            --tg-text: #000000;
            --tg-muted: #8e8e93;
            --tg-border: #f2f2f2;
            --tg-light-blue: #eff7ff;
            --safe-t: env(safe-area-inset-top);
            --safe-b: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; width: 100%; background: var(--tg-bg); color: var(--tg-text); overflow: hidden; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .view { position: fixed; inset: 0; background: var(--tg-bg); display: none; flex-direction: column; z-index: 10; }
        .view.active { display: flex; }
        .sub-view { position: fixed; inset: 0; background: var(--tg-bg); transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0, 0.2, 1); z-index: 1000; display: flex; flex-direction: column; }
        .sub-view.show { transform: translateX(0); }

        /* –®–∞–ø–∫–∞ */
        header { padding-top: var(--safe-t); background: var(--tg-bg); display: flex; align-items: center; height: calc(60px + var(--safe-t)); padding-left: 16px; padding-right: 16px; border-bottom: 0.5px solid var(--tg-border); justify-content: space-between; flex-shrink: 0; }
        .h-title { font-size: 20px; font-weight: 700; color: var(--tg-blue); letter-spacing: -0.3px; }
        .h-icons { display: flex; gap: 18px; align-items: center; }
        .h-btn { font-size: 22px; color: #555; cursor: pointer; border: none; background: none; }

        /* –≠–∫—Ä–∞–Ω –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è (–í–º–µ—Å—Ç–æ —á–∞—Ç–æ–≤) */
        .welcome-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; }
        .welcome-logo { width: 120px; height: 120px; background: var(--tg-blue); border-radius: 40px; display: flex; align-items: center; justify-content: center; font-size: 60px; color: white; box-shadow: 0 10px 30px rgba(36, 161, 222, 0.3); margin-bottom: 25px; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .welcome-screen h1 { font-size: 26px; font-weight: 800; margin-bottom: 10px; color: #333; }
        .welcome-screen p { color: var(--tg-muted); font-size: 15px; line-height: 1.5; max-width: 250px; }

        /* –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (Pixel Perfect) */
        nav { height: calc(65px + var(--safe-b)); background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-top: 0.5px solid var(--tg-border); display: flex; position: fixed; bottom: 0; width: 100%; padding-bottom: var(--safe-b); z-index: 500; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--tg-muted); gap: 3px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--tg-blue); }
        .nav-item i { font-size: 22px; font-style: normal; }
        .nav-item span { font-size: 11px; font-weight: 500; }
        .nav-badge { position: absolute; top: 8px; right: 28%; background: #ff3b30; color: #fff; font-size: 10px; min-width: 17px; height: 17px; border-radius: 9px; display: flex; align-items: center; justify-content: center; border: 2.5px solid #fff; font-weight: bold; }

        /* –°–ø–∏—Å–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ */
        .content-scroll { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .list-item { display: flex; padding: 12px 16px; align-items: center; gap: 15px; border-bottom: 0.5px solid var(--tg-border); cursor: pointer; }
        .list-item:active { background: #f5f5f5; }
        .icon-box { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }
        .item-text { flex: 1; font-size: 16px; font-weight: 500; }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .profile-card { padding: 30px 16px; text-align: center; border-bottom: 10px solid #f2f2f2; }
        .big-avatar { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #24A1DE, #1a7fb3); margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 40px; color: white; font-weight: bold; position: relative; }
        .edit-av { position: absolute; bottom: 0; right: 0; width: 30px; height: 30px; background: #fff; border-radius: 50%; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 14px; }

        /* –ó–≤–æ–Ω–∫–∏ */
        #call-ui { position: fixed; inset: 0; background: #1c1c1e; z-index: 10000; display: none; flex-direction: column; color: white; }
        .video-container { flex: 1; position: relative; background: #000; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; top: 40px; right: 20px; width: 100px; height: 150px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.3); object-fit: cover; }
        .call-meta { position: absolute; top: 50px; left: 0; width: 100%; text-align: center; }
        .call-ctrl { height: 150px; display: flex; justify-content: center; align-items: center; gap: 25px; padding-bottom: 30px; }
        .btn-call { width: 65px; height: 65px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer; }
        .btn-hangup { background: #ff3b30; box-shadow: 0 0 20px rgba(255,59,48,0.5); }
        .btn-mute { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); }

        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        #auth-screen { position: fixed; inset: 0; z-index: 9000; background: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .auth-input { width: 100%; max-width: 300px; padding: 15px; border: 1px solid #ddd; border-radius: 12px; margin-bottom: 15px; font-size: 16px; text-align: center; }
        .auth-btn { width: 100%; max-width: 300px; padding: 15px; background: var(--tg-blue); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; }

        /* –£—Ç–∏–ª–∏—Ç—ã */
        .badge-count { background: var(--tg-blue); color: #fff; font-size: 12px; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="welcome-logo">‚òÅÔ∏è</div>
        <h2 style="margin-bottom: 30px;">Welcome to Sleep</h2>
        <input type="text" id="auth-name" class="auth-input" placeholder="–ò–º—è –ø—Ä–æ—Ñ–∏–ª—è">
        <input type="text" id="auth-user" class="auth-input" placeholder="@username">
        <button class="auth-btn" onclick="Core.login()">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
    </div>

    <div id="view-chats" class="view active">
        <header>
            <div class="h-title">Sleep Messenger</div>
            <div class="h-icons">
                <button class="h-btn" onclick="Core.toggleSub('search')">üîç</button>
                <button class="h-btn">‚ãÆ</button>
            </div>
        </header>
        <div class="welcome-screen">
            <div class="welcome-logo">üíé</div>
            <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
            <p>–ù–∞—á–Ω–∏—Ç–µ –ø–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —á–∞—Ç.</p>
        </div>
    </div>

    <div id="view-contacts" class="view">
        <header><div class="h-title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div><button class="h-btn" onclick="Core.toggleSub('search')">‚ûï</button></header>
        <div class="content-scroll" id="contacts-list">
            <div style="padding: 20px; text-align: center; color: var(--tg-muted);">–°–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø—É—Å—Ç</div>
        </div>
    </div>

    <div id="view-settings" class="view">
        <header><div class="h-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div></header>
        <div class="content-scroll">
            <div class="profile-card">
                <div class="big-avatar" id="set-avatar">?</div>
                <h2 id="set-name">User Name</h2>
                <p id="set-user" style="color: var(--tg-muted);">@username</p>
            </div>
            <div class="list-item">
                <div class="icon-box" style="background: #ff9500;">üîî</div>
                <div class="item-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –∑–≤—É–∫–∏</div>
            </div>
            <div class="list-item">
                <div class="icon-box" style="background: #34c759;">üîê</div>
                <div class="item-text">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</div>
            </div>
            <div class="list-item">
                <div class="icon-box" style="background: #5856d6;">üíæ</div>
                <div class="item-text">–î–∞–Ω–Ω—ã–µ –∏ –ø–∞–º—è—Ç—å</div>
            </div>
            <div class="list-item" onclick="Core.logout()" style="margin-top: 20px;">
                <div class="icon-box" style="background: #ff3b30;">üö™</div>
                <div class="item-text" style="color: #ff3b30;">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</div>
            </div>
        </div>
    </div>

    <div id="view-profile" class="view">
        <header><div class="h-title">–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</div></header>
        <div class="content-scroll">
            <div class="profile-card">
                <div class="big-avatar" id="prof-avatar">? <div class="edit-av">üì∑</div></div>
                <div style="background: #f9f9f9; border-radius: 15px; padding: 20px; text-align: left;">
                    <small style="color: var(--tg-blue); font-weight: 700;">–û –°–ï–ë–ï</small>
                    <p style="margin-top: 5px; font-size: 16px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Sleep Messenger. –°—Ç–∞—Ç—É—Å: Online</p>
                </div>
            </div>
        </div>
    </div>

    <div id="sub-search" class="sub-view">
        <header>
            <button class="h-btn" onclick="Core.toggleSub('search')">‚Üê</button>
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ @username" style="flex:1; border:none; padding:10px; font-size:16px;" oninput="Core.search()">
        </header>
        <div class="content-scroll" id="search-results"></div>
    </div>

    <div id="call-ui">
        <div class="video-container">
            <video id="remoteVideo" autoplay playsinline></video>
            <video id="localVideo" autoplay playsinline muted></video>
            <div class="call-meta">
                <h2 id="call-target-name">User</h2>
                <p id="call-timer">00:00</p>
            </div>
        </div>
        <div class="call-ctrl">
            <div class="btn-call btn-mute" onclick="Core.toggleMic()">üéôÔ∏è</div>
            <div class="btn-call btn-hangup" onclick="Core.endCall()">üìµ</div>
            <div class="btn-call btn-mute" onclick="Core.toggleCam()">üìπ</div>
        </div>
    </div>

    <nav id="bottom-nav">
        <div class="nav-item active" onclick="Core.switchView('chats', this)">
            <i>üí¨</i><span>–ß–∞—Ç—ã</span>
            <div class="nav-badge">1</div>
        </div>
        <div class="nav-item" onclick="Core.switchView('contacts', this)">
            <i>üë§</i><span>–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
            <div class="nav-badge">!</div>
        </div>
        <div class="nav-item" onclick="Core.switchView('settings', this)">
            <i>‚öôÔ∏è</i><span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </div>
        <div class="nav-item" onclick="Core.switchView('profile', this)">
            <i>üë§</i><span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </div>
    </nav>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
            authDomain: "sleep-menager.firebaseapp.com",
            databaseURL: "https://sleep-menager-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const Core = {
            user: JSON.parse(localStorage.getItem('sleep_user')),
            pc: null,
            localStream: null,

            init() {
                if(this.user) {
                    document.getElementById('auth-screen').style.display = 'none';
                    this.updateUI();
                    this.listenIncoming();
                    this.syncContacts();
                }
            },

            login() {
                const n = document.getElementById('auth-name').value;
                const u = document.getElementById('auth-user').value.toLowerCase().replace('@','');
                if(!n || !u) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
                
                this.user = { name: n, username: '@' + u };
                db.ref('users/' + u).set(this.user);
                localStorage.setItem('sleep_user', JSON.stringify(this.user));
                location.reload();
            },

            updateUI() {
                const n = this.user.name;
                document.getElementById('set-name').innerText = n;
                document.getElementById('set-user').innerText = this.user.username;
                document.getElementById('set-avatar').innerText = n[0];
                document.getElementById('prof-avatar').firstChild.textContent = n[0];
            },

            switchView(viewId, el) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById('view-' + viewId).classList.add('active');
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            },

            toggleSub(id) {
                document.getElementById('sub-' + id).classList.toggle('show');
            },

            search() {
                const q = document.getElementById('search-input').value.toLowerCase().replace('@','');
                if(q.length < 2) return;
                
                db.ref('users').orderByKey().startAt(q).endAt(q + "\uf8ff").once('value', snap => {
                    const res = document.getElementById('search-results');
                    res.innerHTML = '';
                    snap.forEach(child => {
                        const u = child.val();
                        if(u.username !== this.user.username) {
                            res.innerHTML += `
                                <div class="list-item" onclick="Core.addContact('${u.username}', '${u.name}')">
                                    <div class="av" style="width:40px; height:40px; border-radius:50%; background:var(--tg-blue); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold;">${u.name[0]}</div>
                                    <div class="item-text"><b>${u.name}</b><br><small style="color:gray">${u.username}</small></div>
                                    <button style="border:none; color:var(--tg-blue); background:none; font-weight:700">–î–û–ë–ê–í–ò–¢–¨</button>
                                </div>`;
                        }
                    });
                });
            },

            addContact(u, n) {
                const myId = this.user.username.replace('@','');
                db.ref(`contacts/${myId}/${u.replace('@','')}`).set({ name: n, username: u });
                this.toggleSub('search');
                alert("–ö–æ–Ω—Ç–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω!");
            },

            syncContacts() {
                const myId = this.user.username.replace('@','');
                db.ref(`contacts/${myId}`).on('value', snap => {
                    const list = document.getElementById('contacts-list');
                    list.innerHTML = '';
                    if(!snap.exists()) {
                        list.innerHTML = '<div style="padding:20px; text-align:center; color:gray;">–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>';
                        return;
                    }
                    snap.forEach(child => {
                        const c = child.val();
                        list.innerHTML += `
                            <div class="list-item" onclick="Core.startCall('${c.username}', '${c.name}')">
                                <div class="av" style="width:45px; height:45px; border-radius:50%; background:#eee; color:#333; display:flex; align-items:center; justify-content:center; font-weight:bold;">${c.name[0]}</div>
                                <div class="item-text"><b>${c.name}</b></div>
                                <div style="color:var(--tg-blue); font-size:20px;">üìû</div>
                            </div>`;
                    });
                });
            },

            // --- WebRTC –°–ò–°–¢–ï–ú–ê –ó–í–û–ù–ö–û–í ---
            async startCall(targetUser, targetName) {
                document.getElementById('call-ui').style.display = 'flex';
                document.getElementById('call-target-name').innerText = targetName;
                
                const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                this.localStream = stream;
                document.getElementById('localVideo').srcObject = stream;

                this.pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                stream.getTracks().forEach(t => this.pc.addTrack(t, stream));

                this.pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];

                const callId = [this.user.username, targetUser].sort().join('_').replace(/@/g,'');
                const callRef = db.ref('calls/' + callId);

                this.pc.onicecandidate = e => e.candidate && callRef.child('candidates').push(e.candidate.toJSON());

                const offer = await this.pc.createOffer();
                await this.pc.setLocalDescription(offer);

                callRef.set({
                    offer: { type: offer.type, sdp: offer.sdp },
                    from: this.user.username,
                    fromName: this.user.name
                });

                callRef.on('value', async snap => {
                    const data = snap.val();
                    if(data && data.answer && !this.pc.currentRemoteDescription) {
                        await this.pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                    if(!data && this.pc) this.endCall(false);
                });

                callRef.child('candidates').on('child_added', snap => {
                    if(this.pc.remoteDescription) this.pc.addIceCandidate(new RTCIceCandidate(snap.val()));
                });
            },

            listenIncoming() {
                const myId = this.user.username.replace('@','');
                db.ref('calls').on('child_added', async snap => {
                    const data = snap.val();
                    if(data.from !== this.user.username && snap.key.includes(myId)) {
                        if(confirm("–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç " + data.fromName)) {
                            this.acceptCall(snap.key, data);
                        } else {
                            db.ref('calls/' + snap.key).remove();
                        }
                    }
                });
            },

            async acceptCall(callId, data) {
                document.getElementById('call-ui').style.display = 'flex';
                document.getElementById('call-target-name').innerText = data.fromName;

                const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
                this.localStream = stream;
                document.getElementById('localVideo').srcObject = stream;

                this.pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                stream.getTracks().forEach(t => this.pc.addTrack(t, stream));
                this.pc.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];

                const callRef = db.ref('calls/' + callId);
                this.pc.onicecandidate = e => e.candidate && callRef.child('candidates').push(e.candidate.toJSON());

                await this.pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await this.pc.createAnswer();
                await this.pc.setLocalDescription(answer);

                callRef.update({ answer: { type: answer.type, sdp: answer.sdp } });

                callRef.child('candidates').on('child_added', snap => {
                    this.pc.addIceCandidate(new RTCIceCandidate(snap.val()));
                });
            },

            endCall(notify = true) {
                if(this.localStream) this.localStream.getTracks().forEach(t => t.stop());
                if(this.pc) this.pc.close();
                document.getElementById('call-ui').style.display = 'none';
                if(notify) db.ref('calls').once('value', s => {
                    s.forEach(c => { if(c.key.includes(this.user.username.replace('@',''))) c.ref.remove(); });
                });
            },

            toggleMic() {
                const t = this.localStream.getAudioTracks()[0];
                t.enabled = !t.enabled;
            },

            toggleCam() {
                const t = this.localStream.getVideoTracks()[0];
                t.enabled = !t.enabled;
            },

            logout() {
                localStorage.clear();
                location.reload();
            }
        };

        Core.init();
    </script>
</body>
        </html>
