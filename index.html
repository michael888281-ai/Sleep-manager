<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sleep Manager Ultimate</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --blue: #0088cc; --light-blue: #eff7ff; --bg: #ffffff;
            --text: #222; --gray: #8e8e93; --out: #effdde; --premium: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%, #fad0c4 100%);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, system-ui, sans-serif; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); overflow: hidden; }

        /* AUTH SCREEN */
        #auth { position: fixed; inset: 0; background: #fff; z-index: 5000; display: flex; align-items: center; justify-content: center; padding: 30px; }
        .auth-card { width: 100%; max-width: 350px; text-align: center; }
        .auth-card input { width: 100%; padding: 15px; border: 1.5px solid #eee; border-radius: 12px; margin-bottom: 10px; font-size: 16px; transition: 0.3s; }
        .auth-card input:focus { border-color: var(--blue); }
        .btn-blue { width: 100%; padding: 15px; background: var(--blue); color: #fff; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }

        /* MAIN APP */
        .app-grid { display: none; flex-direction: column; height: 100vh; }
        header { padding: 10px 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #f2f2f2; background: #fff; }
        .search-wrap { flex: 1; background: #f1f1f2; border-radius: 10px; padding: 8px 12px; display: flex; align-items: center; }
        .search-wrap input { background: none; border: none; width: 100%; outline: none; margin-left: 8px; }

        /* STORIES */
        .stories { display: flex; gap: 12px; padding: 15px; overflow-x: auto; background: #fff; border-bottom: 1px solid #f2f2f2; }
        .st-item { min-width: 65px; height: 65px; border-radius: 50%; border: 2.5px solid var(--blue); padding: 2px; flex-shrink: 0; cursor: pointer; }
        .st-inner { width: 100%; height: 100%; border-radius: 50%; background: #eee; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .st-inner img { width: 100%; height: 100%; object-fit: cover; }

        /* CHAT LIST */
        .content { flex: 1; overflow-y: auto; background: #fff; }
        .chat-row { display: flex; padding: 12px 15px; gap: 15px; align-items: center; border-bottom: 0.5px solid #f2f2f2; cursor: pointer; }
        .chat-row:active { background: #f5f5f5; }
        .ava { width: 54px; height: 54px; border-radius: 50%; background: var(--blue); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; position: relative; }
        .premium-border { border: 2px solid #e1bee7; box-shadow: 0 0 10px rgba(225, 190, 231, 0.5); }
        .crown { position: absolute; top: -5px; right: -5px; font-size: 14px; }

        /* CHAT WINDOW */
        #chat-win { position: fixed; inset: 0; background: #fff; z-index: 4000; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        #chat-win.open { transform: translateX(0); }
        .win-head { padding: 10px 15px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #f2f2f2; background: #fff; }
        #msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; background: #e7ebf0; }
        .msg-b { padding: 8px 12px; border-radius: 12px; max-width: 80%; font-size: 15px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg-b.in { background: #fff; align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg-b.out { background: var(--out); align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg-img { width: 100%; border-radius: 8px; margin: 5px 0; }
        .msg-audio { display: flex; align-items: center; gap: 10px; padding: 5px 0; }

        /* INPUT PANEL */
        .inp-pan { padding: 10px; display: flex; align-items: center; gap: 12px; background: #fff; border-top: 1px solid #f2f2f2; }
        .inp-pan input { flex: 1; padding: 10px 15px; border: none; background: #f1f1f2; border-radius: 20px; outline: none; }
        .icon { font-size: 24px; cursor: pointer; color: var(--blue); transition: 0.2s; }
        .icon:active { transform: scale(0.9); }
        .rec-pulse { color: #f44336; animation: pulse 1s infinite; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-body { background: #fff; width: 100%; max-width: 320px; border-radius: 20px; padding: 25px; text-align: center; }

        /* NAV */
        nav { display: flex; justify-content: space-around; padding: 10px; background: #fff; border-top: 1px solid #f2f2f2; }
        .tab { text-align: center; font-size: 11px; color: var(--gray); cursor: pointer; }
        .tab.active { color: var(--blue); }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="auth">
        <div class="auth-card">
            <h1 style="color:var(--blue); margin-bottom:5px;">Sleep Manager</h1>
            <p style="color:var(--gray); margin-bottom:25px;">–ó–∞–π–º–∏ —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π @—é–∑–µ—Ä</p>
            <input type="text" id="a-nick" placeholder="–¢–≤–æ–µ –∏–º—è">
            <input type="text" id="a-user" placeholder="@username (–∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –±—É–∫–≤—ã)">
            <p id="a-err" style="color:red; font-size:12px; display:none; margin-bottom:10px;">–≠—Ç–æ—Ç @—é–∑–µ—Ä —É–∂–µ –∑–∞–Ω—è—Ç!</p>
            <button class="btn-blue" onclick="tryAuth()">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
        </div>
    </div>

    <div class="app-grid" id="app">
        <header>
            <div class="icon" onclick="openProfile()">‚ò∞</div>
            <div class="search-wrap">
                <span>üîç</span>
                <input type="text" id="search-in" placeholder="–ü–æ–∏—Å–∫ –ø–æ @—é–∑–µ—Ä—É..." oninput="searchUsers()">
            </div>
        </header>

        <div class="stories">
            <div class="st-item" onclick="postStory()" style="border-style:dashed; border-color:var(--gray);">
                <div class="st-inner" style="color:var(--gray)">+</div>
            </div>
            <div id="st-list" style="display:flex; gap:10px"></div>
        </div>

        <div class="content">
            <div class="chat-row" onclick="openRoom('global', '–û–±—â–∏–π —á–∞—Ç')">
                <div class="ava">üåç</div>
                <div style="flex:1">
                    <div style="font-weight:bold">–û–±—â–∏–π —á–∞—Ç</div>
                    <div style="font-size:13px; color:var(--gray)">–ó–∞–π–¥–∏ –∏ –ø–æ–∑–Ω–∞–∫–æ–º—å—Å—è</div>
                </div>
            </div>
            <div id="chat-list-dyn"></div>
        </div>

        <nav>
            <div class="tab active" onclick="location.reload()">üí¨<br>–ß–∞—Ç—ã</div>
            <div class="tab" onclick="openModal('group-mod')">üë•<br>–ì—Ä—É–ø–ø—ã</div>
            <div class="tab" onclick="openModal('prem-mod')">üíé<br>–ü—Ä–µ–º–∏—É–º</div>
        </nav>
    </div>

    <div id="chat-win">
        <div class="win-head">
            <div class="icon" onclick="closeRoom()">‚Üê</div>
            <div id="win-title" style="font-weight:bold; flex:1">–ß–∞—Ç</div>
            <div class="icon" onclick="alert('–ó–≤–æ–Ω–æ–∫...')">üìû</div>
        </div>
        <div id="msgs"></div>
        <div class="inp-pan">
            <div class="icon" onclick="sendMedia('img')">üñºÔ∏è</div>
            <div class="icon" onclick="sendMedia('stick')">üé≠</div>
            <input type="text" id="m-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <div class="icon" id="mic" onmousedown="startVoice()" onmouseup="stopVoice()" ontouchstart="startVoice()" ontouchend="stopVoice()">üéôÔ∏è</div>
            <div class="icon" onclick="sendMsg()">‚û§</div>
        </div>
    </div>

    <div class="modal" id="group-mod" onclick="closeModals()">
        <div class="modal-body" onclick="event.stopPropagation()">
            <h3>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h3>
            <input type="text" id="g-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #eee;">
            <button class="btn-blue" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <div class="modal" id="prem-mod" onclick="closeModals()">
        <div class="modal-body" onclick="event.stopPropagation()">
            <h2 style="color:#9c27b0">Sleep Premium üíé</h2>
            <p style="font-size:14px; color:var(--gray)">–ö–æ—Ä–æ–Ω–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ, –ì–° –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ –∑–æ–ª–æ—Ç–æ–π —Å—Ç–∞—Ç—É—Å.</p>
            <button class="btn-blue" style="background:#9c27b0" onclick="buyPremium()">–ö—É–ø–∏—Ç—å –∑–∞ 0.00$</button>
        </div>
    </div>

    <script>
        const cfg = {
            apiKey: "AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
            authDomain: "sleep-menager.firebaseapp.com",
            projectId: "sleep-menager",
            storageBucket: "sleep-menager.firebasestorage.app",
            messagingSenderId: "3927631074",
            appId: "1:3927631074:web:a3a604c7147e31a900eabb",
            databaseURL: "https://sleep-menager-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(cfg);
        const db = firebase.database();

        let me = JSON.parse(localStorage.getItem('sm_me'));
        let activeId = "";
        let recorder;
        let chunks = [];

        if(me) {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            startApp();
        }

        async function tryAuth() {
            const nick = document.getElementById('a-nick').value.trim();
            const user = document.getElementById('a-user').value.trim().toLowerCase().replace('@','');
            if(!nick || !user) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å—ë!");

            const snap = await db.ref('users/' + user).once('value');
            if(snap.exists()) return document.getElementById('a-err').style.display = 'block';

            me = { nick, user: '@'+user, prem: false };
            await db.ref('users/' + user).set(me);
            localStorage.setItem('sm_me', JSON.stringify(me));
            location.reload();
        }

        function startApp() {
            loadStories();
            loadGroups();
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }

        function openRoom(id, title) {
            activeId = id;
            document.getElementById('win-title').innerText = title;
            document.getElementById('chat-win').classList.add('open');
            syncMsgs();
        }
        function closeRoom() { document.getElementById('chat-win').classList.remove('open'); }

        function sendMsg(audio = null, img = null) {
            const input = document.getElementById('m-in');
            if(!input.value && !audio && !img) return;
            db.ref('msgs/' + activeId).push({
                u: me.nick, usr: me.user, p: me.prem,
                m: input.value, a: audio, i: img,
                t: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            });
            input.value = "";
        }

        function syncMsgs() {
            db.ref('msgs/' + activeId).on('value', s => {
                const box = document.getElementById('msgs');
                box.innerHTML = "";
                s.forEach(c => {
                    const d = c.val();
                    const isMe = d.usr === me.user;
                    let body = d.m ? `<div>${d.m}</div>` : "";
                    if(d.i) body = `<img class="msg-img" src="${d.i}">`;
                    if(d.a) body = `<div class="msg-audio" onclick="new Audio('${d.a}').play()"><span>‚ñ∂</span> <b>–ì–æ–ª–æ—Å–æ–≤–æ–µ</b></div>`;
                    
                    box.innerHTML += `
                        <div class="msg-b ${isMe?'out':'in'}">
                            ${!isMe ? `<small style="color:var(--blue); font-weight:bold">${d.u} ${d.p?'üíé':''}</small>` : ''}
                            ${body}
                            <div style="font-size:9px; opacity:0.4; text-align:right">${d.t}</div>
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        async function startVoice() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({audio:true});
                recorder = new MediaRecorder(s);
                chunks = [];
                document.getElementById('mic').classList.add('rec-pulse');
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(chunks, {type:'audio/webm'});
                    const r = new FileReader();
                    r.readAsDataURL(blob);
                    r.onloadend = () => sendMsg(r.result);
                };
                recorder.start();
            } catch(e) { alert("–î–∞–π –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ!"); }
        }
        function stopVoice() { if(recorder) { recorder.stop(); document.getElementById('mic').classList.remove('rec-pulse'); } }

        function sendMedia(type) {
            const url = prompt(type === 'img' ? "–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ:" : "–°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç–∏–∫–µ—Ä (GIF/PNG):");
            if(url) sendMsg(null, url);
        }

        function postStory() {
            const url = prompt("–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É —Å—Ç–æ—Ä–∏—Å:");
            if(url) db.ref('stories').push({ u: me.nick, i: url, ts: Date.now() });
        }

        function loadStories() {
            db.ref('stories').on('value', s => {
                const l = document.getElementById('st-list'); l.innerHTML = "";
                s.forEach(c => {
                    l.innerHTML += `<div class="st-item" onclick="alert('–ò—Å—Ç–æ—Ä–∏—è –æ—Ç ${c.val().u}')"><div class="st-inner"><img src="${c.val().i}"></div></div>`;
                });
            });
        }

        function createGroup() {
            const name = document.getElementById('g-name').value.trim();
            if(name) {
                db.ref('groups').push({ name, owner: me.user });
                closeModals();
            }
        }

        function loadGroups() {
            db.ref('groups').on('value', s => {
                const list = document.getElementById('chat-list-dyn'); list.innerHTML = "";
                s.forEach(c => {
                    const d = c.val();
                    list.innerHTML += `
                        <div class="chat-row" onclick="openRoom('${c.key}', '${d.name}')">
                            <div class="ava">${d.name[0]}</div>
                            <div style="flex:1"><div style="font-weight:bold">${d.name}</div><div style="font-size:12px; color:var(--gray)">–ì—Ä—É–ø–ø–∞</div></div>
                        </div>`;
                });
            });
        }

        function searchUsers() {
            const q = document.getElementById('search-in').value.toLowerCase().replace('@','');
            if(q.length < 2) return;
            db.ref('users').orderByKey().startAt(q).endAt(q+"\uf8ff").once('value', s => {
                const list = document.getElementById('chat-list-dyn');
                list.innerHTML = "<div style='padding:10px; font-size:12px; color:var(--blue)'>–õ—é–¥–∏:</div>";
                s.forEach(c => {
                    const u = c.val();
                    if(u.user !== me.user) {
                        list.innerHTML += `
                        <div class="chat-row" onclick="openRoom('priv_${u.user.replace('@','')}', '${u.nick}')">
                            <div class="ava ${u.prem?'premium-border':''}">${u.nick[0]}${u.prem?'<span class="crown">üëë</span>':''}</div>
                            <div style="flex:1"><b>${u.nick}</b><br><small>${u.user}</small></div>
                        </div>`;
                    }
                });
            });
        }

        function buyPremium() {
            me.prem = true;
            localStorage.setItem('sm_me', JSON.stringify(me));
            db.ref('users/' + me.user.replace('@','')).update({prem: true});
            alert("–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –¢—ã —Ç–µ–ø–µ—Ä—å –ü—Ä–µ–º–∏—É–º üíé");
            location.reload();
        }

        function openProfile() {
            alert(`–¢–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å:\n–ò–º—è: ${me.nick}\n–Æ–∑–µ—Ä: ${me.user}\n–°—Ç–∞—Ç—É—Å: ${me.prem ? 'PREMIUM üíé' : '–û–±—ã—á–Ω—ã–π'}`);
        }

        document.getElementById('m-in').onkeydown = e => { if(e.key === 'Enter') sendMsg(); };
    </script>
</body>
</html>
