<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sleep God Mode</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --accent: #0088cc; --bg: #f0f2f5; --card: #ffffff; --text: #000000;
            --sub: #8e8e93; --border: #e5e5ea; --msg-in: #ffffff; --msg-out: #effdde;
            --ghost: #9c27b0; --danger: #ff3b30; --tg-green: #34c759;
            --panel: rgba(255, 255, 255, 0.85);
            --chat-bg: #e5ddd5 url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
        }

        body.dark {
            --bg: #0e1621; --card: #17212b; --text: #ffffff; --sub: #8b949e;
            --accent: #2b5278; --border: #0b1118; --msg-in: #182533; --msg-out: #2b5278;
            --panel: rgba(23, 33, 43, 0.9);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; transition: 0.3s cubic-bezier(0.1, 0.7, 0.1, 1); }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }

        /* SCREENS */
        .screen { position: fixed; inset: 0; background: var(--bg); z-index: 1000; transform: translateX(100%); display: flex; flex-direction: column; visibility: hidden; }
        .screen.active { transform: translateX(0); visibility: visible; }
        .screen.bottom { transform: translateY(100%); }
        .screen.bottom.active { transform: translateY(0); }

        /* HEADER */
        header { height: 65px; background: var(--panel); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px; position: sticky; top: 0; z-index: 500; }
        .h-title { flex: 1; font-size: 24px; font-weight: 900; background: linear-gradient(45deg, var(--accent), #9c27b0); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .h-ico { font-size: 24px; color: var(--sub); cursor: pointer; margin-left: 20px; }
        .h-ico.active { color: var(--ghost); filter: drop-shadow(0 0 5px var(--ghost)); }

        /* STORIES */
        .st-bar { display: flex; overflow-x: auto; padding: 15px; gap: 15px; background: var(--card); border-bottom: 1px solid var(--border); scrollbar-width: none; }
        .st-bar::-webkit-scrollbar { display: none; }
        .st-item { flex-shrink: 0; width: 68px; text-align: center; font-size: 11px; font-weight: 600; }
        .st-ring { width: 64px; height: 64px; border-radius: 22px; border: 2.5px solid var(--accent); padding: 2px; margin-bottom: 5px; position: relative; }
        .st-ring img { width: 100%; height: 100%; border-radius: 18px; object-fit: cover; }
        .st-add { position: absolute; bottom: -2px; right: -2px; width: 22px; height: 22px; background: var(--accent); color: white; border: 2px solid var(--card); border-radius: 50%; font-weight: bold; }

        /* PLACARDS */
        .p-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; }
        .placard { padding: 15px; border-radius: 20px; background: #fff !important; color: #000 !important; box-shadow: 0 5px 15px rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; gap: 10px; border: 1px solid rgba(0,0,0,0.02); }
        .p-ico { font-size: 22px; width: 40px; height: 40px; background: #f0f7ff; border-radius: 12px; display: flex; align-items: center; justify-content: center; }

        /* CHATS */
        #chat-list { flex: 1; overflow-y: auto; background: var(--card); }
        .chat-card { display: flex; padding: 12px 15px; gap: 12px; border-bottom: 0.5px solid var(--border); cursor: pointer; }
        .ava { width: 54px; height: 54px; border-radius: 20px; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; flex-shrink: 0; }
        .c-main { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .c-row { display: flex; justify-content: space-between; align-items: center; }
        .c-name { font-weight: 700; font-size: 17px; }
        .c-msg { font-size: 14px; color: var(--sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* CHAT ENGINE */
        #msg-engine { flex: 1; overflow-y: auto; padding: 15px; background: var(--chat-bg); background-size: cover; display: flex; flex-direction: column; gap: 8px; }
        .bubble { padding: 10px 14px; border-radius: 18px; max-width: 80%; font-size: 16px; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .bubble.in { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 4px; }
        .bubble.out { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 4px; }
        .v-msg { display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 14px; }

        /* INPUT */
        .input-bar { background: var(--panel); backdrop-filter: blur(15px); padding: 10px 15px 30px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .field { flex: 1; background: var(--bg); border-radius: 20px; padding: 10px 15px; border: 1px solid var(--border); color: var(--text); font-size: 16px; max-height: 100px; resize: none; }
        .send-btn { width: 44px; height: 44px; background: var(--accent); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* CALL UI */
        #call-screen { background: #000; z-index: 5000; }
        #remote-vid { width: 100%; height: 100%; object-fit: cover; }
        #local-vid { position: absolute; top: 30px; right: 20px; width: 100px; height: 140px; border-radius: 15px; border: 2px solid #fff; object-fit: cover; z-index: 10; }
        .call-controls { position: absolute; bottom: 60px; left: 0; right: 0; display: flex; justify-content: center; gap: 40px; }
        .btn-hangup { width: 70px; height: 70px; background: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: white; cursor: pointer; box-shadow: 0 0 20px rgba(255,59,48,0.5); }

        footer { height: 75px; background: var(--panel); border-top: 1px solid var(--border); display: flex; padding-bottom: 15px; position: fixed; bottom: 0; width: 100%; }
        .tab { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; color: var(--sub); cursor: pointer; font-weight: bold; }
        .tab.active { color: var(--accent); }
        .tab b { font-size: 24px; margin-bottom: 2px; }

        /* BOT BUILDER */
        .bot-card { background: var(--card); margin: 15px; padding: 20px; border-radius: 20px; border: 1.5px dashed var(--accent); }

        #auth-layer { position: fixed; inset: 0; background: var(--card); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; }
    </style>
</head>
<body>

    <div id="auth-layer">
        <div class="auth-logo">üí§</div>
        <h1 style="margin:0;">Sleep God Mode</h1>
        <p style="color:var(--sub); margin-bottom:30px;">–í—Ö–æ–¥ –≤ –≥–∏–ø–µ—Ä-–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</p>
        <input type="text" id="reg-n" class="field" style="width:100%; max-width:300px; margin-bottom:10px;" placeholder="–í–∞—à–µ –∏–º—è">
        <input type="text" id="reg-u" class="field" style="width:100%; max-width:300px; margin-bottom:20px;" placeholder="@username">
        <button class="send-btn" style="width:100%; max-width:300px; border-radius:15px; font-weight:bold;" onclick="god.reg()">–ù–∞—á–∞—Ç—å</button>
    </div>

    <header>
        <div class="h-title">Sleep</div>
        <div class="h-ico" id="ghost-trigger" onclick="god.toggleGhost()">üëª</div>
        <div class="h-ico" onclick="god.open('scr-search')">üîç</div>
    </header>

    <div id="main-view" style="flex:1; overflow-y:auto; padding-bottom:100px;">
        <div class="st-bar">
            <div class="st-item" onclick="document.getElementById('st-file').click()">
                <div class="st-ring" style="border-color:var(--border);"><div class="st-add">+</div><img src="https://via.placeholder.com/150" id="my-st-thumb"></div>
                –ú–æ—è –∏—Å—Ç–æ—Ä–∏—è
                <input type="file" id="st-file" hidden onchange="god.upStory(this)">
            </div>
            <div id="st-feed" style="display:flex; gap:15px;"></div>
        </div>

        <div class="p-grid">
            <div class="placard" onclick="god.open('scr-new-chan')">
                <div class="p-ico">üõ∞Ô∏è</div>
                <b>–ö–∞–Ω–∞–ª</b>
            </div>
            <div class="placard" onclick="god.open('scr-bot')">
                <div class="p-ico">ü§ñ</div>
                <b>–ë–æ—Ç</b>
            </div>
        </div>

        <div id="chat-list"></div>
    </div>

    <footer>
        <div class="tab active" onclick="god.home()"><b>üí¨</b>–ß–∞—Ç—ã</div>
        <div class="tab" onclick="god.open('scr-settings')"><b>‚öôÔ∏è</b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    </footer>

    <div id="scr-chat" class="screen">
        <header>
            <div class="h-ico" style="margin:0 15px 0 0;" onclick="god.home()">‚Üê</div>
            <div class="ava" id="v-ava" style="width:40px; height:40px; font-size:16px;">?</div>
            <div style="flex:1; margin-left:12px;">
                <div id="v-name" style="font-weight:700;">Username</div>
                <div id="v-stat" style="font-size:11px; color:var(--tg-green);">–æ–Ω–ª–∞–π–Ω</div>
            </div>
            <div class="h-ico" onclick="god.call(true)">üìû</div>
        </header>
        <div id="msg-engine"></div>
        <div class="input-bar">
            <div class="h-ico" style="margin:0 5px 0 0;">üìé<input type="file" hidden onchange="god.sendImg(this)"></div>
            <textarea id="f-text" class="field" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
            <div class="h-ico" id="mic-trigger" onclick="god.toggleGS()">üé§</div>
            <div class="send-btn" onclick="god.send()">‚û§</div>
        </div>
    </div>

    <div id="scr-call" class="screen bottom">
        <video id="remote-vid" autoplay playsinline></video>
        <video id="local-vid" autoplay playsinline muted></video>
        <div id="call-status" style="position:absolute; top:100px; width:100%; text-align:center; color:white; font-size:20px;">–í—ã–∑–æ–≤...</div>
        <div class="call-controls">
            <div class="btn-hangup" onclick="god.endCall()">üìû</div>
        </div>
    </div>

    <div id="scr-bot" class="screen bottom">
        <header><div class="h-ico" onclick="god.home()">‚úï</div><b>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –±–æ—Ç–æ–≤</b><div></div></header>
        <div style="padding:20px;">
            <div class="bot-card">
                <h3>–°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞</h3>
                <input type="text" id="bot-n" class="field" style="width:100%; margin-bottom:10px;" placeholder="–ò–º—è –±–æ—Ç–∞ (–Ω–∞–ø—Ä. –≠—Ö–æ-–±–æ—Ç)">
                <textarea id="bot-r" class="field" style="width:100%; height:80px;" placeholder="–ß—Ç–æ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ?"></textarea>
                <button class="send-btn" style="width:100%; margin-top:15px; border-radius:12px;" onclick="god.createBot()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞</button>
            </div>
        </div>
    </div>

    <div id="scr-new-chan" class="screen bottom">
        <header><div class="h-ico" onclick="god.home()">‚úï</div><b>–ù–æ–≤—ã–π –∫–∞–Ω–∞–ª</b><div></div></header>
        <div style="padding:20px;">
            <input type="text" id="cn-n" class="field" style="width:100%; margin-bottom:10px;" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞">
            <textarea id="cn-d" class="field" style="width:100%; height:100px;" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞"></textarea>
            <button class="send-btn" style="width:100%; margin-top:15px; border-radius:12px;" onclick="god.createChan()">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>

    <div id="scr-settings" class="screen">
        <header><div class="h-ico" onclick="god.home()">‚Üê</div><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b><div></div></header>
        <div style="padding:30px; text-align:center;">
            <div class="ava" id="my-ava" style="width:90px; height:90px; margin:0 auto 15px; font-size:32px;">?</div>
            <h2 id="my-name">Name</h2>
            <p id="my-user" style="color:var(--accent);">@user</p>
            <button class="field" style="width:100%; margin-top:20px;" onclick="god.toggleDark()">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
            <button class="field" style="width:100%; margin-top:10px; color:var(--danger);" onclick="god.logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <script>
        // FIREBASE INITIALIZATION
        const cfg = {
            apiKey: "AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
            authDomain: "sleep-menager.firebaseapp.com",
            projectId: "sleep-menager",
            databaseURL: "https://sleep-menager-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(cfg);
        const db = firebase.database();

        const god = {
            me: JSON.parse(localStorage.getItem('god_sess')),
            chat: null, gh: localStorage.getItem('god_gh') === '1',
            rec: null, chunks: [], pc: null, stream: null,

            init() {
                if(this.me) {
                    document.getElementById('auth-layer').remove();
                    this.syncChats();
                    this.syncStories();
                    this.listenCalls();
                    this.updateOnline(true);
                    this.loadProfile();
                    if(localStorage.getItem('god_dark') === '1') document.body.classList.add('dark');
                }
            },

            async reg() {
                const n = document.getElementById('reg-n').value, u = document.getElementById('reg-u').value.replace('@','');
                if(!n || !u) return alert("–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ");
                this.me = { n, u: '@'+u };
                await db.ref('u/'+u).set(this.me);
                localStorage.setItem('god_sess', JSON.stringify(this.me));
                location.reload();
            },

            loadProfile() {
                document.getElementById('my-name').innerText = this.me.n;
                document.getElementById('my-user').innerText = this.me.u;
                document.getElementById('my-ava').innerText = this.me.n[0];
                if(this.gh) document.getElementById('ghost-trigger').classList.add('active');
            },

            open(id) { this.closeAll(); document.getElementById(id).classList.add('active'); },
            home() { this.closeAll(); document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.tab')[0].classList.add('active'); },
            closeAll() { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); },

            // CHATS & MSGS
            syncChats() {
                db.ref('rec/'+this.me.u.replace('@','')).on('value', s => {
                    const box = document.getElementById('chat-list'); box.innerHTML = "";
                    s.forEach(c => {
                        const d = c.val();
                        box.innerHTML += `<div class="chat-card" onclick="god.openChat('${d.u}','${d.n}',${!!d.isB})">
                            <div class="ava">${d.n[0]}</div>
                            <div class="c-main">
                                <div class="c-row"><div class="c-name">${d.n}</div><div class="c-msg" style="font-size:10px;">12:00</div></div>
                                <div class="c-msg">${d.isB ? '–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –±–æ—Ç' : d.u}</div>
                            </div>
                        </div>`;
                    });
                });
            },

            openChat(u, n, isBot = false) {
                const id = [this.me.u, u].sort().join('_').replace(/@/g,'');
                this.chat = { id, u, n, isBot };
                document.getElementById('v-name').innerText = n;
                document.getElementById('v-ava').innerText = n[0];
                this.open('scr-chat');
                this.syncMsgs();
                if(!isBot) db.ref('u/'+u.replace('@','')+'/on').on('value', s => {
                    document.getElementById('v-stat').innerText = s.val() ? '–≤ —Å–µ—Ç–∏' : '–±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ';
                });
            },

            syncMsgs() {
                db.ref('m/'+this.chat.id).on('value', s => {
                    const box = document.getElementById('msg-engine'); box.innerHTML = "";
                    s.forEach(m => {
                        const d = m.val(), isMe = d.f === this.me.u;
                        let html = d.t;
                        if(d.v) html = `<div class="v-msg" onclick="new Audio('${d.v}').play()">üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</div>`;
                        if(d.i) html = `<img src="${d.i}" width="100%" style="border-radius:12px;">`;
                        box.innerHTML += `<div class="bubble ${isMe?'out':'in'}">${html}</div>`;
                    });
                    box.scrollTop = box.scrollHeight;
                });
            },

            send() {
                const f = document.getElementById('f-text'); if(!f.value.trim()) return;
                db.ref('m/'+this.chat.id).push({ t: f.value, f: this.me.u, ts: Date.now() });
                if(this.chat.isBot) this.botReply(f.value);
                f.value = "";
            },

            // VOICE MESSAGES (–ì–°)
            async toggleGS() {
                const btn = document.getElementById('mic-trigger');
                if(!this.rec) {
                    const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.rec = new MediaRecorder(s);
                    this.rec.ondataavailable = e => this.chunks.push(e.data);
                    this.rec.onstop = () => {
                        const b = new Blob(this.chunks, { type: 'audio/webm' });
                        const r = new FileReader();
                        r.onload = () => db.ref('m/'+this.chat.id).push({ v: r.result, f: this.me.u });
                        r.readAsDataURL(b); this.chunks = [];
                    };
                    this.rec.start(); btn.style.color = 'var(--danger)';
                } else {
                    this.rec.stop(); this.rec = null; btn.style.color = 'var(--sub)';
                }
            },

            // VIDEO CALLS (WEBRTC)
            async call(isOff) {
                this.open('scr-call');
                this.stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-vid').srcObject = this.stream;
                this.pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                this.stream.getTracks().forEach(t => this.pc.addTrack(t, this.stream));
                this.pc.ontrack = e => document.getElementById('remote-vid').srcObject = e.streams[0];
                
                const ref = db.ref('calls/'+this.chat.id);
                if(isOff) {
                    const offer = await this.pc.createOffer();
                    await this.pc.setLocalDescription(offer);
                    ref.set({ offer, from: this.me.u });
                }
                
                this.pc.onicecandidate = e => e.candidate && ref.child('ice').push(e.candidate.toJSON());
                ref.on('value', async s => {
                    const d = s.val(); if(!d) return;
                    if(!isOff && d.offer && !this.pc.remoteDescription) {
                        await this.pc.setRemoteDescription(new RTCSessionDescription(d.offer));
                        const ans = await this.pc.createAnswer();
                        await this.pc.setLocalDescription(ans);
                        ref.update({ answer: ans });
                    }
                    if(isOff && d.answer && !this.pc.remoteDescription) await this.pc.setRemoteDescription(new RTCSessionDescription(d.answer));
                });
                ref.child('ice').on('child_added', s => this.pc.addIceCandidate(new RTCIceCandidate(s.val())));
            },

            listenCalls() {
                db.ref('calls').on('child_added', s => {
                    const d = s.val(); if(d.from !== this.me.u && confirm("–ó–≤–æ–Ω–æ–∫ –æ—Ç " + d.from)) {
                        this.openChat(d.from, d.from); this.call(false);
                    }
                });
            },

            endCall() { location.reload(); },

            // STORIES & CHANNELS
            upStory(inp) {
                const r = new FileReader();
                r.onload = e => {
                    db.ref('st').push({ i: e.target.result, n: this.me.n, f: this.me.u });
                    document.getElementById('my-st-thumb').src = e.target.result;
                };
                r.readAsDataURL(inp.files[0]);
            },

            syncStories() {
                db.ref('st').on('value', s => {
                    const f = document.getElementById('st-feed'); f.innerHTML = "";
                    s.forEach(st => { if(st.val().f !== this.me.u) f.innerHTML += `<div class="st-item"><div class="st-ring"><img src="${st.val().i}"></div>${st.val().n}</div>`; });
                });
            },

            createChan() {
                const n = document.getElementById('cn-n').value; if(!n) return;
                db.ref(`rec/${this.me.u.replace('@','')}/${n}`).set({ n, u: '#'+n, isC: true });
                this.home();
            },

            // BOT LOGIC
            createBot() {
                const n = document.getElementById('bot-n').value, r = document.getElementById('bot-r').value;
                if(!n) return;
                db.ref(`rec/${this.me.u.replace('@','')}/${n}`).set({ n, u: '@'+n, isB: true, reply: r });
                this.home();
            },

            botReply(msg) {
                db.ref(`rec/${this.me.u.replace('@','')}/${this.chat.n}/reply`).once('value', s => {
                    setTimeout(() => {
                        db.ref('m/'+this.chat.id).push({ t: s.val() || "–Ø —Ä–∞–±–æ—Ç–∞—é!", f: '@'+this.chat.n });
                    }, 1000);
                });
            },

            // UTILS
            toggleGhost() { this.gh = !this.gh; localStorage.setItem('god_gh', this.gh?'1':'0'); location.reload(); },
            updateOnline(st) { if(this.me && !this.gh) db.ref('u/'+this.me.u.replace('@','')+'/on').set(st); },
            toggleDark() { const d = document.body.classList.toggle('dark'); localStorage.setItem('god_dark', d?'1':'0'); },
            logout() { localStorage.clear(); location.reload(); }
        };

        god.init();
        window.onblur = () => god.updateOnline(false);
        window.onfocus = () => god.updateOnline(true);
    </script>
</body>
                                                                                                </html>
