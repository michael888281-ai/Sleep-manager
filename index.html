<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sleep Manager | SINGULARITY</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --b: #000; --c: #0a0a0a; --a: #00ff88; --t: #fff; --s: #555; --i: #111; --o: #00ff88;
            --safe-t: env(safe-area-inset-top); --safe-b: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'JetBrains Mono', monospace; outline: none; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; background: var(--b); color: var(--t); overflow: hidden; }

        .l { position: fixed; inset: 0; background: var(--b); z-index: 10; transform: translateX(100%); transition: .5s cubic-bezier(0.19, 1, 0.22, 1); display: flex; flex-direction: column; visibility: hidden; }
        .l.active { transform: translateX(0); visibility: visible; z-index: 100; }

        header { padding-top: var(--safe-t); background: rgba(0,0,0,0.9); backdrop-filter: blur(30px); border-bottom: 1px solid #1a1a1a; display: flex; align-items: center; height: calc(70px + var(--safe-t)); padding-left: 20px; padding-right: 20px; z-index: 200; gap: 20px; }
        .h-t { flex: 1; font-size: 18px; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; color: var(--a); text-shadow: 0 0 10px var(--a); }
        .h-b { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; background: #111; color: var(--a); font-size: 20px; cursor: pointer; border: 1px solid #222; }

        .tabs { display: flex; padding: 6px; background: #0a0a0a; border-radius: 14px; margin: 15px; gap: 6px; border: 1px solid #1a1a1a; }
        .tab { flex: 1; padding: 10px; text-align: center; font-size: 11px; font-weight: 900; color: var(--s); border-radius: 10px; cursor: pointer; transition: .3s; }
        .tab.active { background: var(--a); color: #000; box-shadow: 0 0 15px var(--a); }

        .scr { flex: 1; overflow-y: auto; padding: 0 20px; scrollbar-width: none; }
        .row { display: flex; padding: 15px 0; gap: 18px; border-bottom: 1px solid #111; align-items: center; animation: slideIn .4s ease forwards; opacity: 0; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .av { width: 60px; height: 60px; border-radius: 20px; background: #000; border: 2px solid #1a1a1a; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 900; color: var(--a); position: relative; }
        .on { position: absolute; bottom: -2px; right: -2px; width: 16px; height: 16px; background: var(--a); border: 4px solid #000; border-radius: 50%; display: none; box-shadow: 0 0 10px var(--a); }
        .inf { flex: 1; min-width: 0; }
        .inf b { display: block; font-size: 18px; margin-bottom: 5px; letter-spacing: -0.5px; }
        .inf p { margin: 0; color: var(--s); font-size: 13px; font-family: sans-serif; }

        .v { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px; background: #000; background-image: linear-gradient(#0a0a0a 1px, transparent 1px), linear-gradient(90deg, #0a0a0a 1px, transparent 1px); background-size: 30px 30px; }
        .m { max-width: 80%; padding: 14px 18px; border-radius: 22px; font-size: 15px; position: relative; line-height: 1.5; animation: pop .3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .m.out { align-self: flex-end; background: #000; color: var(--a); border: 2px solid var(--a); border-bottom-right-radius: 4px; box-shadow: 0 0 20px rgba(0,255,136,0.1); }
        .m.in { align-self: flex-start; background: #111; color: #fff; border: 1px solid #222; border-bottom-left-radius: 4px; }
        .m img { max-width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid #333; }
        .m .t { font-size: 10px; opacity: 0.5; text-align: right; margin-top: 6px; font-weight: 900; }

        .bar { padding: 15px 20px calc(20px + var(--safe-b)); background: #000; border-top: 1px solid #1a1a1a; display: flex; align-items: flex-end; gap: 12px; }
        .box { flex: 1; background: #0a0a0a; border-radius: 18px; padding: 2px 20px; display: flex; align-items: center; border: 1px solid #1a1a1a; transition: .3s; }
        .box:focus-within { border-color: var(--a); box-shadow: 0 0 15px rgba(0,255,136,0.2); }
        .area { width: 100%; border: none; background: transparent; padding: 12px 0; font-size: 16px; color: #fff; resize: none; max-height: 180px; }

        nav { height: calc(80px + var(--safe-b)); background: #000; border-top: 1px solid #1a1a1a; display: flex; padding-bottom: var(--safe-b); }
        .it { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--s); font-size: 10px; font-weight: 900; gap: 6px; transition: .3s; }
        .it.active { color: var(--a); text-shadow: 0 0 10px var(--a); }
        .it i { font-style: normal; font-size: 26px; }

        #g { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; }
        .matrix { position: absolute; inset: 0; opacity: 0.05; pointer-events: none; overflow: hidden; font-size: 10px; color: var(--a); line-height: 1; }
        .logo { font-size: 100px; margin-bottom: 20px; filter: drop-shadow(0 0 30px var(--a)); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .inp { width: 100%; max-width: 350px; padding: 20px; border-radius: 15px; border: 1px solid #1a1a1a; margin-bottom: 15px; font-size: 16px; background: #0a0a0a; color: #fff; text-align: center; letter-spacing: 2px; }
        .btn { width: 100%; max-width: 350px; padding: 20px; border-radius: 15px; background: var(--a); color: #000; border: none; font-weight: 900; font-size: 16px; cursor: pointer; letter-spacing: 2px; }

        #call { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; flex-direction: column; }
        #rv { width: 100%; height: 100%; object-fit: cover; filter: grayscale(0.5) contrast(1.2); }
        #lv { position: absolute; top: 70px; right: 25px; width: 120px; height: 180px; border-radius: 20px; border: 2px solid var(--a); object-fit: cover; z-index: 2001; box-shadow: 0 0 30px var(--a); }
        .ctrl { position: absolute; bottom: 80px; width: 100%; display: flex; justify-content: center; gap: 30px; z-index: 2002; }
        .cb { width: 70px; height: 70px; border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; background: #111; border: 1px solid #222; color: #fff; }
        .cb.hang { background: #ff3b30; color: #fff; border: none; box-shadow: 0 0 30px rgba(255,59,48,0.4); }

        .typ { font-size: 11px; color: var(--a); font-weight: 900; display: none; margin-top: 4px; text-transform: uppercase; }
        .status-tag { padding: 2px 8px; border-radius: 4px; font-size: 9px; background: #1a1a1a; color: var(--a); margin-left: 10px; vertical-align: middle; }
    </style>
</head>
<body>

    <div id="g">
        <div class="matrix" id="mx"></div>
        <div class="logo">üõ∞Ô∏è</div>
        <h1 style="margin:0; letter-spacing: 5px;">SLEEP_MANAGER</h1>
        <p style="color:var(--s); margin-bottom:40px; font-size: 12px; letter-spacing: 3px;">SINGULARITY PROTOCOL v.9.0</p>
        <input type="text" id="rn" class="inp" placeholder="NODE_NAME">
        <input type="text" id="ru" class="inp" placeholder="@ACCESS_ID">
        <button class="btn" onclick="Œ©.auth()">INITIALIZE_LINK</button>
    </div>

    <header>
        <div class="h-b" onclick="Œ©.open('settings')">‚ò∞</div>
        <div class="h-t">SINGULARITY</div>
        <div class="h-b" onclick="Œ©.open('search')">üîç</div>
    </header>

    <div class="tabs">
        <div class="tab active" onclick="Œ©.setTab('all', this)">NODES</div>
        <div class="tab" onclick="Œ©.setTab('priv', this)">PRIVATE</div>
        <div class="tab" onclick="Œ©.setTab('grp', this)">CLUSTERS</div>
    </div>

    <div class="scr" id="main"></div>

    <nav>
        <div class="it active" onclick="Œ©.home()"><i>üì°</i>NETWORK</div>
        <div class="it" onclick="Œ©.open('groups')"><i>üßä</i>CLUSTERS</div>
        <div class="it" onclick="Œ©.open('settings')"><i>‚ò£Ô∏è</i>CORE</div>
    </nav>

    <div id="chat" class="l">
        <header>
            <div class="h-b" onclick="Œ©.home()">‚Üê</div>
            <div style="flex:1;">
                <b id="cn" style="font-size:16px; letter-spacing:1px;">...</b>
                <div id="cs" class="typ">uploading_data...</div>
            </div>
            <div class="h-b" onclick="Œ©.call(true)">üìû</div>
        </header>
        <div class="v" id="wall"></div>
        <div class="bar">
            <div class="h-b" onclick="document.getElementById('up').click()">üìé<input type="file" id="up" hidden onchange="Œ©.up(this)"></div>
            <div class="box"><textarea id="fm" class="area" rows="1" placeholder="Enter command..." oninput="Œ©.typing()"></textarea></div>
            <div class="h-b" id="mic" onclick="Œ©.stt()">üé§</div>
            <div class="h-b" onclick="Œ©.send()" style="color:var(--a); font-weight:bold;">EXE</div>
        </div>
    </div>

    <div id="search" class="l">
        <header><div class="h-b" onclick="Œ©.home()">‚Üê</div><input type="text" id="sq" placeholder="SCAN_NETWORK..." oninput="Œ©.find()" style="flex:1; border:none; background:transparent; color:#fff; font-size:16px; letter-spacing:2px;"></header>
        <div class="scr" id="s-list"></div>
    </div>

    <div id="groups" class="l">
        <header><div class="h-b" onclick="Œ©.home()">‚Üê</div><div class="h-t">CREATE_CLUSTER</div></header>
        <div style="padding:30px"><input type="text" id="gn" class="inp" placeholder="CLUSTER_ID"><button class="btn" onclick="Œ©.mkG()">CONSTRUCT</button></div>
        <div class="scr" id="g-list"></div>
    </div>

    <div id="settings" class="l">
        <header><div class="h-b" onclick="Œ©.home()">‚Üê</div><div class="h-t">SYSTEM_LOGS</div></header>
        <div style="padding:50px; text-align:center">
            <div class="av" id="ma" style="width:130px; height:130px; font-size:50px; margin:0 auto 30px; border-radius:40px; border-color:var(--a);">?</div>
            <h2 id="mn" style="margin:0; letter-spacing:2px;">User</h2>
            <p id="mu" style="color:var(--a); margin-bottom:50px; font-size:14px;">@id</p>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <button class="btn" style="background:#111; color:#fff; border:1px solid #222;" onclick="Œ©.wall()">BG_MOD</button>
                <button class="btn" style="background:#111; color:#fff; border:1px solid #222;" onclick="Œ©.clear()">PURGE</button>
                <button class="btn" style="grid-column: span 2; background:transparent; border:1px solid #ff3b30; color:#ff3b30" onclick="Œ©.out()">DISCONNECT_ALL</button>
            </div>
        </div>
    </div>

    <div id="call" class="call">
        <video id="rv" autoplay playsinline></video>
        <video id="lv" autoplay playsinline muted></video>
        <div class="ctrl">
            <div class="cb hang" onclick="location.reload()">‚ò†Ô∏è</div>
            <div class="cb" onclick="Œ©.scrn()">üñ•Ô∏è</div>
            <div class="cb" onclick="Œ©.mute()">ü§ê</div>
        </div>
    </div>

    <script>
        const cfg = {
            apiKey: "AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
            authDomain: "sleep-menager.firebaseapp.com",
            databaseURL: "https://sleep-menager-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(cfg);
        const db = firebase.database();

        

        const Œ© = {
            me: JSON.parse(localStorage.getItem('sm_omega')),
            chat: null, pc: null, st: null, to: null,

            init() {
                this.mx();
                if(this.me) {
                    document.getElementById('g').remove();
                    this.sync();
                    this.on();
                    this.listen();
                    document.getElementById('mn').innerText = this.me.n;
                    document.getElementById('mu').innerText = this.me.u;
                    document.getElementById('ma').innerText = this.me.n[0];
                }
            },

            mx() {
                const c = document.getElementById('mx');
                for(let i=0; i<100; i++) {
                    const d = document.createElement('div');
                    d.style.position = 'absolute'; d.style.left = Math.random()*100+'%';
                    d.style.top = Math.random()*100+'%'; d.innerText = Math.random().toString(16).substr(2,8);
                    c.appendChild(d);
                }
            },

            async auth() {
                const n = document.getElementById('rn').value, u = document.getElementById('ru').value.replace('@','').toLowerCase();
                if(!n || !u) return;
                this.me = { n, u: '@'+u };
                await db.ref('u/'+u).set(this.me);
                localStorage.setItem('sm_omega', JSON.stringify(this.me));
                location.reload();
            },

            open(id) { document.getElementById(id).classList.add('active'); },
            home() { document.querySelectorAll('.l').forEach(p=>p.classList.remove('active')); this.chat=null; },
            
            on() {
                const r = db.ref('u/'+this.me.u.replace('@','')+'/o');
                r.set(true); r.onDisconnect().set(false);
            },

            sync() {
                db.ref('rec/'+this.me.u.replace('@','')).on('value', s => {
                    const b = document.getElementById('main'); b.innerHTML = "";
                    s.forEach(c => {
                        const d = c.val();
                        b.innerHTML += `<div class="row" onclick="Œ©.openChat('${d.u}','${d.n}',${d.g||false})">
                            <div class="av">${d.n[0]}<div class="on" id="o-${d.u.replace(/[@|grp_]/g,'')}"></div></div>
                            <div class="inf"><b>${d.n} <span class="status-tag">LINKED</span></b><p>${d.u}</p></div>
                        </div>`;
                        if(!d.g) this.track(d.u);
                    });
                });
            },

            track(u) {
                db.ref('u/'+u.replace('@','')+'/o').on('value', s => {
                    const e = document.getElementById('o-'+u.replace('@',''));
                    if(e) e.style.display = s.val() ? 'block' : 'none';
                });
            },

            openChat(u, n, g) {
                this.chat = { id: g ? u : [this.me.u, u].sort().join('_').replace(/@/g,''), u, n, g };
                document.getElementById('cn').innerText = n.toUpperCase();
                this.open('chat');
                const r = db.ref('m/'+this.chat.id);
                r.off();
                r.on('value', s => {
                    const v = document.getElementById('wall'); v.innerHTML = "";
                    s.forEach(m => {
                        const d = m.val(), me = d.f === this.me.u;
                        let b = d.t || '';
                        if(d.i) b = `<img src="${d.i}" onclick="window.open(this.src)">`;
                        v.innerHTML += `<div class="m ${me?'out':'in'}">${b}<div class="t">${new Date(d.ts).toLocaleTimeString()}</div></div>`;
                    });
                    v.scrollTop = v.scrollHeight;
                });
                if(!g) db.ref('t/'+this.chat.id+'/'+u.replace('@','')).on('value', s => {
                    document.getElementById('cs').style.display = s.val() ? 'block' : 'none';
                });
            },

            send() {
                const f = document.getElementById('fm'); if(!f.value.trim()) return;
                db.ref('m/'+this.chat.id).push({ t: f.value, f: this.me.u, ts: Date.now() });
                f.value = ""; f.style.height = "auto";
            },

            up(inp) {
                const r = new FileReader(); r.onload = e => db.ref('m/'+this.chat.id).push({ i: e.target.result, f: this.me.u, ts: Date.now() });
                r.readAsDataURL(inp.files[0]);
            },

            typing() {
                if(!this.chat || this.chat.g) return;
                const r = db.ref('t/'+this.chat.id+'/'+this.me.u.replace('@',''));
                r.set(true); clearTimeout(this.to);
                this.to = setTimeout(() => r.set(false), 2000);
            },

            async call(off) {
                document.getElementById('call').style.display = 'flex';
                this.st = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('lv').srcObject = this.st;
                this.pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                this.st.getTracks().forEach(t => this.pc.addTrack(t, this.st));
                this.pc.ontrack = e => document.getElementById('rv').srcObject = e.streams[0];
                const r = db.ref('c/'+this.chat.id);
                if(off) {
                    const o = await this.pc.createOffer();
                    await this.pc.setLocalDescription(o);
                    r.set({ o, f: this.me.u, n: this.me.n });
                }
                this.pc.onicecandidate = e => e.candidate && r.child('i').push(e.candidate.toJSON());
                r.on('value', async s => {
                    const d = s.val(); if(!d) return;
                    if(!off && d.o && !this.pc.remoteDescription) {
                        await this.pc.setRemoteDescription(new RTCSessionDescription(d.o));
                        const a = await this.pc.createAnswer();
                        await this.pc.setLocalDescription(a);
                        r.update({ a });
                    }
                    if(off && d.a && !this.pc.remoteDescription) await this.pc.setRemoteDescription(new RTCSessionDescription(d.a));
                });
                r.child('i').on('child_added', s => this.pc.addIceCandidate(new RTCIceCandidate(s.val())));
            },

            listen() {
                db.ref('c').on('child_added', s => {
                    const d = s.val();
                    if(d.f !== this.me.u && s.key.includes(this.me.u.replace('@',''))) {
                        if(confirm("INCOMING_SIGNAL: " + d.n)) { this.chat={id:s.key, u:d.f, n:d.n}; this.call(false); }
                        else db.ref('c/'+s.key).remove();
                    }
                });
            },

            find() {
                const q = document.getElementById('sq').value.replace('@','').toLowerCase();
                if(q.length<2) return;
                db.ref('u/'+q).once('value', s => {
                    const b = document.getElementById('s-list'); b.innerHTML = "";
                    if(s.exists()) {
                        const d = s.val();
                        b.innerHTML = `<div class="row" onclick="Œ©.addChat('${d.u}','${d.n}')">
                            <div class="av">${d.n[0]}</div><div class="inf"><b>${d.n}</b><p>${d.u}</p></div>
                        </div>`;
                    }
                });
            },

            stt() {
                const S = window.SpeechRecognition || window.webkitSpeechRecognition;
                if(!S) return; const r = new S();
                r.onresult = e => { document.getElementById('fm').value = e.results[0][0].transcript; };
                r.start();
            },

            mkG() {
                const n = document.getElementById('gn').value; if(!n) return;
                const id = 'grp_' + Date.now();
                db.ref('g/'+id).set({ n, a: this.me.u });
                db.ref(`rec/${this.me.u.replace('@','')}/${id}`).set({ n, u: id, g: true });
                this.home();
            },

            addChat(u, n) { db.ref(`rec/${this.me.u.replace('@','')}/${u.replace('@','')}`).set({ u, n }); this.openChat(u, n, false); },
            wall() { const u = prompt("IMG_URL:"); if(u) document.getElementById('wall').style.backgroundImage = `url(${u})`; },
            clear() { if(confirm("PURGE_DATA?")) db.ref('m/'+this.chat.id).remove(); },
            out() { localStorage.clear(); location.reload(); }
        };
        Œ©.init();
    </script>
</body>
</html>
