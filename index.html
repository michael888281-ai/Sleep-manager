<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sleep Manager Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root {
            --blue: #0088cc; --light: #eff7ff; --bg: #ffffff;
            --text: #222; --gray: #8e8e93; --out: #effdde; --in: #ffffff;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, sans-serif; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); overflow: hidden; }

        /* AUTH & REGISTRATION */
        #auth-screen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 30px; }
        .auth-box { width: 100%; max-width: 350px; text-align: center; }
        .auth-box input { width: 100%; padding: 16px; border: 1px solid #ddd; border-radius: 14px; margin-bottom: 12px; font-size: 16px; }
        .btn-main { width: 100%; padding: 16px; background: var(--blue); color: #fff; border: none; border-radius: 14px; font-weight: bold; font-size: 16px; cursor: pointer; }

        /* APP LAYOUT */
        .app-container { display: none; flex-direction: column; height: 100vh; }
        header { padding: 12px 16px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; background: #fff; z-index: 100; }
        .search-area { flex: 1; background: #f1f1f2; border-radius: 10px; padding: 8px 12px; display: flex; align-items: center; }
        .search-area input { background: none; border: none; width: 100%; outline: none; margin-left: 8px; font-size: 15px; }

        /* STORIES */
        .stories-bar { display: flex; gap: 12px; padding: 15px; overflow-x: auto; border-bottom: 1px solid #eee; }
        .st-ring { min-width: 68px; height: 68px; border-radius: 50%; border: 2.5px solid var(--blue); padding: 2px; flex-shrink: 0; position: relative; }
        .st-img { width: 100%; height: 100%; border-radius: 50%; background: #eee; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .st-img img { width: 100%; height: 100%; object-fit: cover; }

        /* LISTS */
        .chat-scroll { flex: 1; overflow-y: auto; background: #fff; }
        .chat-card { display: flex; padding: 12px 16px; gap: 15px; align-items: center; border-bottom: 0.5px solid #f0f0f0; transition: 0.2s; cursor: pointer; }
        .chat-card:active { background: #f5f8fa; }
        .avatar { width: 56px; height: 56px; border-radius: 50%; background: var(--blue); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 20px; }
        .card-body { flex: 1; }
        .card-name { font-weight: bold; font-size: 16px; margin-bottom: 3px; display: flex; align-items: center; gap: 5px; }
        .card-msg { font-size: 14px; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

        /* CHAT WINDOW */
        #chat-win { position: fixed; inset: 0; background: #e7ebf0; z-index: 5000; transform: translateX(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; }
        #chat-win.active { transform: translateX(0); }
        .win-header { padding: 10px 15px; background: #fff; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #ddd; }
        #msg-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .bubble { padding: 8px 14px; border-radius: 16px; max-width: 80%; font-size: 15px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .bubble.mine { align-self: flex-end; background: var(--out); border-bottom-right-radius: 4px; }
        .bubble.theirs { align-self: flex-start; background: var(--in); border-bottom-left-radius: 4px; }
        .bubble img { width: 100%; border-radius: 10px; margin: 5px 0; }
        .timestamp { font-size: 10px; opacity: 0.5; text-align: right; margin-top: 4px; }

        /* BOTTOM INPUT */
        .input-bar { padding: 10px; background: #fff; display: flex; align-items: center; gap: 12px; border-top: 1px solid #ddd; }
        .input-bar input { flex: 1; padding: 12px 16px; border: none; background: #f1f1f2; border-radius: 25px; outline: none; font-size: 16px; }
        .action-icon { font-size: 26px; color: var(--blue); cursor: pointer; transition: 0.2s; }
        .action-icon:active { transform: scale(0.85); }
        .rec-now { color: #ff3b30; animation: blink 1s infinite; }

        /* PROFILE MODAL */
        #profile-win { position: fixed; inset: 0; background: #fff; z-index: 6000; transform: translateY(100%); transition: 0.4s; padding: 40px 20px; text-align: center; }
        #profile-win.active { transform: translateY(0); }
        .prof-ava { width: 100px; height: 100px; border-radius: 50%; background: var(--blue); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 40px; margin: 0 auto 20px; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-box">
            <h1 style="color:var(--blue)">Sleep Manager</h1>
            <p style="color:var(--gray)">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π @—é–∑–µ—Ä</p>
            <input type="text" id="reg-nick" placeholder="–¢–≤–æ–µ –∏–º—è">
            <input type="text" id="reg-user" placeholder="@username (—Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ)">
            <p id="err-text" style="color:red; font-size:13px; display:none; margin-bottom:15px;">–û—à–∏–±–∫–∞: —é–∑–µ—Ä–Ω–µ–π–º –∑–∞–Ω—è—Ç!</p>
            <button class="btn-main" onclick="handleAuth()">–í–æ–π—Ç–∏ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</button>
        </div>
    </div>

    <div class="app-container" id="main-app">
        <header>
            <div class="action-icon" onclick="toggleProfile()">‚ò∞</div>
            <div class="search-area">
                <span>üîç</span>
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π –ø–æ @—é–∑–µ—Ä—É..." oninput="searchEngine()">
            </div>
        </header>

        <div class="stories-bar">
            <div class="st-ring" onclick="addMyStory()" style="border-style:dashed; border-color:var(--gray);">
                <div class="st-img" style="color:var(--gray); font-size:30px">+</div>
            </div>
            <div id="stories-feed" style="display:flex; gap:12px"></div>
        </div>

        <div class="chat-scroll">
            <div class="chat-card" onclick="openRoom('global', '–û–±—â–∏–π —á–∞—Ç')">
                <div class="avatar">üåç</div>
                <div class="card-body">
                    <div class="card-name">–û–±—â–∏–π —á–∞—Ç</div>
                    <div class="card-msg">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–¥–µ—Å—å</div>
                </div>
            </div>
            <div id="dynamic-list"></div>
        </div>
    </div>

    <div id="chat-win">
        <div class="win-header">
            <div class="action-icon" onclick="closeRoom()">‚Üê</div>
            <div id="chat-target-name" style="font-weight:bold; flex:1">–ß–∞—Ç</div>
            <div class="action-icon" onclick="alert('–ó–≤–æ–Ω–æ–∫...')">üìû</div>
        </div>
        <div id="msg-list"></div>
        <div class="input-bar">
            <label for="img-file" class="action-icon">üñºÔ∏è</label>
            <input type="file" id="img-file" accept="image/*" hidden onchange="handleImage(this)">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
            <div class="action-icon" id="mic-btn" onmousedown="recStart()" onmouseup="recStop()" ontouchstart="recStart()" ontouchend="recStop()">üéôÔ∏è</div>
            <div class="action-icon" onclick="sendText()">‚û§</div>
        </div>
    </div>

    <div id="profile-win">
        <div class="action-icon" onclick="toggleProfile()" style="position:absolute; top:20px; left:20px;">‚úï</div>
        <div class="prof-ava" id="my-ava">S</div>
        <h2 id="my-name">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <p id="my-handle" style="color:var(--gray)">@username</p>
        <button class="btn-main" style="background:#9c27b0; margin-top:20px;" onclick="getPremium()">–ö—É–ø–∏—Ç—å –ü—Ä–µ–º–∏—É–º üíé</button>
        <button class="btn-main" style="background:#f44336; margin-top:10px;" onclick="localStorage.clear(); location.reload();">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
    </div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–¢–í–û–ò –î–ê–ù–ù–´–ï) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
            authDomain: "sleep-menager.firebaseapp.com",
            projectId: "sleep-menager",
            storageBucket: "sleep-menager.firebasestorage.app",
            messagingSenderId: "3927631074",
            appId: "1:3927631074:web:a3a604c7147e31a900eabb",
            databaseURL: "https://sleep-menager-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myData = JSON.parse(localStorage.getItem('sm_data'));
        let activeChatId = "";
        let recorder;
        let audioChunks = [];

        if(myData) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            initMain();
        }

        async function handleAuth() {
            const nick = document.getElementById('reg-nick').value.trim();
            const user = document.getElementById('reg-user').value.trim().toLowerCase().replace('@','');
            if(!nick || !user) return alert("–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è!");

            const snap = await db.ref('u_list/' + user).once('value');
            if(snap.exists()) {
                document.getElementById('err-text').style.display = 'block';
            } else {
                myData = { nick, user: '@'+user, prem: false };
                await db.ref('u_list/' + user).set(myData);
                localStorage.setItem('sm_data', JSON.stringify(myData));
                location.reload();
            }
        }

        function initMain() {
            document.getElementById('my-name').innerText = myData.nick;
            document.getElementById('my-handle').innerText = myData.user;
            document.getElementById('my-ava').innerText = myData.nick[0].toUpperCase();
            loadStories();
            loadMyChats();
        }

        // --- –ü–û–ò–°–ö –ò –õ–ò–ß–ù–´–ï –ß–ê–¢–´ ---
        function searchEngine() {
            const query = document.getElementById('search-input').value.toLowerCase().replace('@','');
            if(query.length < 2) return;
            
            db.ref('u_list').orderByKey().startAt(query).endAt(query+"\uf8ff").once('value', s => {
                const list = document.getElementById('dynamic-list');
                list.innerHTML = "<div style='padding:10px; font-size:12px; color:var(--blue)'>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:</div>";
                s.forEach(child => {
                    const u = child.val();
                    if(u.user !== myData.user) {
                        list.innerHTML += `
                        <div class="chat-card" onclick="startPrivate('${u.user}')">
                            <div class="avatar">${u.nick[0]}</div>
                            <div class="card-body"><b>${u.nick}</b><br><small>${u.user}</small></div>
                        </div>`;
                    }
                });
            });
        }

        function startPrivate(targetUser) {
            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –õ–° (—Å–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–µ–Ω–∞, —á—Ç–æ–±—ã ID –±—ã–ª –æ–¥–∏–Ω –¥–ª—è –¥–≤–æ–∏—Ö)
            const ids = [myData.user.replace('@',''), targetUser.replace('@','')].sort();
            const roomId = `priv_${ids[0]}_${ids[1]}`;
            openRoom(roomId, targetUser);
        }

        function openRoom(id, title) {
            activeChatId = id;
            document.getElementById('chat-target-name').innerText = title;
            document.getElementById('chat-win').classList.add('active');
            syncMessages();
        }

        function closeRoom() { 
            document.getElementById('chat-win').classList.remove('active'); 
            db.ref('msgs/' + activeChatId).off();
        }

        // --- –°–û–û–ë–©–ï–ù–ò–Ø, –§–û–¢–û, –ì–° ---
        function sendText(audio = null, img = null) {
            const input = document.getElementById('msg-input');
            if(!input.value && !audio && !img) return;
            
            db.ref('msgs/' + activeChatId).push({
                u: myData.nick,
                usr: myData.user,
                m: input.value,
                a: audio,
                i: img,
                t: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
            });
            input.value = "";
        }

        function syncMessages() {
            db.ref('msgs/' + activeChatId).on('value', s => {
                const box = document.getElementById('msg-list');
                box.innerHTML = "";
                s.forEach(c => {
                    const d = c.val();
                    const isMe = d.usr === myData.user;
                    let body = d.m ? `<div>${d.m}</div>` : "";
                    if(d.i) body = `<img src="${d.i}" onclick="window.open('${d.i}')">`;
                    if(d.a) body = `<div onclick="new Audio('${d.a}').play()" style="cursor:pointer">üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (‚ñ∂)</div>`;
                    
                    box.innerHTML += `
                        <div class="bubble ${isMe?'mine':'theirs'}">
                            ${!isMe ? `<small style="font-weight:bold;color:var(--blue)">${d.u}</small>` : ''}
                            ${body}
                            <div class="timestamp">${d.t}</div>
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        // –†–ê–ë–û–¢–ê –° –ì–ê–õ–ï–†–ï–ï–ô
        function handleImage(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => sendText(null, e.target.result);
                reader.readAsDataURL(input.files[0]);
            }
        }

        // –†–ê–ë–û–¢–ê –° –ì–°
        async function recStart() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                recorder = new MediaRecorder(stream);
                audioChunks = [];
                document.getElementById('mic-btn').classList.add('rec-now');
                recorder.ondataavailable = e => audioChunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    const r = new FileReader();
                    r.readAsDataURL(blob);
                    r.onloadend = () => sendText(r.result);
                };
                recorder.start();
            } catch(e) { alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!"); }
        }

        function recStop() {
            if(recorder) {
                recorder.stop();
                document.getElementById('mic-btn').classList.remove('rec-now');
            }
        }

        // --- –ü–†–û–ß–ï–ï ---
        function toggleProfile() { document.getElementById('profile-win').classList.toggle('active'); }

        function postStory(url) {
            db.ref('stories').push({ u: myData.nick, img: url, ts: Date.now() });
        }

        function addMyStory() {
            const url = prompt("–í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏:");
            if(url) postStory(url);
        }

        function loadStories() {
            db.ref('stories').on('value', s => {
                const f = document.getElementById('stories-feed'); f.innerHTML = "";
                s.forEach(c => {
                    f.innerHTML += `<div class="st-ring"><div class="st-img"><img src="${c.val().img}"></div></div>`;
                });
            });
        }

        function getPremium() {
            alert("–ü—Ä–µ–º–∏—É–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! (–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º)");
            myData.prem = true;
            localStorage.setItem('sm_data', JSON.stringify(myData));
            location.reload();
        }

        document.getElementById('msg-input').onkeydown = e => { if(e.key==='Enter') sendText(); };
    </script>
</body>
</html> 
