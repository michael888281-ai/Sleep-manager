<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sleep Messenger</title>

<style>

/* =======================
   TELEGRAM PRO UI
======================= */

*{margin:0;padding:0;box-sizing:border-box;font-family:Arial}

body{
height:100vh;
display:flex;
background:#0e1621;
color:white;
overflow:hidden;
}

/* LOGIN */

#login{
margin:auto;
background:#17212b;
padding:30px;
border-radius:12px;
width:320px;
text-align:center;
}

input{
width:100%;
padding:10px;
margin-top:10px;
border:none;
border-radius:8px;
}

button{
margin-top:10px;
padding:10px;
border:none;
border-radius:8px;
background:#2AABEE;
color:white;
cursor:pointer;
}

/* APP */

#app{
display:none;
width:100%;
height:100%;
}

/* SIDEBAR */

.sidebar{
width:320px;
background:#17212b;
display:flex;
flex-direction:column;
}

.dialog{
padding:12px;
border-bottom:1px solid #0e1621;
cursor:pointer;
}

.dialog:hover{
background:#1f2c3a;
}

.online{
color:#4ade80;
font-size:12px;
}

/* CHAT */

.chat{
flex:1;
display:flex;
flex-direction:column;
}

.header{
padding:15px;
background:#17212b;
}

.messages{
flex:1;
overflow-y:auto;
padding:15px;
}

.message{
background:#182533;
padding:10px;
margin:6px 0;
border-radius:10px;
max-width:65%;
}

.me{
background:#2AABEE;
margin-left:auto;
}

.typing{
font-size:12px;
opacity:.7;
padding:5px;
}

.inputBar{
display:flex;
gap:5px;
padding:10px;
background:#17212b;
}

img{
max-width:200px;
border-radius:10px;
margin-top:5px;
}

audio,video{
width:200px;
margin-top:5px;
border-radius:8px;
}

</style>
</head>

<body>

<!-- LOGIN -->

<div id="login">
<h2>Sleep Messenger</h2>
<input id="name" placeholder="–ò–º—è">
<input id="username" placeholder="@username">
<button onclick="start()">–í–æ–π—Ç–∏</button>
</div>

<!-- APP -->

<div id="app">

<div class="sidebar">
<input id="search" placeholder="–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
<button onclick="findUser()">–ù–∞–π—Ç–∏</button>

<div id="dialogs"></div>
</div>

<div class="chat">

<div id="chatHeader" class="header">–ß–∞—Ç</div>

<div id="messages" class="messages"></div>

<div id="typing" class="typing"></div>

<div class="inputBar">
<input id="text" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
<input type="file" id="photo" hidden>
<button onclick="sendText()">‚û§</button>
<button onclick="photo.click()">üñº</button>
<button onclick="voice()">üé§</button>
<button onclick="videoMsg()">üìπ</button>
</div>

</div>
</div>

<script type="module">

/* ================= FIREBASE ================= */

import {initializeApp}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
getDatabase,ref,set,get,push,onChildAdded,onValue
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

import {
getStorage,ref as sRef,uploadBytes,getDownloadURL
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

import {
getAuth,signInAnonymously
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";


const firebaseConfig={
apiKey:"AIzaSyDzCviqV3rCSLZL-K8h7n6j7aLGkZEmybM",
authDomain:"sleep-menager.firebaseapp.com",
databaseURL:"https://sleep-menager-default-rtdb.firebaseio.com",
projectId:"sleep-menager",
storageBucket:"sleep-menager.firebasestorage.app",
messagingSenderId:"3927631074",
appId:"1:3927631074:web:a3a604c7147e31a900eabb"
};

const appFirebase=initializeApp(firebaseConfig);
const db=getDatabase(appFirebase);
const storage=getStorage(appFirebase);
const auth=getAuth(appFirebase);

/* ================= STATE ================= */

let user;
let chatId=null;

/* ================= LOGIN ================= */

window.start=async()=>{

await signInAnonymously(auth);

user={
name:name.value,
username:username.value
};

await set(ref(db,"users/"+user.username),{
...user,
online:true
});

login.style.display="none";
app.style.display="flex";

loadDialogs();
};

/* ONLINE STATUS */

window.addEventListener("beforeunload",()=>{
set(ref(db,"users/"+user.username+"/online"),false);
});

/* ================= USER SEARCH ================= */

window.findUser=async()=>{

const uname=search.value;
const snap=await get(ref(db,"users/"+uname));

if(!snap.exists())return alert("–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");

openChat(uname);
};

/* ================= OPEN CHAT ================= */

function openChat(other){

chatId=[user.username,other].sort().join("_");

chatHeader.innerText=other;
messages.innerHTML="";

listenMessages();
listenTyping(other);
}

/* ================= LOAD MESSAGES ================= */

function listenMessages(){

onChildAdded(ref(db,"chats/"+chatId+"/messages"),snap=>{
renderMessage(snap.val(),snap.key);
});
}

/* ================= RENDER ================= */

function renderMessage(msg,key){

const div=document.createElement("div");
div.className="message";

if(msg.username===user.username)
div.classList.add("me");

if(msg.type==="text")
div.innerHTML=msg.text;

if(msg.type==="image")
div.innerHTML=`<img src="${msg.url}">`;

if(msg.type==="voice")
div.innerHTML=`<audio controls src="${msg.url}"></audio>`;

if(msg.type==="video")
div.innerHTML=`<video controls src="${msg.url}"></video>`;

div.onclick=()=>{
push(ref(db,"reactions/"+chatId+"/"+key),{
emoji:"‚ù§Ô∏è"
});
};

messages.appendChild(div);
messages.scrollTop=messages.scrollHeight;
}

/* ================= TYPING ================= */

text.oninput=()=>{
set(ref(db,"typing/"+chatId+"/"+user.username),true);

setTimeout(()=>{
set(ref(db,"typing/"+chatId+"/"+user.username),false);
},1000);
};

function listenTyping(other){

onValue(ref(db,"typing/"+chatId+"/"+other),snap=>{
typing.innerText=snap.val()?"–ø–µ—á–∞—Ç–∞–µ—Ç...":"";
});
}

/* ================= SEND TEXT ================= */

window.sendText=()=>{
if(!chatId)return;

push(ref(db,"chats/"+chatId+"/messages"),{
type:"text",
username:user.username,
text:text.value
});

text.value="";
};

/* ================= PHOTO ================= */

photo.onchange=async()=>{

const file=photo.files[0];
const refFile=sRef(storage,"img/"+Date.now());

await uploadBytes(refFile,file);
const url=await getDownloadURL(refFile);

push(ref(db,"chats/"+chatId+"/messages"),{
type:"image",
username:user.username,
url:url
});
};

/* ================= VOICE ================= */

let recorder,chunks=[];

window.voice=async()=>{
const stream=await navigator.mediaDevices.getUserMedia({audio:true});
recorder=new MediaRecorder(stream);

chunks=[];
recorder.ondataavailable=e=>chunks.push(e.data);
recorder.onstop=async()=>{
const blob=new Blob(chunks);
const r=sRef(storage,"voice/"+Date.now());
await uploadBytes(r,blob);
const url=await getDownloadURL(r);

push(ref(db,"chats/"+chatId+"/messages"),{
type:"voice",
username:user.username,
url
});
};

recorder.start();
setTimeout(()=>recorder.stop(),4000);
};

/* ================= VIDEO ================= */

window.videoMsg=async()=>{
const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
recorder=new MediaRecorder(stream);

chunks=[];
recorder.ondataavailable=e=>chunks.push(e.data);
recorder.onstop=async()=>{
const blob=new Blob(chunks);
const r=sRef(storage,"video/"+Date.now());
await uploadBytes(r,blob);
const url=await getDownloadURL(r);

push(ref(db,"chats/"+chatId+"/messages"),{
type:"video",
username:user.username,
url
});
};

recorder.start();
setTimeout(()=>recorder.stop(),4000);
};

</script>
</body>
</html>
